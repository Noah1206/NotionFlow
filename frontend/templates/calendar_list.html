{% extends "base_dashboard.html" %}

{% block body_class %}calendar-list-page{% endblock %}

{% block title %}ìº˜ë¦°ë” ëª©ë¡ - NotionFlow{% endblock %}

{% block description %}í•˜ë‚˜ì˜ í†µí•© ë·°ì—ì„œ ìº˜ë¦°ë”ì™€ ì´ë²¤íŠ¸ë¥¼ ê´€ë¦¬í•˜ì„¸ìš”. ê°œì¸ ë° ê³µìœ  ìº˜ë¦°ë”ë¥¼ ìƒì„±, ì¡°ì§í™”, ë™ê¸°í™”í•˜ì„¸ìš”.{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/calendar-list.css') }}">
{% endblock %}

{% block content %}
<div class="calendar-container-refined">
    <!-- Minimal Header -->
    <div class="calendar-header-refined">
        <div class="header-left">
            <h1 class="page-title">ìº˜ë¦°ë”</h1>
            <p class="page-subtitle">ì¼ì •ê³¼ ì´ë²¤íŠ¸ë¥¼ ê´€ë¦¬í•˜ì„¸ìš”</p>
        </div>
        <div class="header-actions">
            <button class="btn-deselect-all" id="deselectAllBtn" onclick="deselectAllCalendars()"
                style="display: none;">
                <svg class="btn-icon" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
                <span>ì„ íƒ í•´ì œ</span>
            </button>
            <button class="btn-delete-selected" id="deleteSelectedBtn" onclick="deleteSelectedCalendars()"
                style="display: none;">
                <svg class="btn-icon" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
                <span>ì„ íƒ ì‚­ì œ</span>
            </button>
            <button class="btn-new-calendar" onclick="createNewCalendar()">
                <svg class="btn-icon" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                <span>ìƒˆë¡œ ë§Œë“¤ê¸°</span>
            </button>
            <div class="view-toggle">
                <button class="view-btn active" data-view="grid">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <rect x="3" y="3" width="7" height="7" />
                        <rect x="14" y="3" width="7" height="7" />
                        <rect x="14" y="14" width="7" height="7" />
                        <rect x="3" y="14" width="7" height="7" />
                    </svg>
                </button>
                <button class="view-btn" data-view="list">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 6h16M4 10h16M4 14h16M4 18h16" />
                    </svg>
                </button>
            </div>
        </div>
    </div>


    <!-- Calendar Grid -->
    <div class="calendar-grid-refined" id="calendar-grid">
        <!-- All Calendars Section (Combined) -->
        <div class="calendars-container-refined">
            {% set all_calendars = personal_calendars + shared_calendars %}
            {% if all_calendars %}
            {% for calendar in all_calendars %}
            <div class="calendar-card-refined {% if calendar in shared_calendars %}shared-calendar-refined{% endif %}"
                data-calendar="{{ calendar.id }}" onclick="openCalendar('{{ calendar.id }}')">
                <div class="card-header-refined">
                    <div class="calendar-identity">
                        <div class="calendar-color-refined" style="background: {{ calendar.color }};"></div>
                        <div class="calendar-info-refined">
                            <h3 class="calendar-name-refined">
                                {{ calendar.name }}
                                {% if calendar in shared_calendars or calendar.get('shared_with_count', 0) > 0 or
                                calendar.get('is_shared', False) %}
                                <span class="shared-badge"
                                    style="display: inline-flex; align-items: center; gap: 4px; margin-left: 8px; padding: 2px 8px; background: #ede9fe; color: #7c3aed; border-radius: 12px; font-size: 11px; font-weight: 500;">
                                    <svg width="10" height="10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                                    </svg>
                                    ê³µìœ ë¨
                                </span>
                                {% endif %}
                            </h3>
                            <p class="calendar-meta">
                                {{ calendar.event_count }}ê°œ ì´ë²¤íŠ¸
                                {% if calendar in shared_calendars or calendar.get('shared_with_count', 0) > 0 or
                                calendar.get('is_shared', False) %}
                                â€¢ {{ calendar.shared_with_count }}ëª…ê³¼ ê³µìœ  ì¤‘
                                {% else %}
                                â€¢ {{ calendar.last_sync_display }}
                                {% endif %}
                            </p>
                        </div>
                    </div>
                    <div class="card-actions-hover">
                        <button class="btn-delete-calendar"
                            onclick="event.stopPropagation(); confirmDeleteCalendar('{{ calendar.id }}', '{{ calendar.name }}');"
                            title="ì‚­ì œ">
                            <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                        <label class="calendar-checkbox-container" onclick="event.stopPropagation()">
                            <input type="checkbox" class="calendar-select-checkbox" value="{{ calendar.id }}"
                                onchange="toggleCalendarSelection('{{ calendar.id }}')">
                            <span class="calendar-checkbox-checkmark"></span>
                        </label>
                    </div>
                </div>
                <div
                    class="sync-indicator-refined {{ 'active' if calendar.sync_status == 'synced' else ('syncing' if calendar.sync_status == 'syncing' else '') }}">
                    {% if calendar.sync_status == 'synced' %}
                    <svg class="sync-icon" width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                    <span>ë™ê¸°í™”ë¨</span>
                    {% elif calendar.sync_status == 'syncing' %}
                    <svg class="sync-icon rotating" width="12" height="12" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                    <span>ë™ê¸°í™” ì¤‘</span>
                    {% else %}
                    <svg class="sync-icon" width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728L5.636 5.636m12.728 12.728L18.364 5.636M5.636 18.364l12.728-12.728" />
                    </svg>
                    <span>ë¹„í™œì„±</span>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
            {% else %}
            <!-- No calendars message -->
            <div class="new-calendar-card-refined" onclick="createNewCalendar()" style="grid-column: span 2;">
                <div class="new-calendar-content-refined">
                    <div class="new-calendar-icon-refined">
                        <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                d="M12 4v16m8-8H4" />
                        </svg>
                    </div>
                    <h3 class="new-calendar-title-refined">ì²« ë²ˆì§¸ ìº˜ë¦°ë” ë§Œë“¤ê¸°</h3>
                    <p class="new-calendar-description-refined">ì´ë²¤íŠ¸ ì¡°ì§í™”ë¥¼ ì‹œì‘í•˜ì„¸ìš”</p>
                </div>
            </div>
            {% endif %}

            <!-- Create New Calendar Card -->
            <div class="new-calendar-card-refined" onclick="createNewCalendar()">
                <div class="new-calendar-content-refined">
                    <div class="new-calendar-icon-refined">
                        <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                d="M12 4v16m8-8H4" />
                        </svg>
                    </div>
                    <h3 class="new-calendar-title-refined">ìº˜ë¦°ë” ë§Œë“¤ê¸°</h3>
                    <p class="new-calendar-description-refined">ì´ë²¤íŠ¸ ì¡°ì§í™”ë¥¼ ì‹œì‘í•˜ì„¸ìš”</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ìº˜ë¦°ë” ìƒì„± ëª¨ë‹¬ -->
<div class="calendar-modal-overlay" id="calendar-create-modal" style="display: none;">
    <div class="calendar-modal">
        <div class="modal-header">
            <h2 class="modal-title">ìƒˆ ìº˜ë¦°ë” ë§Œë“¤ê¸°</h2>
            <button class="modal-close-btn" onclick="closeCreateModal()">
                <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>

        <div class="modal-body">
            <!-- ìº˜ë¦°ë” ì´ë¦„ -->
            <div class="form-group">
                <label class="form-label" for="calendar-name">ìº˜ë¦°ë” ì´ë¦„</label>
                <input type="text" id="calendar-name" class="form-input" placeholder="ì˜ˆ: ì—…ë¬´ ì¼ì •, ê°œì¸ ìŠ¤ì¼€ì¤„" value="ë‚´ ìƒˆ ìº˜ë¦°ë”">
            </div>


            <!-- ë¯¸ë””ì–´ íŒŒì¼ ì—…ë¡œë“œ (ì„ íƒì‚¬í•­) -->
            <div class="form-group">
                <label class="form-label">ë¯¸ë””ì–´ íŒŒì¼ (ì„ íƒì‚¬í•­)</label>
                <div class="file-upload-area" id="file-upload-area">
                    <div class="file-upload-placeholder" id="file-upload-placeholder">
                        <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M7 4V2a1 1 0 011-1h8a1 1 0 011 1v2m-5 12l-3-3m0 0l3-3m-3 3h12M5 12v8a2 2 0 002 2h10a2 2 0 002-2v-8" />
                        </svg>
                        <p>MP3, MP4, MOV íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ</p>
                        <span class="file-size-limit">ìµœëŒ€ 50MB</span>
                    </div>
                    <div class="file-upload-preview" id="file-upload-preview" style="display: none;">
                        <div class="file-info">
                            <div class="file-icon">
                                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" />
                                </svg>
                            </div>
                            <div class="file-details">
                                <span class="file-name" id="file-name"></span>
                                <span class="file-size" id="file-size"></span>
                            </div>
                        </div>
                        <button type="button" class="file-remove-btn" onclick="removeFile()">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    <input type="file" id="file-input" accept=".mp3,.mp4,.mov,.avi,.wmv,.wav,.m4a"
                        style="display: none;">
                </div>
            </div>

            <!-- êµ¬ë¶„ì„  ë˜ëŠ” "ë˜ëŠ”" í…ìŠ¤íŠ¸ -->
            <div class="form-divider">
                <span class="divider-text">ë˜ëŠ”</span>
            </div>

            <!-- YouTube URL ì…ë ¥ (í•„ìˆ˜) -->
            <div class="form-group">
                <label class="form-label" for="youtube-url">YouTube URL *</label>
                <div class="youtube-input-container">
                    <input type="url" id="youtube-url" class="form-input youtube-input"
                        placeholder="https://www.youtube.com/watch?v=... ë˜ëŠ” https://youtu.be/..."
                        onchange="validateYouTubeUrl(this)" onpaste="handleYouTubePaste(event)" required>
                    <div class="youtube-status" id="youtube-status" style="display: none;">
                        <div class="youtube-loading" style="display: none;">
                            <div class="spinner"></div>
                            <span>ë¹„ë””ì˜¤ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘...</span>
                        </div>
                        <div class="youtube-preview" id="youtube-preview" style="display: none;">
                            <div class="youtube-thumbnail">
                                <img id="youtube-thumbnail" src="" alt="YouTube ì¸ë„¤ì¼">
                                <div class="youtube-duration" id="youtube-duration"></div>
                            </div>
                            <div class="youtube-info">
                                <h4 class="youtube-title" id="youtube-title"></h4>
                                <p class="youtube-channel" id="youtube-channel"></p>
                                <div class="youtube-stats">
                                    <span class="youtube-views" id="youtube-views"></span>
                                    <span class="youtube-publish-date" id="youtube-publish-date"></span>
                                </div>
                            </div>
                            <button type="button" class="youtube-remove-btn" onclick="clearYouTube()">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                        <div class="youtube-error" id="youtube-error" style="display: none;">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <span id="youtube-error-text">ìœ íš¨í•˜ì§€ ì•Šì€ YouTube URLì…ë‹ˆë‹¤</span>
                        </div>
                    </div>
                </div>
                <small class="form-help">YouTube ë¹„ë””ì˜¤ë¥¼ ì¶”ê°€í•˜ë©´ ì˜¤ë””ì˜¤ë¡œ ì¬ìƒë©ë‹ˆë‹¤.</small>
            </div>
        </div>

        <div class="modal-footer">
            <button class="btn-secondary" onclick="closeCreateModal()">ì·¨ì†Œ</button>
            <button class="btn-primary" onclick="createCalendarFromModal()">
                <span class="create-text">ìº˜ë¦°ë” ë§Œë“¤ê¸°</span>
                <div class="create-loader" style="display: none;">
                    <div class="loader-spinner"></div>
                </div>
            </button>
        </div>
    </div>
</div>

<style>
    /* ìº˜ë¦°ë” ìƒì„± ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
    .calendar-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 999999 !important;
        backdrop-filter: blur(4px);
    }

    .calendar-modal {
        background: #ffffff;
        border-radius: 16px;
        max-width: 500px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        position: relative;
        z-index: 999999 !important;
    }

    .modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 24px 32px;
        border-bottom: 1px solid #f0f0f0;
    }

    .modal-title {
        font-size: 20px;
        font-weight: 600;
        color: #000000;
        margin: 0;
    }

    .modal-close-btn {
        background: none;
        border: none;
        cursor: pointer;
        padding: 4px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #6b7280;
        transition: all 0.2s ease;
    }

    .modal-close-btn:hover {
        background: #f3f4f6;
        color: #374151;
    }

    .modal-body {
        padding: 32px;
    }

    .form-group {
        margin-bottom: 24px;
    }

    .form-label {
        display: block;
        font-size: 14px;
        font-weight: 600;
        color: #374151;
        margin-bottom: 8px;
    }

    .form-input {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 15px;
        transition: all 0.2s ease;
        background: #ffffff;
    }

    .form-input:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .form-select {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 15px;
        background: #ffffff;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .form-select:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    /* ìº˜ë¦°ë” ìœ í˜• ì„ íƒ */
    .calendar-type-selector {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
    }

    .type-option {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 16px;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .type-option:hover {
        border-color: #d1d5db;
        background: #f9fafb;
    }

    .type-option.active {
        border-color: #3b82f6;
        background: #eff6ff;
    }

    .type-icon {
        flex-shrink: 0;
        width: 40px;
        height: 40px;
        background: #f3f4f6;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #6b7280;
    }

    .type-option.active .type-icon {
        background: #3b82f6;
        color: white;
    }

    .type-content h3 {
        font-size: 14px;
        font-weight: 600;
        color: #374151;
        margin: 0 0 4px 0;
    }

    .type-content p {
        font-size: 12px;
        color: #6b7280;
        margin: 0;
    }


    .modal-footer {
        display: flex;
        gap: 12px;
        padding: 24px 32px;
        border-top: 1px solid #f0f0f0;
        justify-content: flex-end;
    }

    .btn-secondary {
        padding: 12px 24px;
        border: 2px solid #e5e7eb;
        background: #ffffff;
        color: #374151;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .btn-secondary:hover {
        background: #f9fafb;
        border-color: #d1d5db;
    }

    .btn-primary {
        padding: 12px 24px;
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
        min-width: 140px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    .btn-primary:hover {
        background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .btn-primary:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    .create-loader {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: inherit;
        border-radius: inherit;
    }

    .loader-spinner {
        width: 16px;
        height: 16px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-top: 2px solid white;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    /* íŒŒì¼ ì—…ë¡œë“œ ì˜ì—­ */
    .file-upload-area {
        border: 2px dashed #e5e7eb;
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
        background: #fafbfc;
    }

    .file-upload-area:hover {
        border-color: #3b82f6;
        background: #f0f7ff;
    }

    .file-upload-area.dragover {
        border-color: #3b82f6;
        background: #eff6ff;
        transform: scale(1.02);
    }

    .file-upload-placeholder {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        color: #6b7280;
    }

    .file-upload-placeholder svg {
        color: #9ca3af;
    }

    .file-upload-placeholder p {
        margin: 0;
        font-size: 14px;
        font-weight: 500;
    }

    .file-size-limit {
        font-size: 12px;
        color: #9ca3af;
    }

    .file-upload-preview {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px;
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
    }

    .file-info {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .file-icon {
        width: 40px;
        height: 40px;
        background: #3b82f6;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
    }

    .file-details {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
    }

    .file-name {
        font-size: 14px;
        font-weight: 500;
        color: #374151;
    }

    .file-size {
        font-size: 12px;
        color: #6b7280;
    }

    .file-remove-btn {
        background: #fef2f2;
        border: 1px solid #fecaca;
        color: #dc2626;
        border-radius: 6px;
        padding: 6px;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .file-remove-btn:hover {
        background: #fee2e2;
        border-color: #fca5a5;
    }

    /* YouTube URL ì…ë ¥ í•„ë“œ ìŠ¤íƒ€ì¼ */
    .form-divider {
        display: flex;
        align-items: center;
        margin: 24px 0;
        position: relative;
    }

    .form-divider::before {
        content: '';
        flex: 1;
        height: 1px;
        background: #e5e7eb;
    }

    .form-divider::after {
        content: '';
        flex: 1;
        height: 1px;
        background: #e5e7eb;
    }

    .divider-text {
        padding: 0 16px;
        font-size: 14px;
        color: #6b7280;
        background: white;
    }

    .youtube-input-container {
        position: relative;
    }

    .youtube-input {
        padding-right: 40px;
    }

    .youtube-status {
        margin-top: 12px;
    }

    .youtube-loading {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 12px;
        background: #f8fafc;
        border-radius: 8px;
        color: #6b7280;
        font-size: 14px;
    }

    .youtube-loading .spinner {
        width: 16px;
        height: 16px;
        border: 2px solid #e5e7eb;
        border-top: 2px solid #3b82f6;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    .youtube-preview {
        display: flex;
        gap: 12px;
        padding: 12px;
        background: #f8fafc;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        position: relative;
    }

    .youtube-thumbnail {
        position: relative;
        width: 120px;
        height: 68px;
        border-radius: 6px;
        overflow: hidden;
        flex-shrink: 0;
    }

    .youtube-thumbnail img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .youtube-duration {
        position: absolute;
        bottom: 4px;
        right: 4px;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 500;
    }

    .youtube-info {
        flex: 1;
        min-width: 0;
    }

    .youtube-title {
        margin: 0 0 6px 0;
        font-size: 14px;
        font-weight: 600;
        color: #111827;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        line-height: 1.4;
    }

    .youtube-channel {
        margin: 0 0 8px 0;
        font-size: 13px;
        color: #6b7280;
    }

    .youtube-stats {
        display: flex;
        gap: 12px;
        font-size: 12px;
        color: #9ca3af;
    }

    .youtube-views::before {
        content: 'ğŸ‘ ';
    }

    .youtube-publish-date::before {
        content: 'ğŸ“… ';
    }

    .youtube-remove-btn {
        position: absolute;
        top: 8px;
        right: 8px;
        background: rgba(255, 255, 255, 0.9);
        border: none;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: #6b7280;
        transition: all 0.2s ease;
    }

    .youtube-remove-btn:hover {
        background: #fee2e2;
        color: #dc2626;
    }

    .youtube-error {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 12px;
        background: #fef2f2;
        border: 1px solid #fecaca;
        border-radius: 8px;
        color: #dc2626;
        font-size: 14px;
    }

    .form-help {
        display: block;
        margin-top: 6px;
        font-size: 12px;
        color: #6b7280;
    }

    /* Make calendar cards clickable */
    .calendar-card-refined {
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .calendar-card-refined:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    /* New calendar card styles to match create calendar card */
    .new-calendar-card-refined {
        min-height: 120px;
        /* Match existing calendar cards */
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px dashed #e5e7eb;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        background: #fafbfc;
    }

    .new-calendar-card-refined:hover {
        border-color: #3b82f6;
        background: #f0f7ff;
        transform: translateY(-2px);
    }

    .new-calendar-content-refined {
        text-align: center;
        padding: 1rem;
    }

    .new-calendar-icon-refined {
        width: 40px;
        height: 40px;
        background: #f3f4f6;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 12px;
        color: #9ca3af;
        transition: all 0.2s ease;
    }

    .new-calendar-card-refined:hover .new-calendar-icon-refined {
        background: #3b82f6;
        color: white;
    }

    .new-calendar-title-refined {
        font-size: 14px;
        font-weight: 600;
        color: #374151;
        margin: 0 0 4px 0;
    }

    .new-calendar-description-refined {
        font-size: 12px;
        color: #9ca3af;
        margin: 0;
    }

    /* Calendar card consistent sizing */
    .calendar-card-refined,
    .new-calendar-card-refined {
        min-height: 120px;
        margin-bottom: 12px;
    }

    .calendars-container-refined {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 16px;
        margin-top: 16px;
    }

    /* Calendar card base styles */
    .calendar-card-refined {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 16px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        position: relative;
    }

    .card-header-refined {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
    }

    .calendar-identity {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        flex: 1;
    }

    .calendar-color-refined {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        flex-shrink: 0;
        margin-top: 4px;
    }

    .calendar-info-refined h3 {
        font-size: 16px;
        font-weight: 600;
        color: #1f2937;
        margin: 0 0 4px 0;
        line-height: 1.3;
    }

    .calendar-meta {
        font-size: 13px;
        color: #6b7280;
        margin: 0;
        line-height: 1.4;
    }

    .card-actions-hover {
        display: flex;
        align-items: center;
        gap: 8px;
        opacity: 0;
        transition: opacity 0.2s ease;
    }

    .calendar-card-refined:hover .card-actions-hover {
        opacity: 1;
    }

    .card-menu-btn {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        padding: 4px;
        cursor: pointer;
        color: #6b7280;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
    }

    .card-menu-btn:hover {
        background: #f3f4f6;
        color: #374151;
    }

    /* ì²´í¬ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
    .calendar-checkbox-container {
        position: relative;
        display: inline-block;
        width: 20px;
        height: 20px;
        cursor: pointer;
    }

    .calendar-select-checkbox {
        position: absolute;
        opacity: 0;
        cursor: pointer;
        height: 0;
        width: 0;
    }

    .calendar-checkbox-checkmark {
        position: absolute;
        top: 0;
        left: 0;
        height: 20px;
        width: 20px;
        background-color: #f9fafb;
        border: 2px solid #e5e7eb;
        border-radius: 4px;
        transition: all 0.2s ease;
    }

    .calendar-checkbox-container:hover .calendar-checkbox-checkmark {
        background-color: #f3f4f6;
        border-color: #d1d5db;
    }

    .calendar-select-checkbox:checked~.calendar-checkbox-checkmark {
        background-color: #6366f1;
        border-color: #6366f1;
    }

    .calendar-checkbox-checkmark:after {
        content: "";
        position: absolute;
        display: none;
        left: 6px;
        top: 2px;
        width: 5px;
        height: 10px;
        border: solid white;
        border-width: 0 2px 2px 0;
        transform: rotate(45deg);
    }

    .calendar-select-checkbox:checked~.calendar-checkbox-checkmark:after {
        display: block;
    }

    gap: 4px;
    }

    .sync-indicator-refined {
        margin-top: 12px;
        padding: 6px 8px;
        background: #f9fafb;
        border-radius: 6px;
        font-size: 11px;
        display: flex;
        align-items: center;
        gap: 4px;
        color: #6b7280;
    }

    .sync-indicator-refined.active {
        background: #f0f9ff;
        color: #0369a1;
    }

    .sync-indicator-refined .sync-icon {
        flex-shrink: 0;
    }

    .shared-indicator {
        display: flex;
        align-items: center;
        justify-content: center;
        color: #7c3aed;
    }

    /* Section styles */
    .calendar-section-refined {
        margin-bottom: 32px;
    }

    .section-header-refined {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 16px;
    }

    .section-title-refined {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 18px;
        font-weight: 600;
        color: #1f2937;
        margin: 0;
    }

    .section-icon {
        color: #6b7280;
    }

    .section-count-refined {
        background: #f3f4f6;
        color: #6b7280;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
    }

    /* Delete Calendar Button */
    .btn-delete-calendar {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 28px;
        height: 28px;
        background: rgba(239, 68, 68, 0.1);
        border: none;
        border-radius: 6px;
        color: #ef4444;
        cursor: pointer;
        transition: all 0.2s ease;
        opacity: 0;
        margin-right: 4px;
    }

    .btn-delete-calendar:hover {
        background: rgba(239, 68, 68, 0.2);
        color: #dc2626;
        transform: scale(1.05);
    }

    .calendar-card-refined:hover .btn-delete-calendar {
        opacity: 1;
    }

    /* Delete Modal */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        backdrop-filter: blur(4px);
    }

    .delete-modal {
        background: white;
        border-radius: 12px;
        padding: 0;
        max-width: 420px;
        width: 90%;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        animation: modalSlideIn 0.3s ease-out;
    }

    @keyframes modalSlideIn {
        from {
            opacity: 0;
            transform: scale(0.95) translateY(-20px);
        }

        to {
            opacity: 1;
            transform: scale(1) translateY(0);
        }
    }

    .delete-modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 20px 24px 16px;
        border-bottom: 1px solid #f1f5f9;
    }

    .delete-modal-title {
        font-size: 18px;
        font-weight: 600;
        color: #1e293b;
        margin: 0;
    }

    .modal-close-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        background: transparent;
        border: none;
        border-radius: 6px;
        color: #64748b;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .modal-close-btn:hover {
        background: #f1f5f9;
        color: #1e293b;
    }

    .delete-modal-body {
        padding: 24px;
        text-align: center;
    }

    .delete-warning-icon {
        margin-bottom: 16px;
    }

    .delete-warning-icon svg {
        color: #f59e0b;
    }

    .delete-modal-content {
        margin-bottom: 24px;
    }

    .delete-warning-text {
        font-size: 16px;
        color: #1e293b;
        margin: 0 0 12px 0;
    }

    .delete-description {
        font-size: 14px;
        color: #64748b;
        line-height: 1.5;
        margin: 0;
    }

    .delete-modal-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        padding: 0 24px 24px;
    }

    .btn-cancel,
    .btn-delete-confirm {
        padding: 10px 20px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .btn-cancel {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        color: #64748b;
    }

    .btn-cancel:hover {
        background: #f1f5f9;
        color: #475569;
    }

    .btn-delete-confirm {
        background: #ef4444;
        border: none;
        color: white;
    }

    .btn-delete-confirm:hover {
        background: #dc2626;
    }

    .btn-delete-confirm:disabled {
        background: #94a3b8;
        cursor: not-allowed;
    }

    /* Bulk Action Buttons */
    .btn-deselect-all {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 16px;
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        color: #64748b;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        margin-right: 8px;
    }

    .btn-deselect-all:hover {
        background: #f1f5f9;
        border-color: #cbd5e1;
        color: #475569;
        transform: translateY(-1px);
    }

    .btn-delete-selected {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 16px;
        background: #fef2f2;
        border: 1px solid #fecaca;
        border-radius: 8px;
        color: #dc2626;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        margin-right: 8px;
    }

    .btn-delete-selected:hover {
        background: #fee2e2;
        border-color: #fca5a5;
        color: #b91c1c;
        transform: translateY(-1px);
    }

    .btn-delete-selected:disabled,
    .btn-deselect-all:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }
</style>

<!-- Delete Confirmation Modal -->
<div class="modal-overlay" id="delete-modal-overlay" style="display: none;">
    <div class="delete-modal">
        <div class="delete-modal-header">
            <h3 class="delete-modal-title">ìº˜ë¦°ë” ì‚­ì œ</h3>
            <button class="modal-close-btn" onclick="closeDeleteModal()">
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div class="delete-modal-body">
            <div class="delete-warning-icon">
                <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.464 0L4.35 16.5c-.77.833.192 2.5 1.732 2.5z" />
                </svg>
            </div>
            <div class="delete-modal-content">
                <p class="delete-warning-text">
                    <strong id="calendar-name-to-delete">ìº˜ë¦°ë”</strong>ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?
                </p>
                <p class="delete-description">
                    ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìœ¼ë©°, ìº˜ë¦°ë”ì˜ ëª¨ë“  ì´ë²¤íŠ¸ì™€ ë°ì´í„°ê°€ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œë©ë‹ˆë‹¤.
                </p>
            </div>
        </div>
        <div class="delete-modal-actions">
            <button class="btn-cancel" onclick="closeDeleteModal()">ì·¨ì†Œ</button>
            <button class="btn-delete-confirm" onclick="deleteCalendar()" id="confirm-delete-btn">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
                ì‚­ì œí•˜ê¸°
            </button>
        </div>
    </div>
</div>

<script>
    // Calendar List JavaScript Functions
    function createNewCalendar() {
        // ëª¨ë‹¬ ì—´ê¸°
        document.getElementById('calendar-create-modal').style.display = 'flex';
        document.body.classList.add('modal-open');
    }

    function closeCreateModal() {
        const modal = document.getElementById('calendar-create-modal');
        if (modal) {
            modal.style.display = 'none';
        }
        document.body.classList.remove('modal-open');

        // í¼ ì´ˆê¸°í™” (ì•ˆì „í•˜ê²Œ)
        const nameInput = document.getElementById('calendar-name');
        if (nameInput) {
            nameInput.value = 'ë‚´ ìƒˆ ìº˜ë¦°ë”';
        }

        const activeTypeOption = document.querySelector('.type-option.active');
        if (activeTypeOption) {
            activeTypeOption.classList.remove('active');
        }

        const personalTypeOption = document.querySelector('.type-option[data-type="personal"]');
        if (personalTypeOption) {
            personalTypeOption.classList.add('active');
        }


        // íŒŒì¼ ì—…ë¡œë“œ ì´ˆê¸°í™”
        resetFileUpload();
    }

    let uploadedFile = null;
    let uploadedFileName = null;

    function resetFileUpload() {
        uploadedFile = null;
        uploadedFileName = null;
        document.getElementById('file-input').value = '';
        document.getElementById('file-upload-placeholder').style.display = 'flex';
        document.getElementById('file-upload-preview').style.display = 'none';
    }

    function removeFile() {
        resetFileUpload();
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function handleFileSelect(file) {
        // íŒŒì¼ í¬ê¸° ê²€ì¦ (50MB ì œí•œ)
        const maxSize = 50 * 1024 * 1024; // 50MB
        if (file.size > maxSize) {
            alert('íŒŒì¼ í¬ê¸°ê°€ 50MBë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤. ë” ì‘ì€ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }

        // íŒŒì¼ í˜•ì‹ ê²€ì¦
        const allowedTypes = ['audio/mpeg', 'audio/mp3', 'video/mp4', 'video/quicktime', 'video/x-msvideo', 'audio/wav', 'audio/mp4'];
        const allowedExtensions = ['.mp3', '.mp4', '.mov', '.avi', '.wmv', '.wav', '.m4a'];

        const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
        if (!allowedTypes.includes(file.type) && !allowedExtensions.includes(fileExtension)) {
            alert('ì§€ì›ë˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤. MP3, MP4, MOV, AVI, WMV, WAV, M4A íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
            return;
        }

        uploadedFile = file;
        uploadedFileName = file.name;

        // íŒŒì¼ ì •ë³´ í‘œì‹œ
        document.getElementById('file-name').textContent = file.name;
        document.getElementById('file-size').textContent = formatFileSize(file.size);

        // UI ì—…ë°ì´íŠ¸
        document.getElementById('file-upload-placeholder').style.display = 'none';
        document.getElementById('file-upload-preview').style.display = 'flex';

        // ì•„ì´ì½˜ ë³€ê²½ (ë¹„ë””ì˜¤/ì˜¤ë””ì˜¤ì— ë”°ë¼)
        const fileIcon = document.querySelector('.file-icon svg');
        if (file.type.startsWith('video/') || fileExtension.includes('.mp4') || fileExtension.includes('.mov') || fileExtension.includes('.avi') || fileExtension.includes('.wmv')) {
            fileIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>';
        } else {
            fileIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"/>';
        }
    }

    // YouTube URL ê´€ë ¨ ë³€ìˆ˜
    let youtubeVideoData = null;
    let youtubeValidationTimeout = null;

    // YouTube URL ìœ íš¨ì„± ê²€ì‚¬ í•¨ìˆ˜
    function validateYouTubeUrl(input) {
        const url = input.value.trim();

        if (!url) {
            hideYouTubeStatus();
            return;
        }

        // ë””ë°”ìš´ì‹±ì„ ìœ„í•´ ì´ì „ íƒ€ì„ì•„ì›ƒ ì·¨ì†Œ
        if (youtubeValidationTimeout) {
            clearTimeout(youtubeValidationTimeout);
        }

        youtubeValidationTimeout = setTimeout(() => {
            processYouTubeUrl(url);
        }, 500);
    }

    // YouTube URL ë¶™ì—¬ë„£ê¸° ì²˜ë¦¬
    function handleYouTubePaste(event) {
        setTimeout(() => {
            validateYouTubeUrl(event.target);
        }, 100);
    }

    // YouTube URL ì²˜ë¦¬
    async function processYouTubeUrl(url) {
        const statusElement = document.getElementById('youtube-status');
        const loadingElement = statusElement.querySelector('.youtube-loading');
        const previewElement = document.getElementById('youtube-preview');
        const errorElement = statusElement.querySelector('.youtube-error');

        // ìƒíƒœ ì´ˆê¸°í™”
        hideYouTubeStatus();
        statusElement.style.display = 'block';
        loadingElement.style.display = 'flex';

        try {
            // YouTube URL íŒ¨í„´ ê²€ì‚¬
            if (!isValidYouTubeUrl(url)) {
                throw new Error('ìœ íš¨í•˜ì§€ ì•Šì€ YouTube URLì…ë‹ˆë‹¤');
            }

            // ì„œë²„ì— YouTube ì •ë³´ ìš”ì²­
            const response = await fetch('/api/youtube/info', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ url: url })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'ë¹„ë””ì˜¤ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
            }

            const videoData = await response.json();

            if (!videoData.success) {
                throw new Error(videoData.error || 'ë¹„ë””ì˜¤ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
            }

            // YouTube ë¹„ë””ì˜¤ ë°ì´í„° ì €ì¥
            youtubeVideoData = videoData;

            // ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
            showYouTubePreview(videoData);

        } catch (error) {
            console.error('YouTube URL ì²˜ë¦¬ ì˜¤ë¥˜:', error);
            showYouTubeError(error.message);
        }
    }

    // YouTube URL ìœ íš¨ì„± ê²€ì‚¬ (í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ)
    function isValidYouTubeUrl(url) {
        const youtubeRegex = /^(https?:\/\/)?(www\.)?(youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/|m\.youtube\.com\/watch\?v=)([a-zA-Z0-9_-]{11})/;
        return youtubeRegex.test(url);
    }

    // YouTube ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
    function showYouTubePreview(videoData) {
        const statusElement = document.getElementById('youtube-status');
        const loadingElement = statusElement.querySelector('.youtube-loading');
        const previewElement = document.getElementById('youtube-preview');
        const errorElement = statusElement.querySelector('.youtube-error');

        // ë¡œë”© ìˆ¨ê¸°ê¸°
        loadingElement.style.display = 'none';
        errorElement.style.display = 'none';

        // video_info ê°ì²´ì—ì„œ ë°ì´í„° ì¶”ì¶œ
        const info = videoData.video_info;

        // ë¯¸ë¦¬ë³´ê¸° ë°ì´í„° ì„¤ì •
        document.getElementById('youtube-thumbnail').src = info.thumbnail_url;
        document.getElementById('youtube-title').textContent = info.title;
        document.getElementById('youtube-channel').textContent = info.channel_name;
        document.getElementById('youtube-duration').textContent = info.duration_formatted;

        // ì¡°íšŒìˆ˜ í¬ë§·íŒ…
        const viewCount = parseInt(info.view_count);
        document.getElementById('youtube-views').textContent = formatNumber(viewCount);

        // ê²Œì‹œì¼ í¬ë§·íŒ…
        const publishDate = new Date(info.published_at);
        document.getElementById('youtube-publish-date').textContent = formatDate(publishDate);

        // ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
        previewElement.style.display = 'flex';
    }

    // YouTube ì—ëŸ¬ í‘œì‹œ
    function showYouTubeError(message) {
        const statusElement = document.getElementById('youtube-status');
        const loadingElement = statusElement.querySelector('.youtube-loading');
        const previewElement = document.getElementById('youtube-preview');
        const errorElement = statusElement.querySelector('.youtube-error');
        const errorText = document.getElementById('youtube-error-text');

        // ë¡œë”©ê³¼ ë¯¸ë¦¬ë³´ê¸° ìˆ¨ê¸°ê¸°
        loadingElement.style.display = 'none';
        previewElement.style.display = 'none';

        // ì—ëŸ¬ í‘œì‹œ
        errorText.textContent = message;
        errorElement.style.display = 'flex';

        // YouTube ë°ì´í„° ì´ˆê¸°í™”
        youtubeVideoData = null;
    }

    // YouTube ìƒíƒœ ìˆ¨ê¸°ê¸°
    function hideYouTubeStatus() {
        const statusElement = document.getElementById('youtube-status');
        const loadingElement = statusElement.querySelector('.youtube-loading');
        const previewElement = document.getElementById('youtube-preview');
        const errorElement = statusElement.querySelector('.youtube-error');

        statusElement.style.display = 'none';
        loadingElement.style.display = 'none';
        previewElement.style.display = 'none';
        errorElement.style.display = 'none';
    }

    // YouTube ì •ë³´ ì‚­ì œ
    function clearYouTube() {
        document.getElementById('youtube-url').value = '';
        hideYouTubeStatus();
        youtubeVideoData = null;
    }

    // ìˆ«ì í¬ë§·íŒ… (ì¡°íšŒìˆ˜ ë“±)
    function formatNumber(num) {
        if (num >= 1000000) {
            return (num / 1000000).toFixed(1) + 'M';
        } else if (num >= 1000) {
            return (num / 1000).toFixed(1) + 'K';
        }
        return num.toString();
    }

    // ë‚ ì§œ í¬ë§·íŒ…
    function formatDate(date) {
        const now = new Date();
        const diff = now - date;
        const days = Math.floor(diff / (1000 * 60 * 60 * 24));

        if (days < 1) {
            return 'ì˜¤ëŠ˜';
        } else if (days < 7) {
            return days + 'ì¼ ì „';
        } else if (days < 30) {
            return Math.floor(days / 7) + 'ì£¼ ì „';
        } else if (days < 365) {
            return Math.floor(days / 30) + 'ê°œì›” ì „';
        } else {
            return Math.floor(days / 365) + 'ë…„ ì „';
        }
    }

    async function createCalendarFromModal() {
        console.log('ğŸ” createCalendarFromModal() called');

        const createBtn = document.querySelector('[onclick="createCalendarFromModal()"]');
        if (!createBtn) {
            console.error('âŒ Create button not found');
            return;
        }

        const createText = createBtn.querySelector('.create-text');
        const createLoader = createBtn.querySelector('.create-loader');

        if (!createText || !createLoader) {
            console.error('âŒ Button elements not found');
            return;
        }

        // ë¡œë”© ìƒíƒœ ì‹œì‘
        createBtn.disabled = true;
        createText.style.display = 'none';
        createLoader.style.display = 'flex';

        try {
            // í¼ ë°ì´í„° ìˆ˜ì§‘
            const name = document.getElementById('calendar-name').value.trim();
            const isShared = false; // í•­ìƒ ê°œì¸ ìº˜ë¦°ë”ë¡œ ìƒì„±
            // ìƒ‰ìƒ ëœë¤ ì„ íƒ - ë‹¤ì–‘í•œ ìƒ‰ìƒ íŒ”ë ˆíŠ¸ì—ì„œ ëœë¤ ì„ íƒ
            const colorPalette = [
                '#2563eb', '#3b82f6', '#6366f1', '#8b5cf6', '#a855f7', '#d946ef',
                '#ec4899', '#f43f5e', '#ef4444', '#f97316', '#f59e0b', '#eab308',
                '#84cc16', '#22c55e', '#10b981', '#14b8a6', '#06b6d4', '#0ea5e9'
            ];
            const color = colorPalette[Math.floor(Math.random() * colorPalette.length)];
            const platform = 'custom'; // í•­ìƒ ë…ë¦½ ìº˜ë¦°ë”ë¡œ ì„¤ì •

            console.log('ğŸ” Form data collected:', {
                name: name,
                isShared: isShared,
                color: color,
                platform: platform
            });

            if (!name) {
                alert('ìº˜ë¦°ë” ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            // YouTube URL í•„ìˆ˜ ê²€ì¦
            const youtubeUrl = document.getElementById('youtube-url').value.trim();
            if (!youtubeUrl) {
                alert('YouTube ë§í¬ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            // Validate YouTube URL format
            const youtubePattern = /^(https?:\/\/)?(www\.)?(youtube\.com\/(watch\?v=|embed\/)|youtu\.be\/)[\w-]+/;
            if (!youtubePattern.test(youtubeUrl)) {
                alert('ì˜¬ë°”ë¥¸ YouTube ë§í¬ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.\nì˜ˆì‹œ: https://www.youtube.com/watch?v=...');
                return;
            }

            console.log('ğŸ” Sending request to /api/calendar/create...');

            // Check if there's a media file to upload
            const fileInput = document.getElementById('file-input');
            const hasMediaFile = fileInput && fileInput.files && fileInput.files.length > 0;

            let response;

            if (hasMediaFile) {
                // Use FormData for file upload
                const formData = new FormData();
                formData.append('name', name);
                formData.append('platform', platform);
                formData.append('color', color);
                formData.append('is_shared', isShared);
                formData.append('media_file', fileInput.files[0]);

                console.log('ğŸ“ Uploading media file:', fileInput.files[0].name);

                response = await fetch('/api/calendar/create', {
                    method: 'POST',
                    body: formData
                });
            } else {
                // Use JSON for simple calendar creation
                response = await fetch('/api/calendar/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: name,
                        platform: platform,
                        color: color,
                        is_shared: isShared,
                        youtube_data: youtubeVideoData ? youtubeVideoData.video_info : null
                    })
                });
            }

            console.log('ğŸ” Response status:', response.status);
            const result = await response.json();

            // ë””ë²„ê¹…ì„ ìœ„í•œ ë¡œê·¸
            console.log('ğŸ” API Response:', result);
            console.log('Calendar object:', result.calendar);
            console.log('Calendar ID:', result.calendar ? result.calendar.id : 'undefined');

            if (result.success) {
                console.log('ğŸ” Calendar creation successful!');
                closeCreateModal();

                // ìƒì„±ëœ ìº˜ë¦°ë”ì˜ ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™
                if (result.calendar && result.calendar.id) {
                    console.log('ğŸ” Redirecting to calendar detail:', `/dashboard/calendar/${result.calendar.id}`);

                    // Add a small delay to ensure server state is updated
                    setTimeout(() => {
                        window.location.href = `/dashboard/calendar/${result.calendar.id}`;
                    }, 100);
                } else {
                    // fallback: ìº˜ë¦°ë” IDê°€ ì—†ìœ¼ë©´ ë¦¬ìŠ¤íŠ¸ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
                    console.log('ğŸ” No calendar ID found, reloading page');
                    setTimeout(() => {
                        window.location.reload();
                    }, 100);
                }
            } else {
                console.log('ğŸ” Calendar creation failed:', result.error);
                alert('ìº˜ë¦°ë” ìƒì„± ì˜¤ë¥˜: ' + result.error);
            }
        } catch (error) {
            console.error('Error creating calendar:', error);
            alert('ìº˜ë¦°ë” ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        } finally {
            // ë¡œë”© ìƒíƒœ ì¢…ë£Œ (ì•ˆì „í•˜ê²Œ ì²˜ë¦¬)
            if (createBtn) {
                createBtn.disabled = false;
            }
            if (createText) {
                createText.style.display = 'inline';
            }
            if (createLoader) {
                createLoader.style.display = 'none';
            }
        }
    }

    function importCalendar() {
        console.log('Importing calendar...');
        alert('ìº˜ë¦°ë” ê°€ì ¸ì˜¤ê¸° ê¸°ëŠ¥ì€ ë‹¤ìŒ ì—…ë°ì´íŠ¸ì—ì„œ ì œê³µë  ì˜ˆì •ì…ë‹ˆë‹¤!');
    }

    async function syncAllCalendars() {
        console.log('Syncing all calendars...');

        // Show sync status
        const syncBtn = document.querySelector('[onclick="syncAllCalendars()"]');
        const originalText = syncBtn.innerHTML;
        syncBtn.innerHTML = '<svg class="rotating" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg><span>ë™ê¸°í™” ì¤‘...</span>';

        try {
            // Simulate sync process (replace with actual sync API calls)
            await new Promise(resolve => setTimeout(resolve, 2000));

            syncBtn.innerHTML = '<svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg><span>ë™ê¸°í™” ì™„ë£Œ</span>';

            setTimeout(() => {
                syncBtn.innerHTML = originalText;
            }, 2000);

        } catch (error) {
            console.error('Sync error:', error);
            syncBtn.innerHTML = originalText;
            alert('ë™ê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        }
    }

    function exportCalendars() {
        console.log('Exporting calendars...');
        alert('ë‚´ë³´ë‚´ê¸° ê¸°ëŠ¥ì€ ë‹¤ìŒ ì—…ë°ì´íŠ¸ì—ì„œ ì œê³µë  ì˜ˆì •ì…ë‹ˆë‹¤!');
    }

    function calendarSettings() {
        console.log('Opening calendar settings...');
        alert('ìº˜ë¦°ë” ì„¤ì •ì€ ë‹¤ìŒ ì—…ë°ì´íŠ¸ì—ì„œ ì œê³µë  ì˜ˆì •ì…ë‹ˆë‹¤!');
    }

    function viewAnalytics() {
        console.log('Viewing calendar analytics...');
        alert('ìº˜ë¦°ë” ë¶„ì„ì€ ë‹¤ìŒ ì—…ë°ì´íŠ¸ì—ì„œ ì œê³µë  ì˜ˆì •ì…ë‹ˆë‹¤!');
    }

    // View Switcher
    document.addEventListener('DOMContentLoaded', function () {
        const viewBtns = document.querySelectorAll('.view-btn');
        const calendarGrid = document.getElementById('calendar-grid');

        viewBtns.forEach(btn => {
            btn.addEventListener('click', function () {
                viewBtns.forEach(b => b.classList.remove('active'));
                this.classList.add('active');

                const viewType = this.getAttribute('data-view');
                calendarGrid.className = viewType === 'list' ? 'calendar-grid list-view' : 'calendar-grid';
            });
        });

        // ëª¨ë‹¬ ì¸í„°ë™ì…˜ ì„¤ì •
        setupModalInteractions();
    });

    function setupModalInteractions() {
        // ìº˜ë¦°ë” ìœ í˜• ì„ íƒ
        document.querySelectorAll('.type-option').forEach(option => {
            option.addEventListener('click', function () {
                document.querySelectorAll('.type-option').forEach(opt => opt.classList.remove('active'));
                this.classList.add('active');
            });
        });


        // ëª¨ë‹¬ ì˜¤ë²„ë ˆì´ í´ë¦­ìœ¼ë¡œ ë‹«ê¸°
        const modal = document.getElementById('calendar-create-modal');
        if (modal) {
            modal.addEventListener('click', function (e) {
                if (e.target === this) {
                    closeCreateModal();
                }
            });
        }

        // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                const modal = document.getElementById('calendar-create-modal');
                if (modal && modal.style.display === 'flex') {
                    closeCreateModal();
                }
            }
        });

        // ì—”í„° í‚¤ë¡œ ìº˜ë¦°ë” ìƒì„±
        document.getElementById('calendar-name').addEventListener('keydown', function (e) {
            if (e.key === 'Enter') {
                createCalendarFromModal();
            }
        });

        // íŒŒì¼ ì—…ë¡œë“œ ì´ë²¤íŠ¸ ì„¤ì •
        setupFileUpload();
    }

    function setupFileUpload() {
        const fileUploadArea = document.getElementById('file-upload-area');
        const fileInput = document.getElementById('file-input');

        // íŒŒì¼ ì—…ë¡œë“œ ì˜ì—­ í´ë¦­ ì‹œ íŒŒì¼ ì„ íƒ ë‹¤ì´ì–¼ë¡œê·¸ ì—´ê¸°
        fileUploadArea.addEventListener('click', function (e) {
            if (e.target.closest('.file-remove-btn')) return; // ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì‹œ ì œì™¸
            fileInput.click();
        });

        // íŒŒì¼ ì„ íƒ ì‹œ
        fileInput.addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (file) {
                handleFileSelect(file);
            }
        });

        // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì´ë²¤íŠ¸
        fileUploadArea.addEventListener('dragover', function (e) {
            e.preventDefault();
            fileUploadArea.classList.add('dragover');
        });

        fileUploadArea.addEventListener('dragleave', function (e) {
            e.preventDefault();
            if (!fileUploadArea.contains(e.relatedTarget)) {
                fileUploadArea.classList.remove('dragover');
            }
        });

        fileUploadArea.addEventListener('drop', function (e) {
            e.preventDefault();
            fileUploadArea.classList.remove('dragover');

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileSelect(files[0]);
            }
        });
    }

    // Navigate to calendar detail page first
    function openCalendar(calendarId) {
        window.location.href = `/dashboard/calendar/${calendarId}`;
    }

    // ğŸ” Debug logging for calendar data
    console.log('ğŸ” Calendar List Debug Info:');
    console.log('ğŸ” Personal calendars:', {{ personal_calendars | tojson }});
    console.log('ğŸ” Shared calendars:', {{ shared_calendars | tojson }});
    console.log('ğŸ” Summary:', {{ summary | tojson }});

    // ğŸ” Check if data is being passed correctly
    const personalCount = {{ personal_calendars | length }};
    const sharedCount = {{ shared_calendars | length }};

    console.log('ğŸ” Personal calendars count:', personalCount);
    console.log('ğŸ” Shared calendars count:', sharedCount);

    if (personalCount === 0 && sharedCount === 0) {
        console.log('âš ï¸ No calendars found! This might be the issue.');
        console.log('ğŸ” Check if dashboard_data_available in backend:', '{{ dashboard_data_available }}');
    }

    // ğŸ” Monitor for page refresh/navigation
    window.addEventListener('beforeunload', function () {
        console.log('ğŸ” Page is being refreshed/navigated away');
    });

    // Delete Calendar Functions
    let calendarToDelete = null;

    function confirmDeleteCalendar(calendarId, calendarName) {
        calendarToDelete = calendarId;
        document.getElementById('calendar-name-to-delete').textContent = calendarName;
        document.getElementById('delete-modal-overlay').style.display = 'flex';
    }

    function closeDeleteModal() {
        document.getElementById('delete-modal-overlay').style.display = 'none';
        calendarToDelete = null;
    }

    function deleteCalendar() {
        if (!calendarToDelete) return;

        const deleteBtn = document.getElementById('confirm-delete-btn');
        deleteBtn.disabled = true;
        deleteBtn.innerHTML = '<div style="width:16px;height:16px;border:2px solid currentColor;border-top:2px solid transparent;border-radius:50%;animation:spin 1s linear infinite;"></div>ì‚­ì œ ì¤‘...';

        // Send delete request to server
        fetch(`/api/calendar/${calendarToDelete}/delete`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            },
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Remove calendar card from UI
                    const calendarCard = document.querySelector(`[data-calendar="${calendarToDelete}"]`);
                    if (calendarCard) {
                        calendarCard.style.transition = 'all 0.3s ease';
                        calendarCard.style.opacity = '0';
                        calendarCard.style.transform = 'scale(0.95)';
                        setTimeout(() => {
                            calendarCard.remove();
                            updateCalendarCounts();
                        }, 300);
                    }

                    closeDeleteModal();
                    showNotification('ìº˜ë¦°ë”ê°€ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                } else {
                    throw new Error(data.error || 'Failed to delete calendar');
                }
            })
            .catch(error => {
                console.error('Error deleting calendar:', error);
                showNotification('ìº˜ë¦°ë” ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'error');
            })
            .finally(() => {
                deleteBtn.disabled = false;
                deleteBtn.innerHTML = '<svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>ì‚­ì œí•˜ê¸°';
            });
    }

    function updateCalendarCounts() {
        const personalCards = document.querySelectorAll('.calendar-section-refined:first-child .calendar-card-refined').length;
        const sharedCards = document.querySelectorAll('.calendar-section-refined:last-child .calendar-card-refined').length;

        const personalCount = document.querySelector('.calendar-section-refined:first-child .section-count-refined');
        const sharedCount = document.querySelector('.calendar-section-refined:last-child .section-count-refined');

        if (personalCount) personalCount.textContent = personalCards;
        if (sharedCount) sharedCount.textContent = sharedCards;

        // Show empty state UI when no calendars exist
        showEmptyStateIfNeeded();
    }

    function showEmptyStateIfNeeded() {
        const personalContainer = document.querySelector('.calendar-section-refined:first-child .calendars-container-refined');
        const sharedContainer = document.querySelector('.calendar-section-refined:last-child .calendars-container-refined');

        const personalCards = document.querySelectorAll('.calendar-section-refined:first-child .calendar-card-refined').length;
        const sharedCards = document.querySelectorAll('.calendar-section-refined:last-child .calendar-card-refined').length;

        // Handle personal calendars empty state
        if (personalCards === 0 && personalContainer) {
            // Remove existing empty state message if any
            const existingEmpty = personalContainer.querySelector('.new-calendar-card-refined');
            if (!existingEmpty) {
                personalContainer.innerHTML = `
                    <div class="new-calendar-card-refined" onclick="createNewCalendar()">
                        <div class="new-calendar-content-refined">
                            <div class="new-calendar-icon-refined">
                                <svg width="32" height="32" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                        d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                </svg>
                            </div>
                            <h3 class="new-calendar-title-refined">ìƒˆ ìº˜ë¦°ë” ë§Œë“¤ê¸°</h3>
                            <p class="new-calendar-subtitle-refined">ê°œì¸ ì‘ì—…ê³¼ ì¼ì •ì„ ê´€ë¦¬í•˜ì„¸ìš”</p>
                        </div>
                    </div>
                `;
            }
        }

        // Handle shared calendars empty state
        if (sharedCards === 0 && sharedContainer) {
            // Remove existing empty state message if any
            const existingEmpty = sharedContainer.querySelector('.empty-state-message');
            if (!existingEmpty) {
                sharedContainer.innerHTML = `
                    <div class="empty-state-message" style="text-align: center; padding: 2rem; color: var(--color-gray-500);">
                        <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin: 0 auto 1rem; opacity: 0.5;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                        </svg>
                        <p>ì•„ì§ ê³µìœ ëœ ìº˜ë¦°ë”ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                        <p style="font-size: 0.875rem; margin-top: 0.5rem;">ë‹¤ë¥¸ ì‚¬ìš©ìì™€ ìº˜ë¦°ë”ë¥¼ ê³µìœ í•´ë³´ì„¸ìš”</p>
                    </div>
                `;
            }
        }
    }

    function showNotification(message, type = 'info') {
        // Add spinner styles
        if (!document.querySelector('#spinner-styles')) {
            const spinnerStyles = document.createElement('style');
            spinnerStyles.id = 'spinner-styles';
            spinnerStyles.textContent = `
                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
            `;
            document.head.appendChild(spinnerStyles);
        }

        // Create notification
        const notification = document.createElement('div');
        // Determine background color based on type
        let backgroundColor;
        switch (type) {
            case 'success':
                backgroundColor = '#10b981';
                break;
            case 'error':
                backgroundColor = '#ef4444';
                break;
            case 'warning':
                backgroundColor = '#f59e0b';
                break;
            default:
                backgroundColor = '#3b82f6';
        }

        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 300px;
            max-width: 500px;
            padding: 16px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            color: white;
            font-weight: 500;
            animation: slideIn 0.3s ease-out;
            background: ${backgroundColor};
        `;

        notification.innerHTML = `
            <div style="display: flex; align-items: center; justify-content: space-between; gap: 12px;">
                <span>${message}</span>
                <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; color: currentColor; font-size: 18px; cursor: pointer; opacity: 0.8;">Ã—</button>
            </div>
        `;

        document.body.appendChild(notification);

        // Auto remove after 4 seconds
        setTimeout(() => {
            if (notification.parentElement) {
                notification.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => notification.remove(), 300);
            }
        }, 4000);
    }

    // Add keyframes for notification
    if (!document.querySelector('#notification-keyframes')) {
        const keyframes = document.createElement('style');
        keyframes.id = 'notification-keyframes';
        keyframes.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
        `;
        document.head.appendChild(keyframes);
    }

    // Close modal when clicking outside or pressing Escape
    document.addEventListener('click', function (e) {
        const modal = document.getElementById('delete-modal-overlay');
        if (e.target === modal) {
            closeDeleteModal();
        }
    });

    document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') {
            closeDeleteModal();
        }
    });

    // Calendar selection management
    let selectedCalendars = new Set();

    function toggleCalendarSelection(calendarId) {
        const checkbox = document.querySelector(`.calendar-select-checkbox[value="${calendarId}"]`);
        const calendarCard = document.querySelector(`[data-calendar="${calendarId}"]`);

        if (checkbox.checked) {
            selectedCalendars.add(calendarId);
            if (calendarCard) {
                calendarCard.classList.add('selected');
            }
        } else {
            selectedCalendars.delete(calendarId);
            if (calendarCard) {
                calendarCard.classList.remove('selected');
            }
        }

        updateDeleteButtonVisibility();
    }

    function updateDeleteButtonVisibility() {
        const deleteBtn = document.getElementById('deleteSelectedBtn');
        const deselectBtn = document.getElementById('deselectAllBtn');

        if (selectedCalendars.size > 0) {
            deleteBtn.style.display = 'flex';
            deselectBtn.style.display = 'flex';
        } else {
            deleteBtn.style.display = 'none';
            deselectBtn.style.display = 'none';
        }
    }

    function deleteSelectedCalendars() {
        if (selectedCalendars.size === 0) {
            return;
        }

        const count = selectedCalendars.size;
        const message = count === 1
            ? 'ì„ íƒí•œ ìº˜ë¦°ë” 1ê°œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'
            : `ì„ íƒí•œ ìº˜ë¦°ë” ${count}ê°œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;

        if (!confirm(`${message}\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìœ¼ë©°, ìº˜ë¦°ë”ì˜ ëª¨ë“  ì´ë²¤íŠ¸ì™€ ë°ì´í„°ê°€ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œë©ë‹ˆë‹¤.`)) {
            return;
        }

        const deleteBtn = document.getElementById('deleteSelectedBtn');
        const originalHTML = deleteBtn.innerHTML;

        // Show loading state
        deleteBtn.disabled = true;
        deleteBtn.innerHTML = `
            <svg class="btn-icon" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10" stroke-width="2" style="animation: spin 1s linear infinite; stroke-dasharray: 31.416; stroke-dashoffset: 31.416;"/>
            </svg>
            <span>ì‚­ì œ ì¤‘...</span>
        `;

        // Convert Set to Array for processing
        const calendarsToDelete = Array.from(selectedCalendars);
        let deletedCount = 0;
        let failedCount = 0;

        // Delete calendars one by one
        const deletePromises = calendarsToDelete.map(calendarId =>
            fetch(`/api/calendar/${calendarId}/delete`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                },
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        deletedCount++;

                        // Remove calendar card from UI with animation
                        const calendarCard = document.querySelector(`[data-calendar="${calendarId}"]`);
                        if (calendarCard) {
                            calendarCard.classList.remove('selected');
                            calendarCard.style.transition = 'all 0.3s ease';
                            calendarCard.style.opacity = '0';
                            calendarCard.style.transform = 'scale(0.95)';
                            setTimeout(() => {
                                calendarCard.remove();
                                updateCalendarCounts();
                            }, 300);
                        }

                        // Remove from selected set
                        selectedCalendars.delete(calendarId);
                    } else {
                        throw new Error(data.error || 'Failed to delete calendar');
                    }
                })
                .catch(error => {
                    console.error(`Error deleting calendar ${calendarId}:`, error);
                    failedCount++;
                })
        );

        Promise.all(deletePromises).finally(() => {
            // Reset button state
            deleteBtn.disabled = false;
            deleteBtn.innerHTML = originalHTML;

            // Update UI
            updateDeleteButtonVisibility();

            // Show result notification
            if (deletedCount > 0 && failedCount === 0) {
                showNotification(`${deletedCount}ê°œì˜ ìº˜ë¦°ë”ê°€ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
            } else if (deletedCount > 0 && failedCount > 0) {
                showNotification(`${deletedCount}ê°œì˜ ìº˜ë¦°ë”ê°€ ì‚­ì œë˜ì—ˆìœ¼ë‚˜, ${failedCount}ê°œëŠ” ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.`, 'warning');
            } else if (failedCount > 0) {
                showNotification('ìº˜ë¦°ë” ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'error');
            }
        });
    }

    function selectAllCalendars() {
        const checkboxes = document.querySelectorAll('.calendar-select-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = true;
            selectedCalendars.add(checkbox.value);

            const calendarCard = document.querySelector(`[data-calendar="${checkbox.value}"]`);
            if (calendarCard) {
                calendarCard.classList.add('selected');
            }
        });
        updateDeleteButtonVisibility();
    }

    function deselectAllCalendars() {
        const checkboxes = document.querySelectorAll('.calendar-select-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = false;

            const calendarCard = document.querySelector(`[data-calendar="${checkbox.value}"]`);
            if (calendarCard) {
                calendarCard.classList.remove('selected');
            }
        });
        selectedCalendars.clear();
        updateDeleteButtonVisibility();
    }

    // ì‹¤ì‹œê°„ ì´ë²¤íŠ¸ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    async function updateRealTimeEventCounts() {
        const calendarCards = document.querySelectorAll('[data-calendar]');
        console.log('ğŸ”„ ì‹¤ì‹œê°„ ì´ë²¤íŠ¸ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸ ì‹œì‘:', calendarCards.length, 'ê°œ ìº˜ë¦°ë”');

        for (const card of calendarCards) {
            const calendarId = card.getAttribute('data-calendar');
            if (!calendarId) continue;

            try {
                // APIë¡œ ì‹¤ì œ ì´ë²¤íŠ¸ ê°œìˆ˜ ê°€ì ¸ì˜¤ê¸° (DB + ì‚¬ì´ë“œë°” ì´ë²¤íŠ¸ í¬í•¨)
                const response = await fetch(`/api/calendars/${calendarId}/real-event-count`);
                const data = await response.json();

                if (data.success && data.count !== undefined) {
                    // ìƒì„¸ ë¡œê¹…
                    console.log(`ğŸ“Š [REAL-TIME-COUNT] ===== CALENDAR COUNT UPDATE =====`);
                    console.log(`ğŸ“Š [REAL-TIME-COUNT] Calendar ID: ${calendarId}`);
                    console.log(`ğŸ“Š [REAL-TIME-COUNT] Total Count: ${data.count}`);
                    console.log(`ğŸ“Š [REAL-TIME-COUNT] DB Count: ${data.db_count || 'undefined'}`);
                    console.log(`ğŸ“Š [REAL-TIME-COUNT] Sidebar Count: ${data.sidebar_count || 'undefined'}`);
                    console.log(`ğŸ“Š [REAL-TIME-COUNT] Cache Status: ${data.cache_status || 'unknown'}`);
                    console.log(`ğŸ“Š [REAL-TIME-COUNT] Raw Response:`, data);
                    console.log(`ğŸ“Š [REAL-TIME-COUNT] ==============================`);

                    // UI ì—…ë°ì´íŠ¸
                    const metaElement = card.querySelector('.calendar-meta');
                    if (metaElement) {
                        const metaText = metaElement.textContent;
                        const updatedText = metaText.replace(/\d+ê°œ ì´ë²¤íŠ¸/, `${data.count}ê°œ ì´ë²¤íŠ¸`);
                        metaElement.textContent = updatedText;
                        console.log(`âœ… UI ì—…ë°ì´íŠ¸ ì™„ë£Œ: "${metaText}" â†’ "${updatedText}"`);
                    }
                } else {
                    console.warn(`âš ï¸ [REAL-TIME-COUNT] Invalid response for ${calendarId}:`, data);
                }
            } catch (error) {
                console.error(`âŒ ìº˜ë¦°ë” ${calendarId} ì´ë²¤íŠ¸ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:`, error);
            }
        }
    }

    // ğŸ” Log when page is loaded
    document.addEventListener('DOMContentLoaded', function () {
        console.log('ğŸ” Calendar list page fully loaded');
        console.log('ğŸ” Current URL:', window.location.href);

        // Check and show empty state UI if needed
        showEmptyStateIfNeeded();

        // ì‹¤ì‹œê°„ ì´ë²¤íŠ¸ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸ (3ì´ˆ í›„)
        setTimeout(() => {
            updateRealTimeEventCounts();
        }, 3000);
    });

    // DB ì´ë²¤íŠ¸ ì •ë¦¬ í•¨ìˆ˜ (ë””ë²„ê¹…ìš©)
    async function cleanCalendarDbEvents(calendarId) {
        if (!confirm('âš ï¸ ì´ ìº˜ë¦°ë”ì˜ ë°ì´í„°ë² ì´ìŠ¤ ì´ë²¤íŠ¸ë¥¼ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì‚¬ì´ë“œë°” ì´ë²¤íŠ¸ëŠ” ìœ ì§€ë©ë‹ˆë‹¤)')) {
            return;
        }

        try {
            console.log(`ğŸ—‘ï¸ Cleaning DB events for calendar: ${calendarId}`);

            const response = await fetch(`/api/calendars/${calendarId}/clean-db-events`, {
                method: 'DELETE',
                credentials: 'include'
            });

            const data = await response.json();

            if (data.success) {
                console.log(`âœ… Successfully deleted ${data.deleted_count} DB events`);
                alert(`âœ… ì„±ê³µì ìœ¼ë¡œ ${data.deleted_count}ê°œì˜ DB ì´ë²¤íŠ¸ë¥¼ ì‚­ì œí–ˆìŠµë‹ˆë‹¤.`);

                // ì´ë²¤íŠ¸ ì¹´ìš´íŠ¸ ìƒˆë¡œê³ ì¹¨
                updateRealTimeEventCounts();
            } else {
                console.error('âŒ Failed to clean DB events:', data.error);
                alert(`âŒ DB ì´ë²¤íŠ¸ ì‚­ì œ ì‹¤íŒ¨: ${data.error}`);
            }
        } catch (error) {
            console.error('âŒ Error cleaning DB events:', error);
            alert('âŒ DB ì´ë²¤íŠ¸ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }

    // ì „ì—­ í•¨ìˆ˜ë¡œ ë“±ë¡ (ê°œë°œì ì½˜ì†”ì—ì„œ ì‚¬ìš© ê°€ëŠ¥)
    window.cleanCalendarDbEvents = cleanCalendarDbEvents;
</script>
{% endblock %}