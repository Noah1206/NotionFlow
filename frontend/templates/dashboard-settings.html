{% extends "base_dashboard.html" %}

{% block title %}NotionFlow 설정 | 생산성 관리 센터{% endblock %}

{% block description %}NotionFlow 설정 페이지에서 생산성 지표를 확인하고 API 키를 관리하세요. 실시간 시간 절약 현황과 플랫폼 연결 상태를 관리하세요.{% endblock %}

{% block extra_css %}
<link rel="stylesheet"
    href="{{ url_for('static', filename='css/sidebar.css') }}?v={{ range(100000, 999999) | random }}">
<link rel="stylesheet"
    href="{{ url_for('static', filename='css/settings-redesign.css') }}?v={{ range(100000, 999999) | random }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="settings-container">
    <!-- Header Section -->
    <div class="settings-header">
        <div class="header-content">
            <h1 class="page-title">설정</h1>
            <p class="page-subtitle">생산성 관리 및 시스템 설정을 확인하세요</p>
        </div>
        <div class="header-actions">
            <button class="btn-icon">
                <i class="fas fa-bell"></i>
            </button>
            <button class="btn-icon">
                <i class="fas fa-cog"></i>
            </button>
        </div>
    </div>

    <!-- Activity Report Section -->
    <section class="content-section">
        <div class="section-header">
            <h2 class="section-title">
                <i class="fas fa-chart-line"></i>
                이번 주 활동 리포트
            </h2>
            <span class="section-badge">실시간</span>
        </div>

        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="metric-content">
                    <div class="metric-value">
                        <span class="metric-number">0</span>
                        <span class="metric-unit">시간</span>
                    </div>
                    <div class="metric-label">총 절약 시간</div>
                    <div class="metric-change neutral">
                        <i class="fas fa-minus"></i>
                        데이터 없음
                    </div>
                </div>
            </div>

            <div class="metric-card">
                <div class="metric-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="metric-content">
                    <div class="metric-value">
                        <span class="metric-number">0</span>
                        <span class="metric-unit">%</span>
                    </div>
                    <div class="metric-label">성공률</div>
                    <div class="metric-change neutral">
                        <i class="fas fa-minus"></i>
                        데이터 없음
                    </div>
                </div>
            </div>

            <div class="metric-card">
                <div class="metric-icon">
                    <i class="fas fa-sync"></i>
                </div>
                <div class="metric-content">
                    <div class="metric-value">
                        <span class="metric-number">0</span>
                        <span class="metric-unit">회</span>
                    </div>
                    <div class="metric-label">동기화 횟수</div>
                    <div class="metric-change neutral">
                        <i class="fas fa-minus"></i>
                        데이터 없음
                    </div>
                </div>
            </div>
        </div>

        <!-- Weekly Activity Chart -->
        <div class="chart-container">
            <canvas id="weeklyChart"></canvas>
        </div>
    </section>
    <!-- Platform Status -->
    <section class="content-section">
        <div class="section-header">
            <h2 class="section-title">
                <i class="fas fa-plug"></i>
                연결 상태 관리
            </h2>
            <button class="btn-text">연결 추가</button>
        </div>

        <div class="platform-grid">
            <div class="platform-card connected">
                <div class="platform-icon">
                    <svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                        <path
                            d="M4.459 4.208c.746.606 1.026.56 2.428.466l13.215-.793c.28 0 .047-.28-.046-.326L17.86 1.968c-.42-.326-.981-.7-2.055-.607L3.01 2.295c-.466.046-.56.28-.374.466zm.793 3.08v13.904c0 .747.373 1.027 1.214.98l14.523-.84c.841-.046 1.121-.56 1.121-1.167V6.354c0-.606-.233-.933-.747-.887l-15.177.887c-.56.047-.934.373-.934 1.027zm13.748.327c.093.42 0 .84-.42.888l-.7.14v10.264c-.608.327-1.168.514-1.635.514-.748 0-.935-.234-1.495-.933l-4.577-7.186v6.952L12.21 19s0 .84-1.168.84l-3.222.186c-.093-.186 0-.653.327-.746l.84-.233V9.854L7.822 9.76c-.094-.42.14-1.026.793-1.073l3.456-.233 4.764 7.279v-6.44l-1.215-.139c-.093-.514.28-.887.747-.933z" />
                    </svg>
                </div>
                <div class="platform-info">
                    <h3 class="platform-name">Notion</h3>
                    <span class="platform-status">
                        <i class="fas fa-circle"></i>
                        연결됨
                    </span>
                </div>
                <button class="btn-secondary-small">관리</button>
            </div>

            <div class="platform-card connected">
                <div class="platform-icon">
                    <svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                        <path
                            d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" />
                    </svg>
                </div>
                <div class="platform-info">
                    <h3 class="platform-name">Google</h3>
                    <span class="platform-status">
                        <i class="fas fa-circle"></i>
                        연결됨
                    </span>
                </div>
                <button class="btn-secondary-small">관리</button>
            </div>

            <div class="platform-card disconnected">
                <div class="platform-icon">
                    <svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                        <path
                            d="M17 3H7c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 16c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm2.5-4H9.5V6h5v9z" />
                    </svg>
                </div>
                <div class="platform-info">
                    <h3 class="platform-name">Apple</h3>
                    <span class="platform-status disconnected">
                        <i class="fas fa-circle"></i>
                        연결 끊김
                    </span>
                </div>
                <button class="btn-warning-small">재연결</button>
            </div>

            <div class="platform-card connected">
                <div class="platform-icon">
                    <svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                        <path
                            d="M7.88 12.04q0 .45-.11.87-.1.41-.33.74-.22.33-.58.52-.37.2-.87.2t-.85-.2q-.35-.21-.57-.55-.22-.33-.33-.75-.1-.42-.1-.83 0-.72.33-1.25.33-.53.96-.53.24 0 .42.05.17.05.3.14.12.09.2.22.07.12.07.26 0 .11-.06.2-.06.09-.15.09-.1 0-.14-.08-.05-.07-.05-.15 0-.23-.22-.23-.26 0-.45.27-.19.26-.19.73 0 .69.21.94.2.24.54.24.32 0 .52-.19.2-.19.27-.5.06-.3.06-.64zm2.64.04q0 .45-.11.87-.1.41-.33.74-.22.33-.58.52-.37.2-.87.2t-.85-.2q-.35-.21-.57-.55-.22-.33-.33-.75-.1-.42-.1-.83 0-.72.33-1.25.33-.53.96-.53.24 0 .42.05.17.05.3.14.12.09.2.22.07.12.07.26 0 .11-.06.2-.06.09-.15.09-.1 0-.14-.08-.05-.07-.05-.15 0-.23-.22-.23-.26 0-.45.27-.19.26-.19.73 0 .69.21.94.2.24.54.24.32 0 .52-.19.2-.19.27-.5.06-.3.06-.64z" />
                    </svg>
                </div>
                <div class="platform-info">
                    <h3 class="platform-name">Outlook</h3>
                    <span class="platform-status">
                        <i class="fas fa-circle"></i>
                        연결됨
                    </span>
                </div>
                <button class="btn-secondary-small">관리</button>
            </div>

            <div class="platform-card disconnected">
                <div class="platform-icon">
                    <svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                        <path
                            d="M5.042 15.165a2.528 2.528 0 0 1-2.52 2.523A2.528 2.528 0 0 1 0 15.165a2.527 2.527 0 0 1 2.522-2.52h2.52v2.52zM6.313 15.165a2.527 2.527 0 0 1 2.521-2.52 2.527 2.527 0 0 1 2.521 2.52v6.313A2.528 2.528 0 0 1 8.834 24a2.528 2.528 0 0 1-2.521-2.522v-6.313zM8.834 5.042a2.528 2.528 0 0 1-2.521-2.52A2.528 2.528 0 0 1 8.834 0a2.528 2.528 0 0 1 2.521 2.522v2.52H8.834zM8.834 6.313a2.528 2.528 0 0 1 2.521 2.521 2.528 2.528 0 0 1-2.521 2.521H2.522A2.528 2.528 0 0 1 0 8.834a2.528 2.528 0 0 1 2.522-2.521h6.312zM18.956 8.834a2.528 2.528 0 0 1 2.522-2.521A2.528 2.528 0 0 1 24 8.834a2.528 2.528 0 0 1-2.522 2.521h-2.522V8.834zM17.688 8.834a2.528 2.528 0 0 1-2.523 2.521 2.527 2.527 0 0 1-2.52-2.521V2.522A2.527 2.527 0 0 1 15.165 0a2.528 2.528 0 0 1 2.523 2.522v6.312zM15.165 18.956a2.528 2.528 0 0 1 2.523 2.522A2.528 2.528 0 0 1 15.165 24a2.527 2.527 0 0 1-2.52-2.522v-2.522h2.52zM15.165 17.688a2.527 2.527 0 0 1-2.52-2.523 2.526 2.526 0 0 1 2.52-2.52h6.313A2.527 2.527 0 0 1 24 15.165a2.528 2.528 0 0 1-2.522 2.523h-6.313z" />
                    </svg>
                </div>
                <div class="platform-info">
                    <h3 class="platform-name">Slack</h3>
                    <span class="platform-status disconnected">
                        <i class="fas fa-circle"></i>
                        연결 끊김
                    </span>
                </div>
                <button class="btn-warning-small">재연결</button>
            </div>

            <div class="platform-card add-new">
                <div class="platform-icon">
                    <i class="fas fa-plus"></i>
                </div>
                <div class="platform-info">
                    <h3 class="platform-name">새 플랫폼 추가</h3>
                    <span class="platform-status">더 많은 서비스 연결</span>
                </div>
            </div>
        </div>
    </section>

    <!-- Recent Activity Log -->
    <section class="content-section">
        <div class="section-header">
            <h2 class="section-title">
                <i class="fas fa-history"></i>
                최근 활동 로그
            </h2>
            <button class="btn-text">전체 기록</button>
        </div>

        <div class="activity-list">
            <div class="activity-item">
                <div class="activity-icon neutral">
                    <i class="fas fa-info"></i>
                </div>
                <div class="activity-content">
                    <div class="activity-title">활동 기록이 없습니다</div>
                    <div class="activity-meta">
                        <span class="activity-time">-</span>
                        <span class="activity-platform">System</span>
                    </div>
                </div>
                <div class="activity-status neutral">대기중</div>
            </div>
        </div>
    </section>
    <!-- Settings Actions -->
    <section class="content-section">
        <div class="section-header">
            <h2 class="section-title">
                <i class="fas fa-cog"></i>
                빠른 설정
            </h2>
        </div>

        <div class="settings-grid">
            <div class="setting-card">
                <div class="setting-header">
                    <h3 class="setting-title">알림 설정</h3>
                    <label class="switch">
                        <input type="checkbox">
                        <span class="slider"></span>
                    </label>
                </div>
                <p class="setting-description">동기화 완료 및 오류 알림을 받습니다</p>
            </div>

            <div class="setting-card">
                <div class="setting-header">
                    <h3 class="setting-title">자동 동기화</h3>
                    <label class="switch">
                        <input type="checkbox">
                        <span class="slider"></span>
                    </label>
                </div>
                <p class="setting-description">30분마다 자동으로 데이터를 동기화합니다</p>
            </div>

            <div class="setting-card">
                <div class="setting-header">
                    <h3 class="setting-title">이메일 알림</h3>
                    <label class="switch">
                        <input type="checkbox">
                        <span class="slider"></span>
                    </label>
                </div>
                <p class="setting-description">중요한 업데이트를 이메일로 받습니다</p>
            </div>

            <div class="setting-card">
                <div class="setting-header">
                    <h3 class="setting-title">데이터 백업</h3>
                    <label class="switch">
                        <input type="checkbox">
                        <span class="slider"></span>
                    </label>
                </div>
                <p class="setting-description">주간 자동 백업을 활성화합니다</p>
            </div>
        </div>
    </section>
</div>

<script>
    // Chart.js Configuration
    const ctx = document.getElementById('weeklyChart').getContext('2d');
    const weeklyChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: ['월', '화', '수', '목', '금', '토', '일'],
            datasets: [{
                label: '절약 시간 (시간)',
                data: [0, 0, 0, 0, 0, 0, 0],
                borderColor: '#3B82F6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                borderWidth: 2,
                tension: 0.4,
                pointBackgroundColor: '#3B82F6',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 4,
                pointHoverRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    cornerRadius: 8,
                    titleFont: {
                        size: 14
                    },
                    bodyFont: {
                        size: 13
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)',
                        drawBorder: false
                    },
                    ticks: {
                        padding: 10,
                        color: '#6B7280',
                        font: {
                            size: 12
                        }
                    }
                },
                x: {
                    grid: {
                        display: false,
                        drawBorder: false
                    },
                    ticks: {
                        padding: 10,
                        color: '#6B7280',
                        font: {
                            size: 12
                        }
                    }
                }
            }
        }
    });

    // 실제 데이터로 설정 페이지 업데이트
    async function updateSettingsData() {
        try {
            // 대시보드 통계 가져오기
            const statsResponse = await fetch('/api/dashboard/stats');
            if (statsResponse.ok) {
                const statsData = await statsResponse.json();
                if (statsData.success && statsData.stats) {
                    // 연결된 플랫폼이 없으면 모든 값을 0으로 설정
                    const connectedPlatforms = parseInt(statsData.stats.connected_platforms) || 0;
                    
                    if (connectedPlatforms === 0) {
                        // 연결된 플랫폼이 없으면 모든 통계를 0으로 설정
                        document.querySelector('.metric-card:nth-child(1) .metric-number').textContent = '0';
                        document.querySelector('.metric-card:nth-child(1) .metric-unit').textContent = '시간';
                        
                        document.querySelector('.metric-card:nth-child(2) .metric-number').textContent = '0';
                        
                        document.querySelector('.metric-card:nth-child(3) .metric-number').textContent = '0';
                        
                        // 변화량도 0으로 설정
                        document.querySelector('.metric-card:nth-child(1) .metric-change').innerHTML = '<i class="fas fa-minus"></i> 변화 없음';
                        document.querySelector('.metric-card:nth-child(2) .metric-change').innerHTML = '<i class="fas fa-minus"></i> 변화 없음';
                        document.querySelector('.metric-card:nth-child(3) .metric-change').innerHTML = '<i class="fas fa-minus"></i> 변화 없음';
                        
                        // 차트도 모두 0으로 설정
                        if (window.weeklyChart) {
                            window.weeklyChart.data.datasets[0].data = [0, 0, 0, 0, 0, 0, 0];
                            window.weeklyChart.update();
                        }
                    } else {
                        // 연결된 플랫폼이 있으면 실제 데이터 표시
                        const avgSyncTime = parseFloat(statsData.stats.avg_sync_time.replace('s', ''));
                        document.querySelector('.metric-card:nth-child(1) .metric-number').textContent = avgSyncTime.toFixed(1);
                        document.querySelector('.metric-card:nth-child(1) .metric-unit').textContent = '초';
                        
                        document.querySelector('.metric-card:nth-child(2) .metric-number').textContent = statsData.stats.success_rate.replace('%', '');
                        
                        document.querySelector('.metric-card:nth-child(3) .metric-number').textContent = statsData.stats.synced_events;
                    }
                    
                    console.log('Settings stats updated:', statsData.stats);
                }
            } else {
                // API 오류 시 모든 값을 0으로 설정
                setZeroValues();
            }

            // 플랫폼 상태 가져오기
            const platformsResponse = await fetch('/api/dashboard/platforms');
            if (platformsResponse.ok) {
                const platformsData = await platformsResponse.json();
                if (platformsData.success && platformsData.platforms) {
                    updatePlatformCards(platformsData.platforms);
                }
            }

            // 최근 활동 가져오기
            const activityResponse = await fetch('/api/dashboard/activity?limit=4');
            if (activityResponse.ok) {
                const activityData = await activityResponse.json();
                if (activityData.success && activityData.activity) {
                    updateActivityLog(activityData.activity);
                }
            }

        } catch (error) {
            console.error('Error updating settings data:', error);
            // 에러 시 모든 값을 0으로 설정
            setZeroValues();
        }
    }

    // 모든 값을 0으로 설정하는 함수
    function setZeroValues() {
        document.querySelector('.metric-card:nth-child(1) .metric-number').textContent = '0';
        document.querySelector('.metric-card:nth-child(1) .metric-unit').textContent = '시간';
        document.querySelector('.metric-card:nth-child(2) .metric-number').textContent = '0';
        document.querySelector('.metric-card:nth-child(3) .metric-number').textContent = '0';
        
        // 변화량도 0으로 설정
        document.querySelector('.metric-card:nth-child(1) .metric-change').innerHTML = '<i class="fas fa-minus"></i> 데이터 없음';
        document.querySelector('.metric-card:nth-child(2) .metric-change').innerHTML = '<i class="fas fa-minus"></i> 데이터 없음';
        document.querySelector('.metric-card:nth-child(3) .metric-change').innerHTML = '<i class="fas fa-minus"></i> 데이터 없음';
        
        // 차트도 모두 0으로 설정
        if (window.weeklyChart) {
            window.weeklyChart.data.datasets[0].data = [0, 0, 0, 0, 0, 0, 0];
            window.weeklyChart.update();
        }
    }

    // 플랫폼 카드 업데이트
    function updatePlatformCards(platforms) {
        const platformGrid = document.querySelector('.platform-grid');
        const platformNames = ['notion', 'google', 'apple', 'outlook', 'slack'];
        
        platformNames.forEach((platformName, index) => {
            const platformCard = platformGrid.children[index];
            const platform = platforms[platformName];
            
            if (platform && platformCard) {
                const statusElement = platformCard.querySelector('.platform-status');
                const button = platformCard.querySelector('button');
                
                if (platform.configured && platform.enabled) {
                    // 연결된 상태
                    platformCard.className = 'platform-card connected';
                    statusElement.innerHTML = '<i class="fas fa-circle"></i> 연결됨';
                    if (button) button.textContent = '관리';
                } else {
                    // 연결되지 않은 상태
                    platformCard.className = 'platform-card disconnected';
                    statusElement.innerHTML = '<i class="fas fa-circle"></i> 연결 끊김';
                    statusElement.classList.add('disconnected');
                    if (button) {
                        button.textContent = '재연결';
                        button.className = 'btn-warning-small';
                    }
                }
            }
        });
    }

    // 활동 로그 업데이트
    function updateActivityLog(activities) {
        const activityList = document.querySelector('.activity-list');
        if (!activities || activities.length === 0) {
            // 활동이 없으면 "활동 없음" 메시지 표시
            activityList.innerHTML = `
                <div class="activity-item">
                    <div class="activity-icon neutral">
                        <i class="fas fa-info"></i>
                    </div>
                    <div class="activity-content">
                        <div class="activity-title">활동 기록이 없습니다</div>
                        <div class="activity-meta">
                            <span class="activity-time">-</span>
                            <span class="activity-platform">System</span>
                        </div>
                    </div>
                    <div class="activity-status neutral">대기중</div>
                </div>
            `;
            return;
        }
        
        activityList.innerHTML = ''; // 기존 내용 클리어
        
        activities.slice(0, 4).forEach(activity => {
            const activityItem = document.createElement('div');
            activityItem.className = 'activity-item';
            
            // 활동 타입에 따른 제목 생성
            let activityTitle = activity.description || getActivityTitle(activity.event_type, activity.platform);
            
            // 상태에 따른 클래스 및 아이콘 설정
            const statusClass = getStatusClass(activity.status);
            const statusIcon = getStatusIcon(activity.status);
            const statusText = getStatusText(activity.status);
            
            activityItem.innerHTML = `
                <div class="activity-icon ${statusClass}">
                    <i class="fas ${statusIcon}"></i>
                </div>
                <div class="activity-content">
                    <div class="activity-title">${activityTitle}</div>
                    <div class="activity-meta">
                        <span class="activity-time">${formatTimeAgo(activity.created_at)}</span>
                        <span class="activity-platform">${getPlatformDisplayName(activity.platform)}</span>
                    </div>
                </div>
                <div class="activity-status ${statusClass}">${statusText}</div>
            `;
            
            activityList.appendChild(activityItem);
        });
    }

    // 활동 제목 생성
    function getActivityTitle(eventType, platform) {
        const platformName = getPlatformDisplayName(platform);
        
        switch (eventType) {
            case 'sync_started':
                return `${platformName} 동기화 시작`;
            case 'sync_completed':
                return `${platformName} 동기화 완료`;
            case 'sync_failed':
                return `${platformName} 동기화 실패`;
            case 'connection_established':
                return `${platformName} 연결 완료`;
            case 'connection_failed':
                return `${platformName} 연결 실패`;
            case 'data_imported':
                return `${platformName} 데이터 가져오기 완료`;
            case 'backup_created':
                return `${platformName} 백업 생성`;
            default:
                return `${platformName} 활동`;
        }
    }

    // 플랫폼 표시명 반환
    function getPlatformDisplayName(platform) {
        const platformNames = {
            'notion': 'Notion',
            'google': 'Google Calendar',
            'apple': 'Apple Calendar',
            'outlook': 'Outlook',
            'slack': 'Slack',
            'system': 'System'
        };
        return platformNames[platform] || platform || 'Unknown';
    }

    // 상태 클래스 반환
    function getStatusClass(status) {
        switch (status) {
            case 'success':
            case 'completed':
                return 'success';
            case 'error':
            case 'failed':
                return 'error';
            case 'warning':
            case 'partial':
                return 'warning';
            default:
                return 'neutral';
        }
    }

    // 상태 아이콘 반환
    function getStatusIcon(status) {
        switch (status) {
            case 'success':
            case 'completed':
                return 'fa-check';
            case 'error':
            case 'failed':
                return 'fa-times';
            case 'warning':
            case 'partial':
                return 'fa-exclamation';
            default:
                return 'fa-info';
        }
    }

    // 상태 텍스트 반환
    function getStatusText(status) {
        switch (status) {
            case 'success':
            case 'completed':
                return '성공';
            case 'error':
            case 'failed':
                return '실패';
            case 'warning':
            case 'partial':
                return '부분 성공';
            default:
                return '대기중';
        }
    }

    // 시간 포맷 함수
    function formatTimeAgo(timestamp) {
        if (!timestamp) return '-';
        
        const now = new Date();
        const time = new Date(timestamp);
        const diffMs = now - time;
        const diffMins = Math.floor(diffMs / (1000 * 60));
        const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
        const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
        
        if (diffMins < 1) return '방금 전';
        if (diffMins < 60) return `${diffMins}분 전`;
        if (diffHours < 24) return `${diffHours}시간 전`;
        if (diffDays < 7) return `${diffDays}일 전`;
        return time.toLocaleDateString('ko-KR');
    }

    // 페이지 로드 시 데이터 업데이트
    document.addEventListener('DOMContentLoaded', function() {
        // 차트를 전역 변수로 저장
        window.weeklyChart = weeklyChart;
        
        // 실제 데이터 로드
        updateSettingsData();
        
        // 30초마다 데이터 업데이트
        setInterval(updateSettingsData, 30000);
    });

    // Initialize light theme
    document.documentElement.setAttribute('data-theme', 'light');

    // OAuth 성공 메시지 리스너 - Notion 연결 후 캘린더로 자동 이동
    window.addEventListener('message', function(event) {
        if (event.data && event.data.type === 'oauth_success') {
            console.log('OAuth success received:', event.data);
            
            // 성공 알림 표시
            showNotification(
                `${event.data.platform.charAt(0).toUpperCase() + event.data.platform.slice(1)} 연결 완료!`, 
                'success'
            );
            
            // Notion 연결이고 동기화가 성공했으면 캘린더로 이동
            if (event.data.platform === 'notion' && event.data.redirect_to_calendar) {
                setTimeout(() => {
                    console.log('Redirecting to calendar after Notion sync...');
                    window.location.href = '/calendar';
                }, 1500); // 1.5초 후 이동 (알림이 보인 후)
            } else {
                // 다른 플랫폼이거나 동기화할 데이터가 없으면 페이지 새로고침
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            }
        }
    });

    // 알림 표시 함수
    function showNotification(message, type = 'info') {
        // 기존 알림 제거
        const existingNotification = document.querySelector('.oauth-notification');
        if (existingNotification) {
            existingNotification.remove();
        }

        // 새 알림 생성
        const notification = document.createElement('div');
        notification.className = `oauth-notification ${type}`;
        notification.innerHTML = `
            <div class="notification-content">
                <i class="fas fa-check-circle"></i>
                <span>${message}</span>
            </div>
        `;
        
        // 스타일 추가
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${type === 'success' ? '#10B981' : '#3B82F6'};
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 10000;
            animation: slideIn 0.3s ease;
        `;
        
        document.body.appendChild(notification);
        
        // 3초 후 제거
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 3000);
    }

    // 알림 애니메이션 CSS 추가
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .oauth-notification .notification-content {
            display: flex;
            align-items: center;
            gap: 8px;
        }
    `;
    document.head.appendChild(style);
</script>
{% endblock %}