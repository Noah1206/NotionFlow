{% extends "base_dashboard.html" %}

{% block title %}NotionFlow ì„¤ì • | ìƒì‚°ì„± ê´€ë¦¬ ì„¼í„°{% endblock %}

{% block description %}NotionFlow ì„¤ì • í˜ì´ì§€ì—ì„œ ìƒì‚°ì„± ì§€í‘œë¥¼ í™•ì¸í•˜ê³  API í‚¤ë¥¼ ê´€ë¦¬í•˜ì„¸ìš”. ì‹¤ì‹œê°„ ì‹œê°„ ì ˆì•½ í˜„í™©ê³¼ í”Œë«í¼ ì—°ê²° ìƒíƒœë¥¼ ê´€ë¦¬í•˜ì„¸ìš”.{% endblock %}

{% block extra_css %}
<link rel="stylesheet"
    href="{{ url_for('static', filename='css/sidebar.css') }}?v={{ range(100000, 999999) | random }}">
<link rel="stylesheet"
    href="{{ url_for('static', filename='css/settings-redesign.css') }}?v={{ range(100000, 999999) | random }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="settings-container">
    <!-- Header Section -->
    <div class="settings-header">
        <div class="header-content">
            <h1 class="page-title">ì„¤ì •</h1>
            <p class="page-subtitle">ìƒì‚°ì„± ê´€ë¦¬ ë° ì‹œìŠ¤í…œ ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”</p>
        </div>
        <div class="header-actions">
            <button class="btn-icon">
                <i class="fas fa-bell"></i>
            </button>
            <button class="btn-icon">
                <i class="fas fa-cog"></i>
            </button>
        </div>
    </div>

    <!-- Activity Report Section -->
    <section class="content-section">
        <div class="section-header">
            <h2 class="section-title">
                <i class="fas fa-chart-line"></i>
                ì´ë²ˆ ì£¼ í™œë™ ë¦¬í¬íŠ¸
            </h2>
            <span class="section-badge">ì‹¤ì‹œê°„</span>
        </div>

        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="metric-content">
                    <div class="metric-value">
                        <span class="metric-number">0</span>
                        <span class="metric-unit">ì‹œê°„</span>
                    </div>
                    <div class="metric-label">ì´ ì ˆì•½ ì‹œê°„</div>
                    <div class="metric-change neutral">
                        <i class="fas fa-minus"></i>
                        ë°ì´í„° ì—†ìŒ
                    </div>
                </div>
            </div>

            <div class="metric-card">
                <div class="metric-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="metric-content">
                    <div class="metric-value">
                        <span class="metric-number">0</span>
                        <span class="metric-unit">%</span>
                    </div>
                    <div class="metric-label">ì„±ê³µë¥ </div>
                    <div class="metric-change neutral">
                        <i class="fas fa-minus"></i>
                        ë°ì´í„° ì—†ìŒ
                    </div>
                </div>
            </div>

            <div class="metric-card">
                <div class="metric-icon">
                    <i class="fas fa-sync"></i>
                </div>
                <div class="metric-content">
                    <div class="metric-value">
                        <span class="metric-number">0</span>
                        <span class="metric-unit">íšŒ</span>
                    </div>
                    <div class="metric-label">ë™ê¸°í™” íšŸìˆ˜</div>
                    <div class="metric-change neutral">
                        <i class="fas fa-minus"></i>
                        ë°ì´í„° ì—†ìŒ
                    </div>
                </div>
            </div>
        </div>

        <!-- Weekly Activity Chart -->
        <div class="chart-container">
            <canvas id="weeklyChart"></canvas>
        </div>
    </section>
    <!-- Platform Status -->
    <section class="content-section">
        <div class="section-header">
            <h2 class="section-title">
                <i class="fas fa-plug"></i>
                ì—°ê²° ìƒíƒœ ê´€ë¦¬
            </h2>
            <button class="btn-text">ì—°ê²° ì¶”ê°€</button>
        </div>

        <div class="platform-grid">
            <div class="platform-card connected">
                <div class="platform-icon">
                    <svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                        <path
                            d="M4.459 4.208c.746.606 1.026.56 2.428.466l13.215-.793c.28 0 .047-.28-.046-.326L17.86 1.968c-.42-.326-.981-.7-2.055-.607L3.01 2.295c-.466.046-.56.28-.374.466zm.793 3.08v13.904c0 .747.373 1.027 1.214.98l14.523-.84c.841-.046 1.121-.56 1.121-1.167V6.354c0-.606-.233-.933-.747-.887l-15.177.887c-.56.047-.934.373-.934 1.027zm13.748.327c.093.42 0 .84-.42.888l-.7.14v10.264c-.608.327-1.168.514-1.635.514-.748 0-.935-.234-1.495-.933l-4.577-7.186v6.952L12.21 19s0 .84-1.168.84l-3.222.186c-.093-.186 0-.653.327-.746l.84-.233V9.854L7.822 9.76c-.094-.42.14-1.026.793-1.073l3.456-.233 4.764 7.279v-6.44l-1.215-.139c-.093-.514.28-.887.747-.933z" />
                    </svg>
                </div>
                <div class="platform-info">
                    <h3 class="platform-name">Notion</h3>
                    <span class="platform-status">
                        <i class="fas fa-circle"></i>
                        ì—°ê²°ë¨
                    </span>
                </div>
                <!-- Notion ë²„íŠ¼ë“¤ì€ JavaScriptì—ì„œ ë™ì ìœ¼ë¡œ ê´€ë¦¬ë¨ -->
            </div>

            <div class="platform-card connected">
                <div class="platform-icon">
                    <svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                        <path
                            d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" />
                    </svg>
                </div>
                <div class="platform-info">
                    <h3 class="platform-name">Google</h3>
                    <span class="platform-status">
                        <i class="fas fa-circle"></i>
                        ì—°ê²°ë¨
                    </span>
                </div>
                <button class="btn-warning-small" onclick="disconnectPlatform('google')">ì—°ê²°í•´ì œ</button>
            </div>

            <div class="platform-card disconnected">
                <div class="platform-icon">
                    <svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                        <path
                            d="M17 3H7c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 16c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm2.5-4H9.5V6h5v9z" />
                    </svg>
                </div>
                <div class="platform-info">
                    <h3 class="platform-name">Apple</h3>
                    <span class="platform-status disconnected">
                        <i class="fas fa-circle"></i>
                        ì—°ê²° ëŠê¹€
                    </span>
                </div>
                <button class="btn-secondary-small" onclick="connectPlatform('apple')">ì—°ê²°</button>
            </div>

            <div class="platform-card connected">
                <div class="platform-icon">
                    <svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                        <path
                            d="M7.88 12.04q0 .45-.11.87-.1.41-.33.74-.22.33-.58.52-.37.2-.87.2t-.85-.2q-.35-.21-.57-.55-.22-.33-.33-.75-.1-.42-.1-.83 0-.72.33-1.25.33-.53.96-.53.24 0 .42.05.17.05.3.14.12.09.2.22.07.12.07.26 0 .11-.06.2-.06.09-.15.09-.1 0-.14-.08-.05-.07-.05-.15 0-.23-.22-.23-.26 0-.45.27-.19.26-.19.73 0 .69.21.94.2.24.54.24.32 0 .52-.19.2-.19.27-.5.06-.3.06-.64zm2.64.04q0 .45-.11.87-.1.41-.33.74-.22.33-.58.52-.37.2-.87.2t-.85-.2q-.35-.21-.57-.55-.22-.33-.33-.75-.1-.42-.1-.83 0-.72.33-1.25.33-.53.96-.53.24 0 .42.05.17.05.3.14.12.09.2.22.07.12.07.26 0 .11-.06.2-.06.09-.15.09-.1 0-.14-.08-.05-.07-.05-.15 0-.23-.22-.23-.26 0-.45.27-.19.26-.19.73 0 .69.21.94.2.24.54.24.32 0 .52-.19.2-.19.27-.5.06-.3.06-.64z" />
                    </svg>
                </div>
                <div class="platform-info">
                    <h3 class="platform-name">Outlook</h3>
                    <span class="platform-status">
                        <i class="fas fa-circle"></i>
                        ì—°ê²°ë¨
                    </span>
                </div>
                <button class="btn-warning-small" onclick="disconnectPlatform('outlook')">ì—°ê²°í•´ì œ</button>
            </div>

            <div class="platform-card disconnected">
                <div class="platform-icon">
                    <svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                        <path
                            d="M5.042 15.165a2.528 2.528 0 0 1-2.52 2.523A2.528 2.528 0 0 1 0 15.165a2.527 2.527 0 0 1 2.522-2.52h2.52v2.52zM6.313 15.165a2.527 2.527 0 0 1 2.521-2.52 2.527 2.527 0 0 1 2.521 2.52v6.313A2.528 2.528 0 0 1 8.834 24a2.528 2.528 0 0 1-2.521-2.522v-6.313zM8.834 5.042a2.528 2.528 0 0 1-2.521-2.52A2.528 2.528 0 0 1 8.834 0a2.528 2.528 0 0 1 2.521 2.522v2.52H8.834zM8.834 6.313a2.528 2.528 0 0 1 2.521 2.521 2.528 2.528 0 0 1-2.521 2.521H2.522A2.528 2.528 0 0 1 0 8.834a2.528 2.528 0 0 1 2.522-2.521h6.312zM18.956 8.834a2.528 2.528 0 0 1 2.522-2.521A2.528 2.528 0 0 1 24 8.834a2.528 2.528 0 0 1-2.522 2.521h-2.522V8.834zM17.688 8.834a2.528 2.528 0 0 1-2.523 2.521 2.527 2.527 0 0 1-2.52-2.521V2.522A2.527 2.527 0 0 1 15.165 0a2.528 2.528 0 0 1 2.523 2.522v6.312zM15.165 18.956a2.528 2.528 0 0 1 2.523 2.522A2.528 2.528 0 0 1 15.165 24a2.527 2.527 0 0 1-2.52-2.522v-2.522h2.52zM15.165 17.688a2.527 2.527 0 0 1-2.52-2.523 2.526 2.526 0 0 1 2.52-2.52h6.313A2.527 2.527 0 0 1 24 15.165a2.528 2.528 0 0 1-2.522 2.523h-6.313z" />
                    </svg>
                </div>
                <div class="platform-info">
                    <h3 class="platform-name">Slack</h3>
                    <span class="platform-status disconnected">
                        <i class="fas fa-circle"></i>
                        ì—°ê²° ëŠê¹€
                    </span>
                </div>
                <button class="btn-secondary-small" onclick="connectPlatform('slack')">ì—°ê²°</button>
            </div>

            <div class="platform-card add-new">
                <div class="platform-icon">
                    <i class="fas fa-plus"></i>
                </div>
                <div class="platform-info">
                    <h3 class="platform-name">ìƒˆ í”Œë«í¼ ì¶”ê°€</h3>
                    <span class="platform-status">ë” ë§ì€ ì„œë¹„ìŠ¤ ì—°ê²°</span>
                </div>
            </div>
        </div>
    </section>

    <!-- Recent Activity Log -->
    <section class="content-section">
        <div class="section-header">
            <h2 class="section-title">
                <i class="fas fa-history"></i>
                ìµœê·¼ í™œë™ ë¡œê·¸
            </h2>
            <button class="btn-text">ì „ì²´ ê¸°ë¡</button>
        </div>

        <div class="activity-list">
            <div class="activity-item">
                <div class="activity-icon neutral">
                    <i class="fas fa-info"></i>
                </div>
                <div class="activity-content">
                    <div class="activity-title">í™œë™ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>
                    <div class="activity-meta">
                        <span class="activity-time">-</span>
                        <span class="activity-platform">System</span>
                    </div>
                </div>
                <div class="activity-status neutral">ëŒ€ê¸°ì¤‘</div>
            </div>
        </div>
    </section>
    <!-- Settings Actions -->
    <section class="content-section">
        <div class="section-header">
            <h2 class="section-title">
                <i class="fas fa-cog"></i>
                ë¹ ë¥¸ ì„¤ì •
            </h2>
        </div>

        <div class="settings-grid">
            <div class="setting-card">
                <div class="setting-header">
                    <h3 class="setting-title">ì•Œë¦¼ ì„¤ì •</h3>
                    <label class="switch">
                        <input type="checkbox">
                        <span class="slider"></span>
                    </label>
                </div>
                <p class="setting-description">ë™ê¸°í™” ì™„ë£Œ ë° ì˜¤ë¥˜ ì•Œë¦¼ì„ ë°›ìŠµë‹ˆë‹¤</p>
            </div>

            <div class="setting-card">
                <div class="setting-header">
                    <h3 class="setting-title">ìë™ ë™ê¸°í™”</h3>
                    <label class="switch">
                        <input type="checkbox">
                        <span class="slider"></span>
                    </label>
                </div>
                <p class="setting-description">30ë¶„ë§ˆë‹¤ ìë™ìœ¼ë¡œ ë°ì´í„°ë¥¼ ë™ê¸°í™”í•©ë‹ˆë‹¤</p>
            </div>

            <div class="setting-card">
                <div class="setting-header">
                    <h3 class="setting-title">ì´ë©”ì¼ ì•Œë¦¼</h3>
                    <label class="switch">
                        <input type="checkbox">
                        <span class="slider"></span>
                    </label>
                </div>
                <p class="setting-description">ì¤‘ìš”í•œ ì—…ë°ì´íŠ¸ë¥¼ ì´ë©”ì¼ë¡œ ë°›ìŠµë‹ˆë‹¤</p>
            </div>

            <div class="setting-card">
                <div class="setting-header">
                    <h3 class="setting-title">ë°ì´í„° ë°±ì—…</h3>
                    <label class="switch">
                        <input type="checkbox">
                        <span class="slider"></span>
                    </label>
                </div>
                <p class="setting-description">ì£¼ê°„ ìë™ ë°±ì—…ì„ í™œì„±í™”í•©ë‹ˆë‹¤</p>
            </div>
        </div>
    </section>
</div>

<script>
    // Chart.js Configuration
    const ctx = document.getElementById('weeklyChart').getContext('2d');
    const weeklyChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼'],
            datasets: [{
                label: 'ì ˆì•½ ì‹œê°„ (ì‹œê°„)',
                data: [0, 0, 0, 0, 0, 0, 0],
                borderColor: '#3B82F6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                borderWidth: 2,
                tension: 0.4,
                pointBackgroundColor: '#3B82F6',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 4,
                pointHoverRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    cornerRadius: 8,
                    titleFont: {
                        size: 14
                    },
                    bodyFont: {
                        size: 13
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)',
                        drawBorder: false
                    },
                    ticks: {
                        padding: 10,
                        color: '#6B7280',
                        font: {
                            size: 12
                        }
                    }
                },
                x: {
                    grid: {
                        display: false,
                        drawBorder: false
                    },
                    ticks: {
                        padding: 10,
                        color: '#6B7280',
                        font: {
                            size: 12
                        }
                    }
                }
            }
        }
    });

    // ì‹¤ì œ ë°ì´í„°ë¡œ ì„¤ì • í˜ì´ì§€ ì—…ë°ì´íŠ¸
    async function updateSettingsData() {
        try {
            // ëŒ€ì‹œë³´ë“œ í†µê³„ ê°€ì ¸ì˜¤ê¸°
            const statsResponse = await fetch('/api/dashboard/stats');
            if (statsResponse.ok) {
                const statsData = await statsResponse.json();
                if (statsData.success && statsData.stats) {
                    // ì—°ê²°ëœ í”Œë«í¼ì´ ì—†ìœ¼ë©´ ëª¨ë“  ê°’ì„ 0ìœ¼ë¡œ ì„¤ì •
                    const connectedPlatforms = parseInt(statsData.stats.connected_platforms) || 0;
                    
                    if (connectedPlatforms === 0) {
                        // ì—°ê²°ëœ í”Œë«í¼ì´ ì—†ìœ¼ë©´ ëª¨ë“  í†µê³„ë¥¼ 0ìœ¼ë¡œ ì„¤ì •
                        document.querySelector('.metric-card:nth-child(1) .metric-number').textContent = '0';
                        document.querySelector('.metric-card:nth-child(1) .metric-unit').textContent = 'ì‹œê°„';
                        
                        document.querySelector('.metric-card:nth-child(2) .metric-number').textContent = '0';
                        
                        document.querySelector('.metric-card:nth-child(3) .metric-number').textContent = '0';
                        
                        // ë³€í™”ëŸ‰ë„ 0ìœ¼ë¡œ ì„¤ì •
                        document.querySelector('.metric-card:nth-child(1) .metric-change').innerHTML = '<i class="fas fa-minus"></i> ë³€í™” ì—†ìŒ';
                        document.querySelector('.metric-card:nth-child(2) .metric-change').innerHTML = '<i class="fas fa-minus"></i> ë³€í™” ì—†ìŒ';
                        document.querySelector('.metric-card:nth-child(3) .metric-change').innerHTML = '<i class="fas fa-minus"></i> ë³€í™” ì—†ìŒ';
                        
                        // ì°¨íŠ¸ë„ ëª¨ë‘ 0ìœ¼ë¡œ ì„¤ì •
                        if (window.weeklyChart) {
                            window.weeklyChart.data.datasets[0].data = [0, 0, 0, 0, 0, 0, 0];
                            window.weeklyChart.update();
                        }
                    } else {
                        // ì—°ê²°ëœ í”Œë«í¼ì´ ìˆìœ¼ë©´ ì‹¤ì œ ë°ì´í„° í‘œì‹œ
                        const avgSyncTime = parseFloat(statsData.stats.avg_sync_time.replace('s', ''));
                        document.querySelector('.metric-card:nth-child(1) .metric-number').textContent = avgSyncTime.toFixed(1);
                        document.querySelector('.metric-card:nth-child(1) .metric-unit').textContent = 'ì´ˆ';
                        
                        document.querySelector('.metric-card:nth-child(2) .metric-number').textContent = statsData.stats.success_rate.replace('%', '');
                        
                        document.querySelector('.metric-card:nth-child(3) .metric-number').textContent = statsData.stats.synced_events;
                    }
                    
                    console.log('Settings stats updated:', statsData.stats);
                }
            } else {
                // API ì˜¤ë¥˜ ì‹œ ëª¨ë“  ê°’ì„ 0ìœ¼ë¡œ ì„¤ì •
                setZeroValues();
            }

            // í”Œë«í¼ ìƒíƒœ ê°€ì ¸ì˜¤ê¸°
            const platformsResponse = await fetch('/api/dashboard/platforms');
            if (platformsResponse.ok) {
                const platformsData = await platformsResponse.json();
                if (platformsData.success && platformsData.platforms) {
                    updatePlatformCards(platformsData.platforms);
                }
            }

            // ìµœê·¼ í™œë™ ê°€ì ¸ì˜¤ê¸°
            const activityResponse = await fetch('/api/dashboard/activity?limit=4');
            if (activityResponse.ok) {
                const activityData = await activityResponse.json();
                if (activityData.success && activityData.activity) {
                    updateActivityLog(activityData.activity);
                }
            }

        } catch (error) {
            console.error('Error updating settings data:', error);
            // ì—ëŸ¬ ì‹œ ëª¨ë“  ê°’ì„ 0ìœ¼ë¡œ ì„¤ì •
            setZeroValues();
        }
    }

    // ëª¨ë“  ê°’ì„ 0ìœ¼ë¡œ ì„¤ì •í•˜ëŠ” í•¨ìˆ˜
    function setZeroValues() {
        document.querySelector('.metric-card:nth-child(1) .metric-number').textContent = '0';
        document.querySelector('.metric-card:nth-child(1) .metric-unit').textContent = 'ì‹œê°„';
        document.querySelector('.metric-card:nth-child(2) .metric-number').textContent = '0';
        document.querySelector('.metric-card:nth-child(3) .metric-number').textContent = '0';
        
        // ë³€í™”ëŸ‰ë„ 0ìœ¼ë¡œ ì„¤ì •
        document.querySelector('.metric-card:nth-child(1) .metric-change').innerHTML = '<i class="fas fa-minus"></i> ë°ì´í„° ì—†ìŒ';
        document.querySelector('.metric-card:nth-child(2) .metric-change').innerHTML = '<i class="fas fa-minus"></i> ë°ì´í„° ì—†ìŒ';
        document.querySelector('.metric-card:nth-child(3) .metric-change').innerHTML = '<i class="fas fa-minus"></i> ë°ì´í„° ì—†ìŒ';
        
        // ì°¨íŠ¸ë„ ëª¨ë‘ 0ìœ¼ë¡œ ì„¤ì •
        if (window.weeklyChart) {
            window.weeklyChart.data.datasets[0].data = [0, 0, 0, 0, 0, 0, 0];
            window.weeklyChart.update();
        }
    }

    // í”Œë«í¼ ì¹´ë“œ ì—…ë°ì´íŠ¸
    function updatePlatformCards(platforms) {
        const platformGrid = document.querySelector('.platform-grid');
        const platformNames = ['notion', 'google', 'apple', 'outlook', 'slack'];
        
        platformNames.forEach((platformName, index) => {
            const platformCard = platformGrid.children[index];
            const platform = platforms[platformName];
            
            if (platform && platformCard) {
                const statusElement = platformCard.querySelector('.platform-status');
                const button = platformCard.querySelector('button');
                
                // ê¸°ì¡´ì˜ íŠ¹ë³„í•œ ë²„íŠ¼ë“¤ ì œê±° (ì´ˆë¡ìƒ‰ ë²„íŠ¼, X ë²„íŠ¼ ë“±)
                const existingSpecialButtons = platformCard.querySelectorAll(
                    '.btn-success, .connection-status-btn, .sync-status-btn, [class*="connected-btn"], ' +
                    '.btn-success-small, [onclick*="disconnectSpecial"], [class*="green"], ' +
                    'button:contains("ì—°ë™ë¨"), button:contains("Ã—"), button[class*="close"]'
                );
                existingSpecialButtons.forEach(btn => btn.remove());
                
                // X ë²„íŠ¼ì´ë‚˜ íŠ¹ë³„í•œ í˜•íƒœì˜ ì—°ë™ ìƒíƒœ ë²„íŠ¼ë“¤ë„ ì œê±°
                const specialStatusButtons = platformCard.querySelectorAll('button');
                specialStatusButtons.forEach(btn => {
                    if (btn.textContent && (
                        btn.textContent.includes('ì—°ë™ë¨') || 
                        btn.textContent.includes('Ã—') ||
                        btn.textContent.includes('ë‚´ ì„¸ ìº˜ë¦°ë”') ||
                        btn.classList.contains('btn-success')
                    )) {
                        btn.remove();
                    }
                });
                
                // ë²„íŠ¼ì´ ì œê±°ë˜ì—ˆë‹¤ë©´ ìƒˆë¡œ ìƒì„±
                let actionButton = platformCard.querySelector('button');
                if (!actionButton) {
                    actionButton = document.createElement('button');
                    platformCard.appendChild(actionButton);
                }
                
                if (platform.configured && platform.enabled) {
                    // ì—°ê²°ëœ ìƒíƒœ - ì¼ê´€ëœ "ì—°ê²°í•´ì œ" ë²„íŠ¼
                    platformCard.className = 'platform-card connected';
                    statusElement.innerHTML = '<i class="fas fa-circle"></i> ì—°ê²°ë¨';
                    statusElement.classList.remove('disconnected');
                    
                    // Notionì˜ ê²½ìš° ìº˜ë¦°ë” ë™ê¸°í™” ìƒíƒœ í™•ì¸
                    if (platformName === 'notion') {
                        // ìº˜ë¦°ë” ë™ê¸°í™” ìƒíƒœ í™•ì¸
                        if (platform.calendar_connected && platform.events_synced) {
                            // ì´ë¯¸ ìº˜ë¦°ë”ê°€ ì—°ê²°ë˜ê³  ì´ë²¤íŠ¸ê°€ ë™ê¸°í™”ëœ ê²½ìš° - ì—°ê²°í•´ì œ ë²„íŠ¼ë§Œ í‘œì‹œ
                            actionButton.textContent = 'ì—°ê²°í•´ì œ';
                            actionButton.className = 'btn-warning-small';
                            actionButton.onclick = () => disconnectPlatform(platformName);
                        } else {
                            // ì•„ì§ ìº˜ë¦°ë”ê°€ ì„ íƒë˜ì§€ ì•Šì€ ê²½ìš° - ìº˜ë¦°ë” ì„ íƒ ë²„íŠ¼ê³¼ ì—°ê²°í•´ì œ ë²„íŠ¼ ëª¨ë‘ í‘œì‹œ
                            // ê¸°ì¡´ ë²„íŠ¼ ì»¨í…Œì´ë„ˆê°€ ìˆëŠ”ì§€ í™•ì¸
                            let buttonContainer = platformCard.querySelector('.button-container');
                            if (!buttonContainer) {
                                buttonContainer = document.createElement('div');
                                buttonContainer.className = 'button-container';
                                buttonContainer.style.cssText = 'display: flex; gap: 8px; justify-content: flex-end;';
                                platformCard.appendChild(buttonContainer);
                            }
                            
                            // ìº˜ë¦°ë” ì„ íƒ ë²„íŠ¼ ì¶”ê°€
                            const calendarButton = document.createElement('button');
                            calendarButton.textContent = 'ìº˜ë¦°ë” ì„ íƒ';
                            calendarButton.className = 'btn-primary-small';
                            calendarButton.style.marginRight = '8px';
                            calendarButton.onclick = () => showCalendarSelectionModal();
                            
                            // ì—°ê²°í•´ì œ ë²„íŠ¼
                            actionButton.textContent = 'ì—°ê²°í•´ì œ';
                            actionButton.className = 'btn-warning-small';
                            actionButton.onclick = () => disconnectPlatform(platformName);
                            
                            // ë²„íŠ¼ ì»¨í…Œì´ë„ˆì— ì¶”ê°€
                            buttonContainer.innerHTML = '';
                            buttonContainer.appendChild(calendarButton);
                            buttonContainer.appendChild(actionButton);
                        }
                    } else {
                        actionButton.textContent = 'ì—°ê²°í•´ì œ';
                        actionButton.className = 'btn-warning-small';
                        actionButton.onclick = () => disconnectPlatform(platformName);
                    }
                } else {
                    // ì—°ê²°ë˜ì§€ ì•Šì€ ìƒíƒœ
                    platformCard.className = 'platform-card disconnected';
                    statusElement.innerHTML = '<i class="fas fa-circle"></i> ì—°ê²° ëŠê¹€';
                    statusElement.classList.add('disconnected');
                    actionButton.textContent = 'ì—°ê²°';
                    actionButton.className = 'btn-secondary-small';
                    actionButton.onclick = () => connectPlatform(platformName);
                }
            }
        });
    }
    
    // ê°œë³„ í”Œë«í¼ ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updatePlatformStatus(platformName, status) {
        const platformGrid = document.querySelector('.platform-grid');
        const platformNames = ['notion', 'google', 'apple', 'outlook', 'slack'];
        const platformIndex = platformNames.indexOf(platformName);
        
        if (platformIndex >= 0 && platformGrid.children[platformIndex]) {
            const platformCard = platformGrid.children[platformIndex];
            
            // ì„¤ì •ì— ë”°ë¼ UI ì—…ë°ì´íŠ¸
            setTimeout(() => {
                updateSettingsData(); // ì „ì²´ ë°ì´í„°ë¥¼ ë‹¤ì‹œ ë¡œë“œí•´ì„œ UI ì—…ë°ì´íŠ¸
            }, 100);
        }
    }
    
    // í”Œë«í¼ ì—°ê²° í•¨ìˆ˜
    function connectPlatform(platformName) {
        // OAuth í”Œë«í¼ì˜ ê²½ìš° íŒì—…ìœ¼ë¡œ ì—°ê²°
        const oauthPlatforms = ['notion', 'google', 'outlook', 'slack'];
        if (oauthPlatforms.includes(platformName)) {
            const popup = window.open(
                `/oauth/${platformName}/authorize`,
                `oauth_${platformName}`,
                'width=500,height=700,left=' + ((screen.width - 500) / 2) + ',top=' + ((screen.height - 700) / 2) + ',scrollbars=yes,resizable=yes'
            );
            
            if (!popup) {
                showNotification('íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. íŒì—…ì„ í—ˆìš©í•´ì£¼ì„¸ìš”.', 'error');
            }
        } else {
            showNotification(`${platformName} ì—°ê²° ê¸°ëŠ¥ì´ ê³§ ì œê³µë©ë‹ˆë‹¤.`, 'info');
        }
    }
    
    // í”Œë«í¼ ì—°ê²°í•´ì œ í•¨ìˆ˜  
    function disconnectPlatform(platformName) {
        // Notionì˜ ê²½ìš° íŠ¹ë³„ ì²˜ë¦¬: OAuth ìœ ì§€í•˜ê³  ìº˜ë¦°ë” ì„ íƒë§Œ ì¬ì„¤ì •
        if (platformName === 'notion') {
            if (confirm('ìº˜ë¦°ë” ì—°ë™ì„ í•´ì œí•˜ê³  ë‹¤ì‹œ ì„ íƒí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (Notion ì—°ê²°ì€ ìœ ì§€ë©ë‹ˆë‹¤)')) {
                // ìº˜ë¦°ë” ì„ íƒ ìƒíƒœë§Œ ì´ˆê¸°í™”
                console.log('ğŸ”„ [DISCONNECT] Starting Notion calendar reset...');
                fetch('/oauth/notion/reset-calendar', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => {
                    console.log('ğŸ“¡ [DISCONNECT] API Response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('ğŸ“Š [DISCONNECT] API Response data:', data);
                    if (data.success) {
                        showNotification('ìº˜ë¦°ë” ì—°ë™ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤. ìƒˆë¡œìš´ ìº˜ë¦°ë”ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'success');
                        
                        // UI ìƒíƒœ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
                        console.log('ğŸ¨ [DISCONNECT] Updating UI to disconnected state...');
                        updatePlatformStatus('notion', 'disconnected');
                        
                        // ìº˜ë¦°ë” ì„ íƒ ëª¨ë‹¬ í‘œì‹œ
                        setTimeout(() => {
                            console.log('ğŸ“… [DISCONNECT] Showing calendar selection modal...');
                            showCalendarSelectionModal();
                        }, 1000);
                    } else {
                        console.error('âŒ [DISCONNECT] Reset failed:', data.error);
                        showNotification(`ì—°ë™ í•´ì œ ì‹¤íŒ¨: ${data.error}`, 'error');
                    }
                })
                .catch(error => {
                    console.error('âŒ [DISCONNECT] Reset calendar error:', error);
                    showNotification('ìº˜ë¦°ë” ì—°ë™ í•´ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                });
            }
        } else {
            // ë‹¤ë¥¸ í”Œë«í¼ì€ ê¸°ì¡´ ë¡œì§ ì‚¬ìš©
            if (confirm(`${platformName} ì—°ê²°ì„ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                // ì—°ê²°í•´ì œ API í˜¸ì¶œ
                fetch(`/oauth/disconnect/${platformName}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification(`${platformName} ì—°ê²°ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
                        // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ìœ¼ë¡œ ìƒíƒœ ì—…ë°ì´íŠ¸
                        setTimeout(() => window.location.reload(), 1000);
                    } else {
                        showNotification(`ì—°ê²°í•´ì œ ì‹¤íŒ¨: ${data.error}`, 'error');
                    }
                })
                .catch(error => {
                    console.error('Disconnect error:', error);
                    showNotification('ì—°ê²°í•´ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                });
            }
        }
    }

    // í™œë™ ë¡œê·¸ ì—…ë°ì´íŠ¸
    function updateActivityLog(activities) {
        const activityList = document.querySelector('.activity-list');
        if (!activities || activities.length === 0) {
            // í™œë™ì´ ì—†ìœ¼ë©´ "í™œë™ ì—†ìŒ" ë©”ì‹œì§€ í‘œì‹œ
            activityList.innerHTML = `
                <div class="activity-item">
                    <div class="activity-icon neutral">
                        <i class="fas fa-info"></i>
                    </div>
                    <div class="activity-content">
                        <div class="activity-title">í™œë™ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>
                        <div class="activity-meta">
                            <span class="activity-time">-</span>
                            <span class="activity-platform">System</span>
                        </div>
                    </div>
                    <div class="activity-status neutral">ëŒ€ê¸°ì¤‘</div>
                </div>
            `;
            return;
        }
        
        activityList.innerHTML = ''; // ê¸°ì¡´ ë‚´ìš© í´ë¦¬ì–´
        
        activities.slice(0, 4).forEach(activity => {
            const activityItem = document.createElement('div');
            activityItem.className = 'activity-item';
            
            // í™œë™ íƒ€ì…ì— ë”°ë¥¸ ì œëª© ìƒì„±
            let activityTitle = activity.description || getActivityTitle(activity.event_type, activity.platform);
            
            // ìƒíƒœì— ë”°ë¥¸ í´ë˜ìŠ¤ ë° ì•„ì´ì½˜ ì„¤ì •
            const statusClass = getStatusClass(activity.status);
            const statusIcon = getStatusIcon(activity.status);
            const statusText = getStatusText(activity.status);
            
            activityItem.innerHTML = `
                <div class="activity-icon ${statusClass}">
                    <i class="fas ${statusIcon}"></i>
                </div>
                <div class="activity-content">
                    <div class="activity-title">${activityTitle}</div>
                    <div class="activity-meta">
                        <span class="activity-time">${formatTimeAgo(activity.created_at)}</span>
                        <span class="activity-platform">${getPlatformDisplayName(activity.platform)}</span>
                    </div>
                </div>
                <div class="activity-status ${statusClass}">${statusText}</div>
            `;
            
            activityList.appendChild(activityItem);
        });
    }

    // í™œë™ ì œëª© ìƒì„±
    function getActivityTitle(eventType, platform) {
        const platformName = getPlatformDisplayName(platform);
        
        switch (eventType) {
            case 'sync_started':
                return `${platformName} ë™ê¸°í™” ì‹œì‘`;
            case 'sync_completed':
                return `${platformName} ë™ê¸°í™” ì™„ë£Œ`;
            case 'sync_failed':
                return `${platformName} ë™ê¸°í™” ì‹¤íŒ¨`;
            case 'connection_established':
                return `${platformName} ì—°ê²° ì™„ë£Œ`;
            case 'connection_failed':
                return `${platformName} ì—°ê²° ì‹¤íŒ¨`;
            case 'data_imported':
                return `${platformName} ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ`;
            case 'backup_created':
                return `${platformName} ë°±ì—… ìƒì„±`;
            default:
                return `${platformName} í™œë™`;
        }
    }

    // í”Œë«í¼ í‘œì‹œëª… ë°˜í™˜
    function getPlatformDisplayName(platform) {
        const platformNames = {
            'notion': 'Notion',
            'google': 'Google Calendar',
            'apple': 'Apple Calendar',
            'outlook': 'Outlook',
            'slack': 'Slack',
            'system': 'System'
        };
        return platformNames[platform] || platform || 'Unknown';
    }

    // ìƒíƒœ í´ë˜ìŠ¤ ë°˜í™˜
    function getStatusClass(status) {
        switch (status) {
            case 'success':
            case 'completed':
                return 'success';
            case 'error':
            case 'failed':
                return 'error';
            case 'warning':
            case 'partial':
                return 'warning';
            default:
                return 'neutral';
        }
    }

    // ìƒíƒœ ì•„ì´ì½˜ ë°˜í™˜
    function getStatusIcon(status) {
        switch (status) {
            case 'success':
            case 'completed':
                return 'fa-check';
            case 'error':
            case 'failed':
                return 'fa-times';
            case 'warning':
            case 'partial':
                return 'fa-exclamation';
            default:
                return 'fa-info';
        }
    }

    // ìƒíƒœ í…ìŠ¤íŠ¸ ë°˜í™˜
    function getStatusText(status) {
        switch (status) {
            case 'success':
            case 'completed':
                return 'ì„±ê³µ';
            case 'error':
            case 'failed':
                return 'ì‹¤íŒ¨';
            case 'warning':
            case 'partial':
                return 'ë¶€ë¶„ ì„±ê³µ';
            default:
                return 'ëŒ€ê¸°ì¤‘';
        }
    }

    // ì‹œê°„ í¬ë§· í•¨ìˆ˜
    function formatTimeAgo(timestamp) {
        if (!timestamp) return '-';
        
        const now = new Date();
        const time = new Date(timestamp);
        const diffMs = now - time;
        const diffMins = Math.floor(diffMs / (1000 * 60));
        const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
        const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
        
        if (diffMins < 1) return 'ë°©ê¸ˆ ì „';
        if (diffMins < 60) return `${diffMins}ë¶„ ì „`;
        if (diffHours < 24) return `${diffHours}ì‹œê°„ ì „`;
        if (diffDays < 7) return `${diffDays}ì¼ ì „`;
        return time.toLocaleDateString('ko-KR');
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ Notion ìº˜ë¦°ë” ì„ íƒ ìƒíƒœ í™•ì¸
    function checkNotionCalendarState() {
        console.log('ğŸ” [PAGE-LOAD] Checking Notion calendar state...');
        fetch('/oauth/notion/calendar-state', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            console.log('ğŸ“Š [PAGE-LOAD] Calendar state response:', data);
            if (data.success && data.needs_calendar_selection) {
                console.log('âœ… [PAGE-LOAD] Notion needs calendar selection - showing modal');
                // í˜ì´ì§€ ë¡œë“œ í›„ ì ì‹œ í›„ì— ëª¨ë‹¬ í‘œì‹œ
                setTimeout(() => {
                    showCalendarSelectionModal();
                }, 2000);
            } else if (data.success) {
                console.log('ğŸŸ¢ [PAGE-LOAD] Notion calendar state normal - no action needed');
            }
        })
        .catch(error => {
            console.error('âŒ [PAGE-LOAD] Failed to check Notion calendar state:', error);
        });
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°ì´í„° ì—…ë°ì´íŠ¸
    document.addEventListener('DOMContentLoaded', function() {
        // ì°¨íŠ¸ë¥¼ ì „ì—­ ë³€ìˆ˜ë¡œ ì €ì¥
        window.weeklyChart = weeklyChart;
        
        // ì‹¤ì œ ë°ì´í„° ë¡œë“œ
        updateSettingsData();
        
        // Notion ìº˜ë¦°ë” ì„ íƒ ìƒíƒœ í™•ì¸
        console.log('ğŸš€ [PAGE-LOAD] Starting page load sequence...');
        checkNotionCalendarState();
        
        // 30ì´ˆë§ˆë‹¤ ë°ì´í„° ì—…ë°ì´íŠ¸
        setInterval(updateSettingsData, 30000);
    });

    // Initialize light theme
    document.documentElement.setAttribute('data-theme', 'light');

    // OAuth ì„±ê³µ ë©”ì‹œì§€ ë¦¬ìŠ¤ë„ˆ - Notion ì—°ê²° í›„ ìº˜ë¦°ë”ë¡œ ìë™ ì´ë™
    window.addEventListener('message', function(event) {
        if (event.data && event.data.type === 'oauth_success') {
            console.log('OAuth success received:', event.data);
            
            // ì„±ê³µ ì•Œë¦¼ í‘œì‹œ
            showNotification(
                `${event.data.platform.charAt(0).toUpperCase() + event.data.platform.slice(1)} ì—°ê²° ì™„ë£Œ!`, 
                'success'
            );
            
            // Notion ì—°ê²° ì™„ë£Œ í›„ ìº˜ë¦°ë” ì„ íƒ UI í‘œì‹œ ë˜ëŠ” í˜ì´ì§€ ì´ë™
            if (event.data.platform === 'notion') {
                if (event.data.redirect_to_calendar) {
                    setTimeout(() => {
                        console.log('Redirecting to calendar after Notion sync...');
                        window.location.href = '/calendar';
                    }, 1500);
                } else {
                    // ìº˜ë¦°ë” ì„ íƒ UI í‘œì‹œ
                    setTimeout(() => {
                        showCalendarSelectionModal();
                    }, 1000);
                }
            } else {
                // ë‹¤ë¥¸ í”Œë«í¼ì´ê±°ë‚˜ ë™ê¸°í™”í•  ë°ì´í„°ê°€ ì—†ìœ¼ë©´ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            }
        }
    });

    // ì•Œë¦¼ í‘œì‹œ í•¨ìˆ˜
    function showNotification(message, type = 'info') {
        // ê¸°ì¡´ ì•Œë¦¼ ì œê±°
        const existingNotification = document.querySelector('.oauth-notification');
        if (existingNotification) {
            existingNotification.remove();
        }

        // ìƒˆ ì•Œë¦¼ ìƒì„±
        const notification = document.createElement('div');
        notification.className = `oauth-notification ${type}`;
        notification.innerHTML = `
            <div class="notification-content">
                <i class="fas fa-check-circle"></i>
                <span>${message}</span>
            </div>
        `;
        
        // ìŠ¤íƒ€ì¼ ì¶”ê°€
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${type === 'success' ? '#10B981' : '#3B82F6'};
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 10000;
            animation: slideIn 0.3s ease;
        `;
        
        document.body.appendChild(notification);
        
        // 3ì´ˆ í›„ ì œê±°
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 3000);
    }

    // ì•Œë¦¼ ì• ë‹ˆë©”ì´ì…˜ CSS ì¶”ê°€
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .oauth-notification .notification-content {
            display: flex;
            align-items: center;
            gap: 8px;
        }
    `;
    document.head.appendChild(style);

    // ìº˜ë¦°ë” ì„ íƒ ëª¨ë‹¬ í‘œì‹œ í•¨ìˆ˜
    function showCalendarSelectionModal() {
        // ê¸°ì¡´ ëª¨ë‹¬ì´ ìˆìœ¼ë©´ ì œê±°
        const existingModal = document.getElementById('calendar-selection-modal');
        if (existingModal) {
            existingModal.remove();
        }

        // ëª¨ë‹¬ HTML ìƒì„±
        const modalHTML = `
            <div id="calendar-selection-modal" style="
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10001;
            ">
                <div style="
                    background: white;
                    border-radius: 12px;
                    padding: 24px;
                    max-width: 500px;
                    width: 90%;
                    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
                ">
                    <h3 style="margin: 0 0 16px 0; color: #333; font-size: 20px;">
                        ğŸ“… Notion ìº˜ë¦°ë” ì—°ë™ ì„¤ì •
                    </h3>
                    <p style="margin: 0 0 20px 0; color: #666; line-height: 1.5;">
                        Notion ì—°ê²°ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ì´ë²¤íŠ¸ë¥¼ ë™ê¸°í™”í•  ìº˜ë¦°ë”ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.
                    </p>
                    
                    <div id="calendar-list" style="margin-bottom: 20px;">
                        <div class="loading-spinner" style="text-align: center; padding: 20px;">
                            ğŸ”„ ìº˜ë¦°ë” ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 12px; justify-content: flex-end;">
                        <button onclick="closeCalendarModal()" style="
                            background: #f5f5f5;
                            border: none;
                            padding: 10px 20px;
                            border-radius: 6px;
                            cursor: pointer;
                            color: #666;
                        ">ë‚˜ì¤‘ì—</button>
                        <button id="sync-button" onclick="startNotionSync()" disabled style="
                            background: #3b82f6;
                            border: none;
                            padding: 10px 20px;
                            border-radius: 6px;
                            color: white;
                            cursor: not-allowed;
                            opacity: 0.5;
                        ">ë™ê¸°í™” ì‹œì‘</button>
                    </div>
                </div>
            </div>
        `;

        // ëª¨ë‹¬ì„ bodyì— ì¶”ê°€
        document.body.insertAdjacentHTML('beforeend', modalHTML);

        // ìº˜ë¦°ë” ëª©ë¡ ë¡œë“œ
        loadUserCalendars();
    }

    // ìº˜ë¦°ë” ëª©ë¡ ë¡œë“œ
    async function loadUserCalendars() {
        try {
            const response = await fetch('/api/calendars');
            const result = await response.json();
            
            const calendarList = document.getElementById('calendar-list');
            if (!calendarList) return;

            if (result.success && result.calendars && result.calendars.length > 0) {
                let calendarsHTML = '<div style="margin-bottom: 12px; font-weight: 600; color: #333;">ìº˜ë¦°ë” ì„ íƒ:</div>';
                
                result.calendars.forEach((calendar, index) => {
                    calendarsHTML += `
                        <label style="
                            display: block;
                            padding: 12px;
                            border: 2px solid #e5e5e5;
                            border-radius: 8px;
                            margin-bottom: 8px;
                            cursor: pointer;
                            transition: all 0.2s;
                        " onmouseover="this.style.borderColor='#3b82f6'" onmouseout="this.style.borderColor='#e5e5e5'">
                            <input type="radio" name="selected-calendar" value="${calendar.id}" 
                                   onchange="selectCalendar('${calendar.id}')" 
                                   ${index === 0 ? 'checked' : ''} 
                                   style="margin-right: 8px;">
                            <span style="font-weight: 500; color: #333;">${calendar.name}</span>
                            ${calendar.description ? `<div style="font-size: 12px; color: #666; margin-top: 4px;">${calendar.description}</div>` : ''}
                        </label>
                    `;
                });
                
                calendarList.innerHTML = calendarsHTML;
                
                // ì²« ë²ˆì§¸ ìº˜ë¦°ë”ê°€ ê¸°ë³¸ ì„ íƒë˜ì–´ ìˆìœ¼ë¯€ë¡œ ë™ê¸°í™” ë²„íŠ¼ í™œì„±í™”
                if (result.calendars.length > 0) {
                    selectCalendar(result.calendars[0].id);
                }
            } else {
                calendarList.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #666;">
                        ìº˜ë¦°ë”ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ìº˜ë¦°ë”ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.
                    </div>
                `;
            }
        } catch (error) {
            console.error('Failed to load calendars:', error);
            const calendarList = document.getElementById('calendar-list');
            if (calendarList) {
                calendarList.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #e74c3c;">
                        ìº˜ë¦°ë” ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.
                    </div>
                `;
            }
        }
    }

    // ìº˜ë¦°ë” ì„ íƒ
    function selectCalendar(calendarId) {
        window.selectedCalendarId = calendarId;
        const syncButton = document.getElementById('sync-button');
        if (syncButton) {
            syncButton.disabled = false;
            syncButton.style.cursor = 'pointer';
            syncButton.style.opacity = '1';
        }
    }

    // Notion ë™ê¸°í™” ì‹œì‘
    async function startNotionSync() {
        if (!window.selectedCalendarId) return;

        const syncButton = document.getElementById('sync-button');
        if (syncButton) {
            syncButton.textContent = 'ë™ê¸°í™” ì¤‘...';
            syncButton.disabled = true;
            syncButton.style.opacity = '0.7';
        }

        try {
            // ë¨¼ì € ìº˜ë¦°ë” ì—°ê²°
            const connectResponse = await fetch('/api/notion/connect-calendar', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    calendar_id: window.selectedCalendarId
                })
            });

            const connectResult = await connectResponse.json();
            
            if (connectResult.success) {
                // localStorage í”Œë˜ê·¸ ì œê±°
                if (connectResult.clear_disconnected_flag) {
                    localStorage.removeItem('notion_manually_disconnected');
                    console.log('ğŸ§¹ [CONNECT] Cleared notion_manually_disconnected flag');
                }
                
                // ë™ê¸°í™” ì‹œì‘
                const syncResponse = await fetch('/api/sync/notion', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        calendar_id: window.selectedCalendarId
                    })
                });

                const syncResult = await syncResponse.json();
                
                if (syncResult.success) {
                    showNotification(`âœ… ìº˜ë¦°ë” ì—°ê²° ë° ${syncResult.synced_events || 0}ê°œì˜ ì´ë²¤íŠ¸ê°€ ë™ê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤!`, 'success');
                    closeCalendarModal();
                    
                    // í”Œë«í¼ ìƒíƒœ ì—…ë°ì´íŠ¸
                    updatePlatformStatus('notion', 'connected');
                    
                    // ìº˜ë¦°ë” í˜ì´ì§€ë¡œ ì´ë™
                    setTimeout(() => {
                        window.location.href = '/calendar';
                    }, 1500);
                } else {
                    showNotification(`âœ… ìº˜ë¦°ë” ì—°ê²° ì™„ë£Œ, âš ï¸ ë™ê¸°í™” ê²½ê³ : ${syncResult.error}`, 'warning');
                    closeCalendarModal();
                    updatePlatformStatus('notion', 'connected');
                }
            } else {
                showNotification(`âŒ ìº˜ë¦°ë” ì—°ê²° ì‹¤íŒ¨: ${connectResult.error}`, 'error');
            }
        } catch (error) {
            console.error('Sync failed:', error);
            showNotification('âŒ ë™ê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        }

        if (syncButton) {
            syncButton.textContent = 'ë™ê¸°í™” ì‹œì‘';
            syncButton.disabled = false;
            syncButton.style.opacity = '1';
        }
    }

    // ëª¨ë‹¬ ë‹«ê¸°
    function closeCalendarModal() {
        const modal = document.getElementById('calendar-selection-modal');
        if (modal) {
            modal.remove();
        }
    }
</script>
{% endblock %}