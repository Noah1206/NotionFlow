{% extends "base_dashboard.html" %}

{% block title %}API Keys - NotionFlow{% endblock %}

{% block extra_css %}
<link rel="stylesheet"
    href="{{ url_for('static', filename='css/api-keys-redesign.css') }}?v={{ range(100000, 999999) | random }}">
<link rel="stylesheet"
    href="{{ url_for('static', filename='css/unified-sync-modal.css') }}?v={{ range(100000, 999999) | random }}">
{% endblock %}

{% block content %}
<!-- API í‚¤ ê´€ë¦¬ ë©”ì¸ ì»¨í…Œì´ë„ˆ -->
<div class="api-container">

    <!-- í—¤ë” ì„¹ì…˜ -->
    <div class="api-header-container">
        <div class="api-header">
            <div class="api-title-section">
                <h1 class="api-main-title">ğŸ”‘ API í‚¤ ê´€ë¦¬</h1>
                <p class="api-subtitle">í”Œë«í¼ê³¼ ì•ˆì „í•˜ê²Œ ì—°ê²°í•˜ê³  ìº˜ë¦°ë”ë¥¼ ë™ê¸°í™”í•˜ì„¸ìš”</p>
            </div>
        </div>
    </div>

    <!-- ìº˜ë¦°ë” ìƒì„± ì•ˆë‚´ ì„¹ì…˜ -->
    <div class="calendar-setup-guide" id="calendar-setup-guide">
        <div class="guide-card">
            <div class="guide-content">
                <h3 class="guide-title">ğŸ¯ ì‹œì‘í•˜ê¸° ì „ì—</h3>
                <p class="guide-description">
                    í”Œë«í¼ì„ ì—°ê²°í•˜ê¸° ì „ì— ë¨¼ì € <strong>ìº˜ë¦°ë”ë¥¼ ìƒì„±</strong>í•´ì•¼ í•©ë‹ˆë‹¤.<br>
                    ìº˜ë¦°ë”ê°€ ìˆì–´ì•¼ ê° í”Œë«í¼ì˜ ì´ë²¤íŠ¸ë¥¼ ë™ê¸°í™”í•  ìˆ˜ ìˆì–´ìš”!
                </p>
                <div class="guide-steps">
                    <div class="step-item">
                        <span class="step-number">1</span>
                        <span class="step-text">ìº˜ë¦°ë” ìƒì„±í•˜ê¸°</span>
                    </div>
                    <div class="step-item">
                        <span class="step-number">2</span>
                        <span class="step-text">í”Œë«í¼ ì—°ê²°í•˜ê¸°</span>
                    </div>
                    <div class="step-item">
                        <span class="step-number">3</span>
                        <span class="step-text">ìë™ ë™ê¸°í™” ì‹œì‘</span>
                    </div>
                </div>
                <div class="guide-actions">
                    <a href="/calendar" class="guide-btn primary">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path
                                d="M8 2v4M16 2v4M3 10h18M5 4h14a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2z" />
                        </svg>
                        ìº˜ë¦°ë” ìƒì„±í•˜ê¸°
                    </a>
                    <button class="guide-btn secondary" onclick="hideCalendarGuide()">
                        ë‚˜ì¤‘ì— í•˜ê¸°
                    </button>
                </div>
            </div>
            <button class="guide-close" onclick="hideCalendarGuide()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6l-12 12M6 6l12 12" />
                </svg>
            </button>
        </div>
    </div>

    <!-- í”Œë«í¼ ì—°ê²° ì„¹ì…˜ -->
    <div class="platforms-section">

        <!-- Notion ì—°ê²° ì¹´ë“œ -->
        <div class="platform-card" data-platform="notion">
            <div class="platform-header">
                <div class="platform-info">
                    <div class="platform-icon notion">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M4.459 4.208c.746.606 1.026.56 2.428.466l13.215-.793c.28 0 .047-.28-.046-.326L17.86 1.968c-.42-.326-.981-.7-2.055-.607L3.01 2.295c-.466.046-.56.28-.374.466zm.793 3.08v13.904c0 .747.373 1.027 1.214.98l14.523-.84c.841-.046 1.121-.56 1.121-1.167V6.354c0-.606-.233-.933-.747-.887l-15.177.887c-.56.047-.934.373-.934 1.027zm13.748.327c.093.42 0 .84-.42.888l-.7.14v10.264c-.608.327-1.168.514-1.635.514-.748 0-.935-.234-1.495-.933l-4.577-7.186v6.952L12.21 19s0 .84-1.168.84l-3.222.186c-.093-.186 0-.653.327-.746l.84-.233V9.854L7.822 9.76c-.094-.42.14-1.026.793-1.073l3.456-.233 4.764 7.279v-6.44l-1.215-.139c-.093-.514.28-.887.747-.933z" />
                        </svg>
                    </div>
                    <div class="platform-details">
                        <h3 class="platform-name">Notion</h3>
                        <div class="platform-status disconnected">
                            <span class="status-dot"></span>
                            ì—°ê²°ë˜ì§€ ì•ŠìŒ
                        </div>
                    </div>
                </div>
                <div class="platform-actions">
                    <button class="one-click-btn-small" onclick="oneClickConnect('notion')" data-platform="notion">
                        <span class="btn-text">ì›í´ë¦­</span>
                        <div class="btn-loader" style="display: none;">
                            <div class="loader-spinner"></div>
                        </div>
                    </button>
                    <button class="platform-sync-btn" onclick="openCalendarSyncModal('notion')" data-platform="notion"
                        style="display: none;">
                        <span class="sync-text">ìº˜ë¦°ë” ì—°ë™</span>
                        <div class="sync-loader" style="display: none;">
                            <div class="loader-dot"></div>
                        </div>
                    </button>
                    <button class="platform-connect-btn" onclick="connectPlatform('notion')" data-platform="notion">
                        <span class="connect-text">ì—°ê²°í•˜ê¸°</span>
                        <div class="connect-loader" style="display: none;">
                            <div class="loader-dot"></div>
                        </div>
                    </button>
                    <button class="platform-expand-btn" onclick="togglePlatformDetails('notion')">
                        <svg class="expand-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M6 9l6 6 6-6" />
                        </svg>
                    </button>
                </div>
            </div>

            <!-- ì—°ê²° ìƒì„¸ í¼ -->
            <div class="platform-details-form" id="notion-details" style="display: none;">
                <div class="form-group">
                    <label for="notion-token">Internal Integration Token</label>
                    <input type="password" id="notion-token" name="notion-token" placeholder="secret_ìœ¼ë¡œ ì‹œì‘í•˜ëŠ” í† í°ì„ ì…ë ¥í•˜ì„¸ìš”">
                    <small class="form-help">
                        <a href="https://www.notion.so/my-integrations" target="_blank" class="help-link">
                            ğŸ“– í† í° ë°œê¸‰ë°›ê¸°
                        </a>
                        | í˜ì´ì§€ ì ‘ê·¼ ê¶Œí•œ í•„ìš”
                    </small>
                </div>
                <div class="form-actions">
                    <button class="btn btn-secondary" onclick="togglePlatformDetails('notion')">ì·¨ì†Œ</button>
                    <button class="btn btn-primary" onclick="connectPlatform('notion')">
                        <span class="loading-spinner" style="display: none;"></span>
                        ì—°ê²°í•˜ê¸°
                    </button>
                </div>
            </div>
        </div>

        <!-- Google Calendar ì—°ê²° ì¹´ë“œ -->
        <div class="platform-card" data-platform="google">
            <div class="platform-header">
                <div class="platform-info">
                    <div class="platform-icon google">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z" />
                        </svg>
                    </div>
                    <div class="platform-details">
                        <h3 class="platform-name">Google Calendar</h3>
                        <div class="platform-status disconnected">
                            <span class="status-dot"></span>
                            ì—°ê²°ë˜ì§€ ì•ŠìŒ
                        </div>
                    </div>
                </div>
                <div class="platform-actions">
                    <button class="one-click-btn-small" onclick="oneClickConnect('google')" data-platform="google">
                        <span class="btn-text">ì›í´ë¦­</span>
                        <div class="btn-loader" style="display: none;">
                            <div class="loader-spinner"></div>
                        </div>
                    </button>
                    <button class="platform-sync-btn" onclick="syncGoogleCalendar()" data-platform="google"
                        style="display: none;">
                        <span class="sync-text">ìº˜ë¦°ë” ë™ê¸°í™”</span>
                        <div class="sync-loader" style="display: none;">
                            <div class="loader-dot"></div>
                        </div>
                    </button>
                    <button class="platform-connect-btn" onclick="connectPlatform('google')" data-platform="google">
                        <span class="connect-text">ì—°ê²°í•˜ê¸°</span>
                        <div class="connect-loader" style="display: none;">
                            <div class="loader-dot"></div>
                        </div>
                    </button>
                </div>
            </div>
        </div>

        <!-- Apple Calendar ì—°ê²° ì¹´ë“œ -->
        <div class="platform-card" data-platform="apple">
            <div class="platform-header">
                <div class="platform-info">
                    <div class="platform-icon apple">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M19.5 4h-1.44a2.04 2.04 0 0 0-1.98 1.22l-1.58 4.49c-.25.7-.91 1.16-1.65 1.16-.73 0-1.39-.46-1.64-1.16l-1.58-4.49A2.04 2.04 0 0 0 7.62 4H6.5C5.67 4 5 4.67 5 5.5S5.67 7 6.5 7h1.12c.14 0 .27.09.32.22l1.58 4.49c.5 1.4 1.82 2.29 3.31 2.29s2.81-.89 3.31-2.29L17.72 7.22c.05-.13.18-.22.32-.22H19.5c.83 0 1.5-.67 1.5-1.5S20.33 4 19.5 4z" />
                        </svg>
                    </div>
                    <div class="platform-details">
                        <h3 class="platform-name">Apple Calendar</h3>
                        <div class="platform-status disconnected">
                            <span class="status-dot"></span>
                            ì—°ê²°ë˜ì§€ ì•ŠìŒ
                        </div>
                    </div>
                </div>
                <div class="platform-actions">
                    <button class="platform-sync-btn" onclick="openCalendarSyncModal('apple')" data-platform="apple"
                        style="display: none;">
                        <span class="sync-text">ìº˜ë¦°ë” ì—°ë™</span>
                        <div class="sync-loader" style="display: none;">
                            <div class="loader-dot"></div>
                        </div>
                    </button>
                    <button class="platform-connect-btn" onclick="connectPlatform('apple')" data-platform="apple">
                        <span class="connect-text">ì—°ê²°í•˜ê¸°</span>
                        <div class="connect-loader" style="display: none;">
                            <div class="loader-dot"></div>
                        </div>
                    </button>
                    <button class="platform-expand-btn" onclick="togglePlatformDetails('apple')">
                        <svg class="expand-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M6 9l6 6 6-6" />
                        </svg>
                    </button>
                </div>
            </div>

            <!-- ì—°ê²° ìƒì„¸ í¼ -->
            <div class="platform-details-form" id="apple-details" style="display: none;">
                <div class="form-group">
                    <label for="apple-username">Apple ID</label>
                    <input type="email" id="apple-username" name="apple-username"
                        placeholder="your-apple-id@icloud.com">
                </div>
                <div class="form-group">
                    <label for="apple-password">ì•± ì „ìš© ì•”í˜¸</label>
                    <input type="password" id="apple-password" name="apple-password" placeholder="ì•± ì „ìš© ì•”í˜¸">
                    <small class="form-help">
                        <a href="https://support.apple.com/en-us/HT204397" target="_blank" class="help-link">
                            ğŸ“– ì•± ì „ìš© ì•”í˜¸ ë§Œë“¤ê¸°
                        </a>
                        | 2ë‹¨ê³„ ì¸ì¦ í•„ìš”
                    </small>
                </div>
                <div class="form-actions">
                    <button class="btn btn-secondary" onclick="togglePlatformDetails('apple')">ì·¨ì†Œ</button>
                    <button class="btn btn-primary" onclick="connectPlatform('apple')">
                        <span class="loading-spinner" style="display: none;"></span>
                        ì—°ê²°í•˜ê¸°
                    </button>
                </div>
            </div>
        </div>

        <!-- Outlook ì—°ê²° ì¹´ë“œ -->
        <div class="platform-card" data-platform="outlook">
            <div class="platform-header">
                <div class="platform-info">
                    <div class="platform-icon outlook">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M7.88 12.04q0 .45-.11.87-.1.41-.33.74-.22.33-.58.52-.37.2-.87.2-.51 0-.87-.2-.37-.19-.59-.52-.21-.33-.32-.74-.1-.42-.1-.87 0-.44.1-.86.11-.41.32-.73.22-.33.59-.52.36-.2.87-.2.5 0 .87.2.36.19.58.52.23.32.33.73.11.42.11.86zM21.5 4v16q0 .41-.3.7-.29.3-.7.3H3.5q-.41 0-.7-.3-.3-.29-.3-.7V4q0-.41.3-.7Q2.79 3 3.2 3h17.6q.41 0 .7.29.3.29.3.71zM8.5 13.5H7.25v.75H8.5v-.75zm0-3H7.25V11H8.5v-.5zM12 7.98H9v8h3V7.98zm6.5 2.53-2.25 2.02 2.25 2.05V10.51z" />
                        </svg>
                    </div>
                    <div class="platform-details">
                        <h3 class="platform-name">Outlook</h3>
                        <div class="platform-status disconnected">
                            <span class="status-dot"></span>
                            ì—°ê²°ë˜ì§€ ì•ŠìŒ
                        </div>
                    </div>
                </div>
                <div class="platform-actions">
                    <button class="platform-sync-btn" onclick="openCalendarSyncModal('outlook')" data-platform="outlook"
                        style="display: none;">
                        <span class="sync-text">ìº˜ë¦°ë” ì—°ë™</span>
                        <div class="sync-loader" style="display: none;">
                            <div class="loader-dot"></div>
                        </div>
                    </button>
                    <button class="one-click-btn-small" onclick="oneClickConnect('outlook')" data-platform="outlook">
                        <span class="btn-text">ì›í´ë¦­</span>
                        <div class="btn-loader" style="display: none;">
                            <div class="loader-spinner"></div>
                        </div>
                    </button>
                    <button class="platform-connect-btn" onclick="connectPlatform('outlook')" data-platform="outlook">
                        <span class="connect-text">ì—°ê²°í•˜ê¸°</span>
                        <div class="connect-loader" style="display: none;">
                            <div class="loader-dot"></div>
                        </div>
                    </button>
                    <button class="platform-expand-btn" onclick="togglePlatformDetails('outlook')">
                        <svg class="expand-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M6 9l6 6 6-6" />
                        </svg>
                    </button>
                </div>
            </div>

            <!-- ì—°ê²° ìƒì„¸ í¼ -->
            <div class="platform-details-form" id="outlook-details" style="display: none;">
                <div class="form-group">
                    <label for="outlook-email">Microsoft ê³„ì •</label>
                    <input type="email" id="outlook-email" name="outlook-email" placeholder="your-email@outlook.com">
                </div>
                <div class="form-group">
                    <label for="outlook-client-id">í´ë¼ì´ì–¸íŠ¸ ID</label>
                    <input type="text" id="outlook-client-id" name="outlook-client-id"
                        placeholder="Azure ì•± ë“±ë¡ì—ì„œ ë°œê¸‰ë°›ì€ í´ë¼ì´ì–¸íŠ¸ ID">
                    <small class="form-help">
                        <a href="https://portal.azure.com/" target="_blank" class="help-link">
                            ğŸ“– Azure Portalì—ì„œ ì•± ë“±ë¡í•˜ê¸°
                        </a>
                        | Graph API ê¶Œí•œ í•„ìš”
                    </small>
                </div>
                <div class="form-actions">
                    <button class="btn btn-secondary" onclick="togglePlatformDetails('outlook')">ì·¨ì†Œ</button>
                    <button class="btn btn-primary" onclick="connectPlatform('outlook')">
                        <span class="loading-spinner" style="display: none;"></span>
                        ì—°ê²°í•˜ê¸°
                    </button>
                </div>
            </div>
        </div>

        <!-- Slack ì—°ê²° ì¹´ë“œ -->
        <div class="platform-card" data-platform="slack">
            <div class="platform-header">
                <div class="platform-info">
                    <div class="platform-icon slack">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M5.042 15.165a2.528 2.528 0 0 1-2.52 2.523A2.528 2.528 0 0 1 0 15.165a2.527 2.527 0 0 1 2.522-2.52h2.52v2.52zM6.313 15.165a2.527 2.527 0 0 1 2.521-2.52 2.527 2.527 0 0 1 2.521 2.52v6.313A2.528 2.528 0 0 1 8.834 24a2.528 2.528 0 0 1-2.521-2.522v-6.313zM8.834 5.042a2.528 2.528 0 0 1-2.521-2.52A2.528 2.528 0 0 1 8.834 0a2.528 2.528 0 0 1 2.521 2.522v2.52H8.834zM8.834 6.313a2.528 2.528 0 0 1 2.521 2.521 2.528 2.528 0 0 1-2.521 2.521H2.522A2.528 2.528 0 0 1 0 8.834a2.528 2.528 0 0 1 2.522-2.521h6.312zM18.956 8.834a2.528 2.528 0 0 1 2.521-2.521A2.528 2.528 0 0 1 24 8.834a2.528 2.528 0 0 1-2.523 2.521h-2.521V8.834zM17.688 8.834a2.528 2.528 0 0 1-2.523 2.521 2.527 2.527 0 0 1-2.52-2.521V2.522A2.527 2.527 0 0 1 15.165 0a2.528 2.528 0 0 1 2.523 2.522v6.312zM15.165 18.956a2.528 2.528 0 0 1 2.523 2.521A2.528 2.528 0 0 1 15.165 24a2.527 2.527 0 0 1-2.52-2.523v-2.521h2.52zM15.165 17.688a2.527 2.527 0 0 1-2.52-2.523 2.526 2.526 0 0 1 2.52-2.52h6.313A2.527 2.527 0 0 1 24 15.165a2.528 2.528 0 0 1-2.522 2.523h-6.313z" />
                        </svg>
                    </div>
                    <div class="platform-details">
                        <h3 class="platform-name">Slack</h3>
                        <div class="platform-status disconnected">
                            <span class="status-dot"></span>
                            ì—°ê²°ë˜ì§€ ì•ŠìŒ
                        </div>
                    </div>
                </div>
                <div class="platform-actions">
                    <button class="platform-sync-btn" onclick="openCalendarSyncModal('slack')" data-platform="slack"
                        style="display: none;">
                        <span class="sync-text">ìº˜ë¦°ë” ì—°ë™</span>
                        <div class="sync-loader" style="display: none;">
                            <div class="loader-dot"></div>
                        </div>
                    </button>
                    <button class="one-click-btn-small" onclick="oneClickConnect('slack')" data-platform="slack">
                        <span class="btn-text">ì›í´ë¦­</span>
                        <div class="btn-loader" style="display: none;">
                            <div class="loader-spinner"></div>
                        </div>
                    </button>
                    <button class="platform-connect-btn" onclick="connectPlatform('slack')" data-platform="slack">
                        <span class="connect-text">ì—°ê²°í•˜ê¸°</span>
                        <div class="connect-loader" style="display: none;">
                            <div class="loader-dot"></div>
                        </div>
                    </button>
                    <button class="platform-expand-btn" onclick="togglePlatformDetails('slack')">
                        <svg class="expand-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M6 9l6 6 6-6" />
                        </svg>
                    </button>
                </div>
            </div>

            <!-- ì—°ê²° ìƒì„¸ í¼ -->
            <div class="platform-details-form" id="slack-details" style="display: none;">
                <div class="form-group">
                    <label for="slack-webhook">Webhook URL</label>
                    <input type="url" id="slack-webhook" name="slack-webhook"
                        placeholder="https://hooks.slack.com/services/...">
                    <small class="form-help">
                        <a href="https://api.slack.com/messaging/webhooks" target="_blank" class="help-link">
                            ğŸ“– Slack Webhook ë§Œë“¤ê¸°
                        </a>
                        | ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ê´€ë¦¬ì ê¶Œí•œ í•„ìš”
                    </small>
                </div>
                <div class="form-actions">
                    <button class="btn btn-secondary" onclick="togglePlatformDetails('slack')">ì·¨ì†Œ</button>
                    <button class="btn btn-primary" onclick="connectPlatform('slack')">
                        <span class="loading-spinner" style="display: none;"></span>
                        ì—°ê²°í•˜ê¸°
                    </button>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- ìº˜ë¦°ë” ì„ íƒ ëª¨ë‹¬ -->
<div class="calendar-selection-modal" id="calendar-selection-modal" style="display: none;">
    <div class="modal-overlay" onclick="closeCalendarSelectionModal()"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">ìº˜ë¦°ë” ë³€ê²½</h3>
            <button class="modal-close-btn" onclick="closeCalendarSelectionModal()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6l-12 12M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <p class="modal-description">
                <span id="platform-name-display"></span> ì—°ê²°ì„ ìœ„í•´ ë™ê¸°í™”í•  ìº˜ë¦°ë”ë¥¼ ì„ íƒí•˜ì„¸ìš”.
            </p>
            <div class="calendar-list" id="calendar-list">
                <div class="loading-state">
                    <div class="loading-spinner"></div>
                    <p>ìº˜ë¦°ë” ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="closeCalendarSelectionModal()">ì·¨ì†Œ</button>
            <button class="btn-primary" id="confirm-calendar-selection" onclick="confirmCalendarSelection()" disabled>
                ì„ íƒí•œ ìº˜ë¦°ë”ë¡œ ì—°ê²°
            </button>
        </div>
    </div>
</div>

<!-- ì´ˆê¸° ë°ì´í„° ì„¤ì • ìŠ¤í¬ë¦½íŠ¸ -->
<script>
    // ì„œë²„ì—ì„œ ë Œë”ë§ëœ ë°ì´í„° (ìº˜ë¦°ë”ê°€ ìˆëŠ”ì§€ í™•ì¸)
    const hasCalendar = {{ (stats.connected_count if stats and stats.connected_count else 0) | tojson }} > 0;

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì¦‰ì‹œ ê°€ì´ë“œ ì²˜ë¦¬
    document.addEventListener('DOMContentLoaded', function () {
        const guide = document.getElementById('calendar-setup-guide');
        if (guide) {
            const isHidden = localStorage.getItem('calendar_guide_hidden') === 'true';

            // ìº˜ë¦°ë”ê°€ ìˆê±°ë‚˜ ì‚¬ìš©ìê°€ ì´ë¯¸ ìˆ¨ê¸´ ê²½ìš°
            if (hasCalendar || isHidden) {
                guide.style.display = 'none';
            } else {
                guide.style.display = 'block';
            }
        }
    });
</script>

<style>
    /* ìº˜ë¦°ë” ì„ íƒ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
    .calendar-selection-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 999999;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .modal-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(4px);
    }

    .modal-content {
        position: relative;
        background: #ffffff;
        border-radius: 16px;
        max-width: 600px;
        width: 90%;
        max-height: 80vh;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        overflow: hidden;
    }

    .modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 24px 32px;
        border-bottom: 1px solid #f0f0f0;
    }

    .modal-title {
        font-size: 20px;
        font-weight: 600;
        color: #000000;
        margin: 0;
    }

    .modal-close-btn {
        background: none;
        border: none;
        cursor: pointer;
        padding: 4px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #6b7280;
        transition: all 0.2s ease;
    }

    .modal-close-btn:hover {
        background: #f9fafb;
        color: #000000;
    }

    .modal-body {
        padding: 32px;
        max-height: 400px;
        overflow-y: auto;
    }

    .modal-description {
        font-size: 16px;
        color: #6b7280;
        margin-bottom: 24px;
        line-height: 1.5;
    }

    .calendar-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .calendar-item {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 16px;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        background: #ffffff;
    }

    .calendar-item:hover {
        border-color: #3b82f6;
        background: #f8faff;
    }

    .calendar-item.selected {
        border-color: #3b82f6;
        background: #eff6ff;
    }

    .calendar-radio {
        width: 20px;
        height: 20px;
        border: 2px solid #d1d5db;
        border-radius: 50%;
        position: relative;
        flex-shrink: 0;
    }

    .calendar-item.selected .calendar-radio {
        border-color: #3b82f6;
    }

    .calendar-item.selected .calendar-radio::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 10px;
        height: 10px;
        background: #3b82f6;
        border-radius: 50%;
    }

    .calendar-info {
        flex: 1;
    }

    .calendar-name {
        font-size: 16px;
        font-weight: 500;
        color: #000000;
        margin-bottom: 4px;
    }

    .calendar-description {
        font-size: 14px;
        color: #6b7280;
    }

    .calendar-type {
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 500;
        text-transform: uppercase;
    }

    .calendar-type.primary {
        background: #dbeafe;
        color: #1d4ed8;
    }

    .calendar-type.shared {
        background: #d1fae5;
        color: #047857;
    }

    .calendar-type.personal {
        background: #fef3c7;
        color: #d97706;
    }

    .loading-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 16px;
        padding: 40px 20px;
        color: #6b7280;
    }

    .loading-spinner {
        width: 32px;
        height: 32px;
        border: 3px solid #e5e7eb;
        border-top: 3px solid #3b82f6;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    .modal-footer {
        display: flex;
        gap: 12px;
        padding: 24px 32px;
        border-top: 1px solid #f0f0f0;
        justify-content: flex-end;
    }

    .btn-secondary,
    .btn-primary {
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 15px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        border: none;
        min-width: 120px;
    }

    .btn-secondary {
        background: #ffffff;
        color: #6b7280;
        border: 1px solid #e5e7eb;
    }

    .btn-secondary:hover {
        background: #f9fafb;
        color: #000000;
    }

    .btn-primary {
        background: #3b82f6;
        color: #ffffff;
    }

    .btn-primary:hover:not(:disabled) {
        background: #2563eb;
    }

    .btn-primary:disabled {
        background: #9ca3af;
        cursor: not-allowed;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    /* ìƒˆë¡œìš´ ë²„íŠ¼ ë””ìì¸ ìŠ¤íƒ€ì¼ */
    .one-click-btn-small {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 10px 18px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border-radius: 12px;
        position: relative;
        min-width: 100px;
        justify-content: center;
        background: #3b82f6;
        color: white;
        border: none;
        overflow: hidden;
        letter-spacing: 0.3px;
    }

    .one-click-btn-small::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        opacity: 0;
        transition: opacity 0.3s ease;
        z-index: 0;
    }

    .one-click-btn-small:hover::before {
        opacity: 1;
    }

    .one-click-btn-small:hover {
        transform: translateY(-2px) scale(1.02);
        box-shadow: 0 10px 25px rgba(59, 130, 246, 0.4);
    }

    .one-click-btn-small .btn-icon {
        font-size: 16px;
        position: relative;
        z-index: 1;
    }

    .one-click-btn-small .btn-text {
        position: relative;
        z-index: 1;
    }

    .platform-connect-btn,
    .platform-sync-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 20px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border-radius: 12px;
        position: relative;
        min-width: 110px;
        justify-content: center;
        background: #ffffff;
        color: #1a1a1a;
        border: 2px solid #e5e7eb;
        overflow: hidden;
    }

    .platform-sync-btn {
        background: #3b82f6;
        color: white;
        border: none;
        justify-content: center;
        text-align: center;
    }

    .platform-sync-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);
    }

    .platform-connect-btn::before,
    .platform-sync-btn::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        border-radius: 50%;
        background: #3b82f6;
        transform: translate(-50%, -50%);
        transition: width 0.4s ease, height 0.4s ease;
        z-index: 0;
    }

    .platform-connect-btn:hover::before {
        width: 300px;
        height: 300px;
    }

    .platform-connect-btn:hover {
        color: white;
        border-color: #3b82f6;
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
    }

    .platform-connect-btn .connect-text {
        position: relative;
        z-index: 1;
        transition: color 0.3s ease;
    }

    .platform-connect-btn:hover .connect-text {
        color: white;
    }

    .platform-disconnect-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 20px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border-radius: 12px;
        position: relative;
        min-width: 110px;
        justify-content: center;
        background: linear-gradient(135deg, #ff6b6b 0%, #ff8787 100%);
        color: white;
        border: none;
    }

    .platform-disconnect-btn:hover {
        background: linear-gradient(135deg, #ff5252 0%, #ff6b6b 100%);
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(255, 107, 107, 0.3);
    }

    /* Google Calendar ì—°ê²°í•´ì œ ë²„íŠ¼ (platform-disconnect-btnê³¼ ë™ì¼í•œ ìŠ¤íƒ€ì¼) */
    .google-disconnect-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 20px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border-radius: 12px;
        position: relative;
        min-width: 110px;
        justify-content: center;
        background: linear-gradient(135deg, #ff6b6b 0%, #ff8787 100%);
        color: white;
        border: none;
    }

    .google-disconnect-btn:hover {
        background: linear-gradient(135deg, #ff5252 0%, #ff6b6b 100%);
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(255, 107, 107, 0.3);
    }

    /* One-click ì—°ê²°í•´ì œ ë²„íŠ¼ (Google Calendarìš©) */
    .one-click-disconnect-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 20px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border-radius: 12px;
        position: relative;
        min-width: 110px;
        justify-content: center;
        background: linear-gradient(135deg, #ff6b6b 0%, #ff8787 100%) !important;
        color: white !important;
        border: none !important;
    }

    .one-click-disconnect-btn:hover {
        background: linear-gradient(135deg, #ff5252 0%, #ff6b6b 100%) !important;
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(255, 107, 107, 0.3);
    }

    /* ì—°ê²°í•˜ê¸° ë²„íŠ¼ ë¡œë”© ìƒíƒœ */
    .platform-connect-btn.loading {
        pointer-events: none;
        opacity: 0.8;
    }

    .connect-loader {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: inherit;
        border-radius: inherit;
    }

    .loader-dot {
        width: 8px;
        height: 8px;
        background: #3b82f6;
        border-radius: 50%;
        animation: bounce 1.4s infinite ease-in-out both;
    }

    .loader-dot::before,
    .loader-dot::after {
        content: '';
        position: absolute;
        width: 8px;
        height: 8px;
        background: #3b82f6;
        border-radius: 50%;
        animation: bounce 1.4s infinite ease-in-out both;
    }

    .loader-dot::before {
        left: -16px;
        animation-delay: -0.32s;
    }

    .loader-dot::after {
        left: 16px;
        animation-delay: -0.16s;
    }

    @keyframes bounce {

        0%,
        80%,
        100% {
            transform: scale(0);
        }

        40% {
            transform: scale(1);
        }
    }


    /* ìº˜ë¦°ë”ê°€ ì—†ì„ ë•Œ í”Œë«í¼ ì¹´ë“œ ë¹„í™œì„±í™” ìŠ¤íƒ€ì¼ */
    .platform-card.disabled {
        opacity: 0.5;
        pointer-events: none;
        position: relative;
    }

    .platform-card.disabled::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.3);
        border-radius: 12px;
        cursor: not-allowed;
    }

    .platform-card.disabled .platform-actions button {
        cursor: not-allowed;
        opacity: 0.6;
    }

    .no-calendar-notice {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(255, 255, 255, 0.95);
        padding: 12px 20px;
        border-radius: 8px;
        border: 1px solid #fbbf24;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        z-index: 10;
        display: none;
    }

    .platform-card.disabled:hover .no-calendar-notice {
        display: block;
    }

    .no-calendar-notice-text {
        color: #92400e;
        font-size: 14px;
        font-weight: 500;
    }

    /* OAuth ì—°ë™ ì™„ë£Œ ìƒíƒœ ìŠ¤íƒ€ì¼ */
    .platform-status.oauth-connected,
    .platform-status.partial {
        color: #f59e0b;
        background: #fef3c7;
        border: 1px solid #fbbf24;
    }

    .platform-status.oauth-connected .status-dot,
    .platform-status.partial .status-dot {
        background: #f59e0b;
        animation: pulse-orange 2s infinite;
    }

    @keyframes pulse-orange {

        0%,
        100% {
            opacity: 1;
        }

        50% {
            opacity: 0.5;
        }
    }

    /* ìº˜ë¦°ë” ì—°ë™ í•´ì œ X ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .sync-disconnect-btn {
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        width: 20px;
        height: 20px;
        border: none;
        background: #dc2626;
        color: white;
        border-radius: 50%;
        font-size: 12px;
        font-weight: bold;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        z-index: 2;
    }

    .sync-disconnect-btn:hover {
        background: #b91c1c;
        transform: translateY(-50%) scale(1.1);
    }

    .sync-disconnect-btn:disabled {
        background: #9ca3af;
        cursor: not-allowed;
    }

    @keyframes spin {
        from {
            transform: translateY(-50%) rotate(0deg);
        }

        to {
            transform: translateY(-50%) rotate(360deg);
        }
    }

    /* ì—°ë™ëœ ë²„íŠ¼ì˜ íŒ¨ë”© ì¡°ì • */
    .platform-sync-btn.synced {
        padding-right: 36px;
    }

    /* Removed import button styles - auto-import on connection now */
</style>
{% endblock %}

{% block extra_js %}
<!-- Core notification systemì´ ë¨¼ì € ë¡œë“œë˜ì–´ì•¼ í•¨ -->
<script
    src="{{ url_for('static', filename='js/notification-utils.js') }}?v={{ range(100000, 999999) | random }}"></script>
<script
    src="{{ url_for('static', filename='js/apple-setup-wizard.js') }}?v={{ range(100000, 999999) | random }}"></script>
<script src="{{ url_for('static', filename='js/platform-health.js') }}?v={{ range(100000, 999999) | random }}"></script>
<script src="{{ url_for('static', filename='js/platform-managers.js') }}?v={{ range(100000, 999999) | random }}"></script>
<script src="{{ url_for('static', filename='js/platform-card.js') }}?v={{ range(100000, 999999) | random }}"></script>
<script src="{{ url_for('static', filename='js/unified-sync-modal.js') }}?v={{ range(100000, 999999) | random }}"></script>
<script>
    // ğŸš€ CALENDAR GRID REFRESH TRIGGER FUNCTION
    function triggerCalendarGridRefresh(calendarId, syncedCount = 0) {
        console.log(`ğŸš€ [TRIGGER] Starting calendar grid refresh for calendar ${calendarId} with ${syncedCount} events`);

        try {
            // Method 1: localStorage event trigger for same-origin communication
            const refreshData = {
                timestamp: Date.now(),
                calendar_id: calendarId,
                synced_count: syncedCount,
                action: 'refresh_calendar_grid'
            };

            localStorage.setItem('calendar_grid_refresh_trigger', JSON.stringify(refreshData));
            console.log('âœ… [TRIGGER] localStorage refresh trigger set');

            // Remove the trigger after a short delay to avoid multiple triggers
            setTimeout(() => {
                localStorage.removeItem('calendar_grid_refresh_trigger');
            }, 1000);

            // Method 2: Direct window communication if available
            if (window.opener && !window.opener.closed) {
                window.opener.postMessage({
                    type: 'CALENDAR_GRID_REFRESH',
                    calendar_id: calendarId,
                    synced_count: syncedCount
                }, window.location.origin);
                console.log('âœ… [TRIGGER] PostMessage sent to opener window');
            }

            // Method 3: BroadcastChannel for modern browser support
            if (typeof BroadcastChannel !== 'undefined') {
                const channel = new BroadcastChannel('calendar_updates');
                channel.postMessage({
                    type: 'REFRESH_CALENDAR_GRID',
                    calendar_id: calendarId,
                    synced_count: syncedCount,
                    timestamp: Date.now()
                });
                channel.close();
                console.log('âœ… [TRIGGER] BroadcastChannel message sent');
            }

            console.log('ğŸ‰ [TRIGGER] All calendar refresh triggers sent successfully');

        } catch (error) {
            console.error('âŒ [TRIGGER] Error triggering calendar refresh:', error);
        }
    }

    // í˜„ì¬ ì—°ê²° ì¤‘ì¸ í”Œë«í¼ê³¼ ì„ íƒëœ ìº˜ë¦°ë”ë¥¼ ì €ì¥
    let currentConnectingPlatform = null;
    let selectedCalendarId = null;

    // ê°œë³„ í”Œë«í¼ ì—°ë™ ê¸°ëŠ¥ - ìº˜ë¦°ë” ì„ íƒ í›„ ì—°ê²°
    async function connectPlatform(platformName) {
        // Appleì˜ ê²½ìš° ìŠ¤ë§ˆíŠ¸ ë§ˆë²•ì‚¬ ì‹¤í–‰
        if (platformName === 'apple') {
            if (window.appleWizard) {
                window.appleWizard.start(platformName);
            } else {
                console.error('Apple Setup Wizard not loaded');
                showNotification('Apple ì„¤ì • ë§ˆë²•ì‚¬ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                // í´ë°±ìœ¼ë¡œ ìˆ˜ë™ ì„¤ì • í¼ í‘œì‹œ
                togglePlatformDetails(platformName);
            }
            return;
        }

        // OAuth ì§€ì› í”Œë«í¼ ì²´í¬
        const oauthPlatforms = ['google', 'notion', 'slack', 'outlook'];

        if (oauthPlatforms.includes(platformName)) {
            // OAuth í”Œë«í¼ì˜ ê²½ìš° ì›í´ë¦­ ì—°ë™ ì‹¤í–‰
            await oneClickConnect(platformName);
        } else {
            // ìˆ˜ë™ ì„¤ì • í”Œë«í¼ì˜ ê²½ìš° ìº˜ë¦°ë” ì„ íƒ ëª¨ë‹¬ í‘œì‹œ
            await showCalendarSelectionModal(platformName);
        }
    }

    // ì‚¬ìš©ì ìº˜ë¦°ë” ëª©ë¡ ë¡œë“œ
    async function loadUserCalendars(container) {
        if (!container) {
            console.error('âŒ [CALENDAR] Container element is null');
            return;
        }

        try {
            console.log('ğŸ“… [CALENDAR] Loading user calendars...');
            container.innerHTML = '<div class="loading-spinner">ìº˜ë¦°ë” ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';

            const response = await fetch('/api/calendars/list');
            const data = await response.json();

            if (data.success && data.calendars) {
                displayCalendarList(data.calendars, container);
                console.log('âœ… [CALENDAR] Successfully loaded calendars:', data.calendars.length);
            } else {
                throw new Error(data.error || 'Failed to load calendars');
            }
        } catch (error) {
            console.error('âŒ [CALENDAR] Failed to load calendars:', error);
            container.innerHTML = '<div class="error-message">ìº˜ë¦°ë” ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
        }
    }

    // ìº˜ë¦°ë” ì„ íƒ ëª¨ë‹¬ í‘œì‹œ (ì¼ë°˜ ì—°ê²°ìš©)
    async function showCalendarSelectionModal(platformName) {
        console.log('ğŸ“… [MODAL] Showing calendar selection modal for:', platformName);

        currentConnectingPlatform = platformName;
        let modal = document.getElementById('calendar-selection-modal');

        // DOM ìš”ì†Œê°€ ì—†ìœ¼ë©´ ë™ì ìœ¼ë¡œ ìƒì„±
        if (!modal) {
            console.log('ğŸ“… [MODAL] Creating modal dynamically...');

            // Create modal HTML
            modal = document.createElement('div');
            modal.className = 'calendar-selection-modal';
            modal.id = 'calendar-selection-modal';
            modal.style.display = 'none';
            modal.innerHTML = `
                <div class="modal-overlay" onclick="closeCalendarSelectionModal()"></div>
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">ìº˜ë¦°ë” ë³€ê²½</h3>
                        <button class="modal-close-btn" onclick="closeCalendarSelectionModal()">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M18 6l-12 12M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    <div class="modal-body">
                        <p class="modal-description">
                            <span id="platform-name-display"></span> ì—°ê²°ì„ ìœ„í•´ ë™ê¸°í™”í•  ìº˜ë¦°ë”ë¥¼ ì„ íƒí•˜ì„¸ìš”.
                        </p>
                        <div class="calendar-list" id="calendar-list">
                            <div class="loading-state">
                                <div class="loading-spinner"></div>
                                <p>ìº˜ë¦°ë” ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn-secondary" onclick="closeCalendarSelectionModal()">ì·¨ì†Œ</button>
                        <button class="btn-primary" id="confirm-calendar-selection" onclick="confirmCalendarSelection()" disabled>
                            ì„ íƒí•œ ìº˜ë¦°ë”ë¡œ ì—°ê²°
                        </button>
                    </div>
                </div>
            `;

            // Append to body
            document.body.appendChild(modal);
            console.log('âœ… [MODAL] Modal created and appended to body');
        }

        const platformDisplay = document.getElementById('platform-name-display');
        const calendarList = document.getElementById('calendar-list');

        if (!calendarList) {
            console.error('âŒ [MODAL] calendar-list element not found');
            return;
        }

        console.log('âœ… [MODAL] Modal elements found:', { modal, platformDisplay, calendarList });

        // í”Œë«í¼ ì´ë¦„ í‘œì‹œ
        if (platformDisplay) platformDisplay.textContent = getKoreanPlatformName(platformName);

        // ëª¨ë‹¬ í‘œì‹œ
        modal.style.display = 'flex';
        console.log('ğŸ“… [MODAL] Modal display set to flex');

        // ìº˜ë¦°ë” ëª©ë¡ ë¡œë”©
        await loadUserCalendars(calendarList);
    }

    // [REMOVED] Old deprecated openCalendarSyncModal function removed - using new implementation below

    // ìº˜ë¦°ë” ëª©ë¡ í‘œì‹œ
    function displayCalendarList(calendars, container) {
        // containerê°€ nullì¸ì§€ í™•ì¸
        if (!container) {
            console.error('âŒ [CALENDAR] Container element is null - cannot display calendar list');
            console.trace('displayCalendarList called with null container');
            return;
        }

        console.log('ğŸ“… [CALENDAR] Displaying calendar list:', { calendars, container });
        container.innerHTML = '';

        if (!calendars || calendars.length === 0) {
            container.innerHTML = '<div class="no-calendars">ì‚¬ìš© ê°€ëŠ¥í•œ ìº˜ë¦°ë”ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            return;
        }

        calendars.forEach(calendar => {
            const calendarItem = createCalendarItem(calendar);
            if (calendarItem) {
                container.appendChild(calendarItem);
            }
        });
    }

    // ìƒ˜í”Œ ìº˜ë¦°ë” ë°ì´í„° í‘œì‹œ (APIê°€ ì—†ëŠ” ê²½ìš°)
    function displaySampleCalendars(container) {
        if (!container) {
            console.error('âŒ [SAMPLE] Container is null - cannot display sample calendars');
            return;
        }

        console.log('ğŸ“… [SAMPLE] Displaying sample calendars');

        const sampleCalendars = [
            {
                id: 'main-calendar',
                name: 'ë©”ì¸ ìº˜ë¦°ë”',
                description: 'ê¸°ë³¸ ê°œì¸ ìº˜ë¦°ë”',
                type: 'primary',
                color: '#3b82f6'
            },
            {
                id: 'work-calendar',
                name: 'ì—…ë¬´ ìº˜ë¦°ë”',
                description: 'ì—…ë¬´ ê´€ë ¨ ì¼ì • ê´€ë¦¬',
                type: 'personal',
                color: '#f59e0b'
            },
            {
                id: 'shared-calendar',
                name: 'íŒ€ ê³µìœ  ìº˜ë¦°ë”',
                description: 'íŒ€ì›ë“¤ê³¼ ê³µìœ í•˜ëŠ” ìº˜ë¦°ë”',
                type: 'shared',
                color: '#10b981'
            }
        ];

        displayCalendarList(sampleCalendars, container);
    }

    // ìº˜ë¦°ë”ê°€ ì—†ì„ ë•Œ ë©”ì‹œì§€ í‘œì‹œ
    function displayNoCalendarsMessage(container) {
        if (!container) {
            console.error('âŒ [NO-CALENDARS] Container is null - cannot display no calendars message');
            return;
        }

        console.log('ğŸ“… [NO-CALENDARS] Displaying no calendars message');

        container.innerHTML =
            '<div class="no-calendars-message">' +
            '<div class="no-calendars-icon">' +
            '<svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">' +
            '<path d="M8 2v4M16 2v4M3 10h18M5 4h14a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2z"/>' +
            '</svg>' +
            '</div>' +
            '<h4>ìº˜ë¦°ë”ê°€ ì—†ìŠµë‹ˆë‹¤</h4>' +
            '<p>ë¨¼ì € ìº˜ë¦°ë”ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.</p>' +
            '<button class="btn-primary" onclick="redirectToCalendarCreation()">' +
            'ìº˜ë¦°ë” ìƒì„±í•˜ëŸ¬ ê°€ê¸°' +
            '</button>' +
            '</div>';
    }

    // ìº˜ë¦°ë” ì•„ì´í…œ ìƒì„±
    function createCalendarItem(calendar) {
        const item = document.createElement('div');
        item.className = 'calendar-item';
        item.setAttribute('data-calendar-id', calendar.id);
        item.onclick = () => selectCalendarForModal(calendar.id);

        item.innerHTML =
            '<div class="calendar-radio"></div>' +
            '<div class="calendar-info">' +
            '<div class="calendar-name">' + (calendar.name || '') + '</div>' +
            '<div class="calendar-description">' + (calendar.description || '') + '</div>' +
            '</div>' +
            '<div class="calendar-type ' + (calendar.type || 'personal') + '">' + getCalendarTypeText(calendar.type) + '</div>';

        return item;
    }

    // ìº˜ë¦°ë” íƒ€ì… í…ìŠ¤íŠ¸ ë°˜í™˜
    function getCalendarTypeText(type) {
        switch (type) {
            case 'primary': return 'ê¸°ë³¸';
            case 'shared': return 'ê³µìœ ';
            case 'personal': return 'ê°œì¸';
            default: return 'ê°œì¸';
        }
    }

    // ëª¨ë‹¬ì—ì„œ ìº˜ë¦°ë” ì„ íƒ
    function selectCalendarForModal(calendarId) {
        // ê¸°ì¡´ ì„ íƒ í•´ì œ
        document.querySelectorAll('.calendar-item').forEach(item => {
            item.classList.remove('selected');
        });

        // ìƒˆ ì„ íƒ ì ìš©
        const selectedItem = document.querySelector('[data-calendar-id="' + calendarId + '"]');
        if (selectedItem) {
            selectedItem.classList.add('selected');
            selectedCalendarId = calendarId;

            // í™•ì¸ ë²„íŠ¼ í™œì„±í™”
            document.getElementById('confirm-calendar-selection').disabled = false;
        }
    }

    // ìº˜ë¦°ë” ì„ íƒ í™•ì¸
    async function confirmCalendarSelection() {
        console.log(`ğŸ“… confirmCalendarSelection í˜¸ì¶œ: platform=${currentConnectingPlatform}, calendar=${selectedCalendarId}`);

        if (!selectedCalendarId || !currentConnectingPlatform) {
            console.warn('âš ï¸ í•„ìˆ˜ ì •ë³´ ëˆ„ë½:', { selectedCalendarId, currentConnectingPlatform });
            showNotification('ìº˜ë¦°ë”ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
            return;
        }

        // Googleì˜ ê²½ìš° 2ë‹¨ê³„ í”„ë¡œì„¸ìŠ¤: Google ìº˜ë¦°ë” ì„ íƒ â†’ NotionFlow ìº˜ë¦°ë” ì„ íƒ
        if (currentConnectingPlatform === 'google') {
            console.log('ğŸ“… [GOOGLE] Selected Google calendar:', selectedCalendarId);

            // Google ìº˜ë¦°ë”ë¥¼ ì„ íƒí–ˆìœ¼ë¯€ë¡œ ì´ì œ NotionFlow ìº˜ë¦°ë” ì„ íƒ ëª¨ë‹¬ í‘œì‹œ
            window.selectedGoogleCalendarId = selectedCalendarId;

            // ëª¨ë‹¬ ë‚´ìš©ì„ NotionFlow ìº˜ë¦°ë” ì„ íƒìœ¼ë¡œ ë³€ê²½
            await showNotionFlowCalendarSelection();
            return;
        }

        // ë‹¤ë¥¸ í”Œë«í¼ì˜ ê²½ìš° ê¸°ì¡´ ë¡œì§
        try {
            console.log(`ğŸ”— í”Œë«í¼ ì—°ê²° ì‹œì‘: ${currentConnectingPlatform} â†’ ${selectedCalendarId}`);

            // ëª¨ë‹¬ ë‹«ê¸° ì „ì— ë³€ìˆ˜ ì €ì¥ (closeCalendarSelectionModalì´ ê°’ì„ nullë¡œ ì´ˆê¸°í™”í•˜ê¸° ë•Œë¬¸)
            const platformName = currentConnectingPlatform;
            const calendarId = selectedCalendarId;

            closeCalendarSelectionModal();

            await performPlatformConnection(platformName, calendarId);
            console.log(`âœ… í”Œë«í¼ ì—°ê²° ì™„ë£Œ: ${platformName}`);
        } catch (error) {
            console.error(`âŒ í”Œë«í¼ ì—°ê²° ì‹¤íŒ¨: ${currentConnectingPlatform}`, error);
            showNotification(`ì—°ê²° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`, 'error');
        }
    }

    // Google ì—°ë™ì„ ìœ„í•œ NotionFlow ìº˜ë¦°ë” ì„ íƒ ë‹¨ê³„
    async function showNotionFlowCalendarSelection() {
        // 2ë‹¨ê³„ í”Œë˜ê·¸ ì„¤ì •
        isGoogleSecondStep = true;

        const modal = document.getElementById('calendar-selection-modal');
        const platformDisplay = document.getElementById('platform-name-display');
        const calendarList = document.getElementById('calendar-list');

        // ëª¨ë‹¬ ì œëª© ë³€ê²½
        platformDisplay.textContent = 'Google Calendar';
        const modalTitle = modal.querySelector('.modal-title');
        if (modalTitle) modalTitle.textContent = 'NotionFlow ìº˜ë¦°ë” ì„ íƒ';

        const modalDescription = modal.querySelector('.modal-description');
        if (modalDescription) {
            modalDescription.innerHTML = `ì„ íƒí•˜ì‹  Google Calendarë¥¼ ì–´ëŠ NotionFlow ìº˜ë¦°ë”ì™€ ë™ê¸°í™”í• ê¹Œìš”?`;
        }

        // ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½
        const confirmBtn = document.getElementById('confirm-calendar-selection');
        if (confirmBtn) {
            confirmBtn.textContent = 'Google Calendarì™€ ì—°ê²°';
            confirmBtn.onclick = () => confirmGoogleCalendarConnection();
        }

        // NotionFlow ìº˜ë¦°ë” ëª©ë¡ ë¡œë“œ (loadUserCalendars ì‚¬ìš©)
        // ê¸°ì¡´ ì„ íƒ ì´ˆê¸°í™”
        selectedCalendarId = null;
        confirmBtn.disabled = true;

        // ìº˜ë¦°ë” ëª©ë¡ ë¡œë“œ
        await loadUserCalendars(calendarList);
    }

    // Google Calendar ì—°ê²° í™•ì¸
    async function confirmGoogleCalendarConnection() {
        console.log('ğŸ” [GOOGLE-CONNECT] DEBUG selectedCalendarId:', selectedCalendarId);
        console.log('ğŸ” [GOOGLE-CONNECT] DEBUG window.selectedGoogleCalendarId:', window.selectedGoogleCalendarId);

        if (!selectedCalendarId || !window.selectedGoogleCalendarId) {
            console.log('âŒ [GOOGLE-CONNECT] Missing IDs - selectedCalendarId:', selectedCalendarId, 'googleCalendarId:', window.selectedGoogleCalendarId);
            showNotification('NotionFlow ìº˜ë¦°ë”ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
            return;
        }

        // ëª¨ë‹¬ ë‹«ê¸° ì „ì— ê°’ì„ ì„ì‹œ ì €ì¥
        const notionFlowCalendarId = selectedCalendarId;
        const googleCalendarId = window.selectedGoogleCalendarId;

        // ì—°ê²° ì¤‘ ìƒíƒœ í‘œì‹œ (ëª¨ë‹¬ì€ ì•„ì§ ë‹«ì§€ ì•ŠìŒ)
        const confirmBtn = document.getElementById('confirm-calendar-selection');
        const originalText = confirmBtn.textContent;
        confirmBtn.disabled = true;
        confirmBtn.textContent = 'ì—°ê²° ì¤‘...';

        // Google Calendar ì—°ê²° API í˜¸ì¶œ (selectedCalendarIdëŠ” NotionFlow ìº˜ë¦°ë” ID)
        try {
            const requestData = {
                calendar_id: notionFlowCalendarId, // NotionFlow ìº˜ë¦°ë” ID
                google_calendar_id: googleCalendarId // Google ìº˜ë¦°ë” ID
            };
            console.log('ğŸ” [GOOGLE-CONNECT] Sending request data:', requestData);
            console.log('ğŸ” [GOOGLE-CONNECT] JSON string:', JSON.stringify(requestData));

            const response = await fetch('/api/google-calendar/connect-calendar', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestData)
            });

            const result = await response.json();

            if (response.ok && result.success) {
                // ì„±ê³µ ì‹œ ëª¨ë‹¬ ë‹«ê¸°
                closeCalendarSelectionModal();

                // ë™ê¸°í™” ê²°ê³¼ í‘œì‹œ
                const syncedCount = result.synced_count || 0;
                showNotification(`Google Calendar ì—°ê²° ì™„ë£Œ! ${syncedCount}ê°œ ì¼ì •ì´ ë™ê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');

                console.log('âœ… [GOOGLE-CONNECT] ì—°ê²° ì„±ê³µ:', result);

                // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ìƒíƒœ ì—…ë°ì´íŠ¸
                setTimeout(() => location.reload(), 1500);
            } else {
                throw new Error(result.error || 'Google Calendar ì—°ê²° ì‹¤íŒ¨');
            }
        } catch (error) {
            console.error('Google Calendar connection error:', error);
            showNotification(`ì—°ê²° ì‹¤íŒ¨: ${error.message}`, 'error');

            // ì‹¤íŒ¨ ì‹œ ë²„íŠ¼ ìƒíƒœ ë³µì›
            confirmBtn.disabled = false;
            confirmBtn.textContent = originalText;
        }
    }

    // ì‹¤ì œ í”Œë«í¼ ì—°ê²° ìˆ˜í–‰
    async function performPlatformConnection(platformName, calendarId) {
        console.log(`ğŸ”— performPlatformConnection í˜¸ì¶œ: ${platformName}, ${calendarId}`);

        // DOM ìš”ì†Œë“¤ì„ ì•ˆì „í•˜ê²Œ ì°¾ê¸°
        const button = document.querySelector('[data-platform="' + platformName + '"] .platform-connect-btn');
        const card = document.querySelector('[data-platform="' + platformName + '"]');

        // ìš”ì†Œê°€ ì—†ìœ¼ë©´ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
        if (!button || !card) {
            console.log(`âš ï¸ DOM ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ - button: ${!!button}, card: ${!!card}`);
            // DOM ìš”ì†Œê°€ ì—†ì–´ë„ API í˜¸ì¶œì€ ì§„í–‰
            return await performDirectPlatformConnection(platformName, calendarId);
        }

        // DOM ìš”ì†Œë“¤ì„ ì•ˆì „í•˜ê²Œ ì°¾ê¸° (null ì²´í¬ í¬í•¨)
        const loader = button ? button.querySelector('.connect-loader') : null;
        const buttonText = button ? button.querySelector('.connect-text') : null;
        const status = card ? card.querySelector('.platform-status') : null;

        // ë²„íŠ¼ ìƒíƒœ ë³€ê²½ (ìš”ì†Œê°€ ìˆì„ ë•Œë§Œ)
        if (button) {
            button.disabled = true;
        }
        if (buttonText) {
            buttonText.textContent = 'ì—°ê²° ì¤‘...';
        }
        if (loader) {
            loader.style.display = 'flex';
        }

        // ì¹´ë“œ ì• ë‹ˆë©”ì´ì…˜ (ì¹´ë“œê°€ ìˆì„ ë•Œë§Œ)
        if (card) {
            card.style.transform = 'scale(1.02)';
            card.style.boxShadow = 'var(--shadow-lg)';
        }

        try {
            console.log(`âœ… ${platformName} OAuth ì™„ë£Œ, ê¸°ì¡´ ì—°ë™ ë¡œì§ í™œìš©`);

            // OAuthê°€ ì´ë¯¸ ì™„ë£Œëœ ìƒíƒœì´ë¯€ë¡œ ë°”ë¡œ ì—°ê²° ì²˜ë¦¬
            // ê¸°ì¡´ì— ë§Œë“¤ì–´ë‘” í†µí•© ë™ê¸°í™” API í˜¸ì¶œ

            console.log(`ğŸ”„ ${platformName} ë™ê¸°í™” ì‹œì‘...`);

            // ê¸°ì¡´ í†µí•© ë™ê¸°í™” API í˜¸ì¶œ
            const syncResponse = await fetch('/api/unified-sync/sync', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    platforms: [platformName],
                    options: {
                        target_calendar_id: calendarId,
                        direction: 'bidirectional',
                        scope: 'all'
                    }
                })
            });

            if (syncResponse.ok) {
                const syncResult = await syncResponse.json();
                console.log(`âœ… ${platformName} ë™ê¸°í™” ì„±ê³µ:`, syncResult);

                if (syncResult.success && syncResult.results && syncResult.results[platformName]?.success) {
                    const platformResult = syncResult.results[platformName];
                    console.log(`ğŸ“Š ${platformName} ë™ê¸°í™” ê²°ê³¼: ${platformResult.message}`);
                } else {
                    console.warn(`âš ï¸ ${platformName} ë™ê¸°í™” ë¶€ë¶„ ì‹¤íŒ¨:`, syncResult);
                }
            } else {
                console.warn(`âš ï¸ ${platformName} ë™ê¸°í™” API í˜¸ì¶œ ì‹¤íŒ¨:`, syncResponse.status);
            }

            // ì—°ê²° ì„±ê³µ ì²˜ë¦¬
            if (status) {
                status.className = 'platform-status connected';
                status.innerHTML = '<span class="status-dot"></span>ì—°ê²°ë¨';
            }

            // ë²„íŠ¼ì„ ì—°ê²°í•´ì œ ë²„íŠ¼ìœ¼ë¡œ ë³€ê²½
            if (button) {
                button.className = 'platform-disconnect-btn';
                button.setAttribute('onclick', 'disconnectPlatform(\'' + platformName + '\')');
            }
            if (buttonText) {
                buttonText.textContent = 'ì—°ê²° í•´ì œ';
            }

            // í†µê³„ ë° í”Œë«í¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            updateConnectionStats();

            // DBì—ì„œ ìµœì‹  ìƒíƒœë¥¼ ë‹¤ì‹œ ê°€ì ¸ì™€ì„œ í™•ì‹¤íˆ ë°˜ì˜
            setTimeout(async () => {
                await updatePlatformStatus();
                console.log(`ğŸ”„ ${platformName} ìƒíƒœ ì¬í™•ì¸ ì™„ë£Œ`);
            }, 1000);

            // ë™ê¸°í™” ê²°ê³¼ì— ë”°ë¥¸ ì•Œë¦¼
            if (syncResponse && syncResponse.ok) {
                const syncResult = await syncResponse.json();
                if (syncResult.success && syncResult.results && syncResult.results[platformName]?.success) {
                    const platformResult = syncResult.results[platformName];
                    showNotification(platformResult.message || `${getKoreanPlatformName(platformName)} ì—°ê²° ë° ë™ê¸°í™” ì™„ë£Œ!`, 'success');
                } else {
                    showNotification(`${getKoreanPlatformName(platformName)} ì—°ê²° ì™„ë£Œ! (ì¼ë¶€ ë™ê¸°í™” ì‹¤íŒ¨)`, 'warning');
                }
            } else {
                showNotification(`${getKoreanPlatformName(platformName)} ì—°ê²° ì™„ë£Œ!`, 'success');
            }
        } catch (error) {
            console.error('ì—°ê²° ì¤‘ ì˜¤ë¥˜:', error);
            showNotification('ì—°ê²° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        }

        // ì• ë‹ˆë©”ì´ì…˜ ë° ìƒíƒœ ë³µì›
        setTimeout(() => {
            if (button) {
                button.disabled = false;
                if (button.className === 'platform-connect-btn') {
                    if (buttonText) buttonText.textContent = 'ì—°ê²°í•˜ê¸°';
                }
            }
            if (loader) {
                loader.style.display = 'none';
            }
            if (card) {
                card.style.transform = '';
                card.style.boxShadow = '';
            }
        }, 500);

        // ì„ íƒ ìƒíƒœ ì´ˆê¸°í™”
        selectedCalendarId = null;
        currentConnectingPlatform = null;
    }

    // DOM ìš”ì†Œ ì—†ì´ ì§ì ‘ í”Œë«í¼ ì—°ê²° ìˆ˜í–‰ (OAuth íŒì—…ìš©)
    async function performDirectPlatformConnection(platformName, calendarId) {
        console.log(`ğŸš€ performDirectPlatformConnection ì‹œì‘: ${platformName}, ${calendarId}`);

        try {
            console.log(`âœ… ${platformName} OAuth ì´ë¯¸ ì™„ë£Œë¨, ë™ê¸°í™” ì‹¤í–‰`);

            // OAuthê°€ ì´ë¯¸ ì™„ë£Œëœ ìƒíƒœì´ë¯€ë¡œ ë°”ë¡œ ë™ê¸°í™” ì§„í–‰
            console.log(`ğŸ”„ ${platformName} ë™ê¸°í™” ì‹œì‘...`);

            // ê¸°ì¡´ í†µí•© ë™ê¸°í™” API í˜¸ì¶œ
            const syncResponse = await fetch('/api/unified-sync/sync', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    platforms: [platformName],
                    options: {
                        target_calendar_id: calendarId,
                        direction: 'bidirectional',
                        scope: 'all'
                    }
                })
            });

            let syncMessage = '';
            if (syncResponse.ok) {
                const syncResult = await syncResponse.json();
                console.log(`âœ… ${platformName} ë™ê¸°í™” ì„±ê³µ:`, syncResult);

                if (syncResult.success && syncResult.results && syncResult.results[platformName]?.success) {
                    const platformResult = syncResult.results[platformName];
                    syncMessage = platformResult.message || '';
                    console.log(`ğŸ“Š ${platformName} ë™ê¸°í™” ê²°ê³¼: ${syncMessage}`);
                } else {
                    console.warn(`âš ï¸ ${platformName} ë™ê¸°í™” ë¶€ë¶„ ì‹¤íŒ¨:`, syncResult);
                    syncMessage = ' (ì¼ë¶€ ë™ê¸°í™” ì‹¤íŒ¨)';
                }
            } else {
                console.warn(`âš ï¸ ${platformName} ë™ê¸°í™” API í˜¸ì¶œ ì‹¤íŒ¨:`, syncResponse.status);
            }

            // í”Œë«í¼ ìƒíƒœ ì—…ë°ì´íŠ¸ (DOM ìš”ì†Œ ì°¾ê¸° í›„)
            setTimeout(() => {
                markPlatformConnected(platformName);
                updatePlatformStatus(platformName, 'connected');
                updateConnectionStats();
                updatePlatformStatus();
            }, 100);

            // ë™ê¸°í™” ê²°ê³¼ì— ë”°ë¥¸ ì•Œë¦¼
            const finalMessage = syncMessage || `${getKoreanPlatformName(platformName)} ì—°ê²° ë° ë™ê¸°í™” ì™„ë£Œ!`;
            showNotification(finalMessage, syncMessage.includes('ì‹¤íŒ¨') ? 'warning' : 'success');
            return { success: true, message: finalMessage };
        } catch (error) {
            console.error(`âŒ ${platformName} ì—°ê²° ì¤‘ ì˜¤ë¥˜:`, error);
            showNotification('ì—°ê²° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            return { success: false, message: error.message };
        } finally {
            // ì„ íƒ ìƒíƒœ ì´ˆê¸°í™”
            selectedCalendarId = null;
            currentConnectingPlatform = null;
        }
    }

    // ìº˜ë¦°ë” ì„ íƒ ëª¨ë‹¬ ë‹«ê¸°
    function closeCalendarSelectionModal() {
        const modal = document.getElementById('calendar-selection-modal');
        modal.style.display = 'none';

        // ì„ íƒ ìƒíƒœ ì´ˆê¸°í™”
        selectedCalendarId = null;
        currentConnectingPlatform = null;
        isGoogleSecondStep = false; // Google 2ë‹¨ê³„ í”Œë˜ê·¸ ë¦¬ì…‹
        document.getElementById('confirm-calendar-selection').disabled = true;
    }

    // ìº˜ë¦°ë” ìƒì„± í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
    function redirectToCalendarCreation() {
        closeCalendarSelectionModal();
        window.location.href = '/calendar';
    }
    // END OF DEPRECATED FUNCTIONS

    // ê°œë³„ í”Œë«í¼ ì—°ê²° í•´ì œ ê¸°ëŠ¥
    async function disconnectPlatform(platformName) {
        const card = document.querySelector(`[data-platform="${platformName}"]`);
        const button = card?.querySelector('.platform-disconnect-btn');
        const loader = button?.querySelector('.disconnect-loader');
        const buttonText = button?.querySelector('.disconnect-text');
        const status = card?.querySelector('.platform-status');

        if (!card || !button) {
            console.error(`Cannot find disconnect button for platform: ${platformName}`);
            return;
        }

        if (!confirm(getKoreanPlatformName(platformName) + ' ì—°ê²°ì„ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            return;
        }

        // ë²„íŠ¼ ìƒíƒœ ë³€ê²½
        button.disabled = true;
        if (buttonText) buttonText.textContent = 'í•´ì œ ì¤‘...';
        if (loader) loader.style.display = 'flex';

        try {
            // ë°±ì—”ë“œì— ì—°ê²° í•´ì œ ìš”ì²­
            const response = await fetch('/api/calendar/disconnect-platform', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ platform: platformName })
            });

            const result = await response.json();
            if (!result.success) {
                throw new Error(result.error || 'ì—°ê²° í•´ì œ ì‹¤íŒ¨');
            }

            console.log(`âœ… ${platformName} ì—°ê²° í•´ì œ ì™„ë£Œ:`, result);

            // ìƒíƒœ ì—…ë°ì´íŠ¸
            status.className = 'platform-status disconnected';
            status.innerHTML = '<span class="status-dot"></span>ì—°ê²°ë˜ì§€ ì•ŠìŒ';

            // ë²„íŠ¼ì„ ì—°ê²° ë²„íŠ¼ìœ¼ë¡œ ë³€ê²½
            button.className = 'platform-connect-btn';
            button.setAttribute('onclick', `connectPlatform('${platformName}')`);
            buttonText.textContent = 'ì—°ê²°í•˜ê¸°';

            // í†µê³„ ë° í”Œë«í¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            updateConnectionStats();
            updatePlatformStatus();

            showNotification(`${getKoreanPlatformName(platformName)} ì—°ê²° í•´ì œ ì™„ë£Œ`, 'success');
        } catch (error) {
            console.error('ì—°ê²° í•´ì œ ì¤‘ ì˜¤ë¥˜:', error);
            showNotification('ì—°ê²° í•´ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        }

        // ìƒíƒœ ë³µì›
        setTimeout(() => {
            button.disabled = false;
            if (button.className === 'platform-disconnect-btn') {
                if (buttonText) buttonText.textContent = 'ì—°ê²° í•´ì œ';
            }
            if (loader) loader.style.display = 'none';
        }, 500);
    }


    // í”Œë«í¼ ì´ë¦„ í•œêµ­ì–´ ë³€í™˜
    function getKoreanPlatformName(platform) {
        const names = {
            'notion': 'Notion',
            'google': 'Google Calendar',
            'apple': 'Apple Calendar',
            'outlook': 'Outlook',
            'slack': 'Slack'
        };
        return names[platform] || platform;
    }

    // ì•Œë¦¼ í‘œì‹œ í•¨ìˆ˜ - NotificationUtils ì‚¬ìš©
    function showNotification(message, type = 'info') {
        if (window.NotificationUtils) {
            return window.NotificationUtils.show(message, type);
        }
        // Fallback if NotificationUtils not loaded
        console.log(`[${type}] ${message}`);
    }

    // ì‹¤ì œ í”Œë«í¼ ì—°ê²° ìƒíƒœ ì—…ë°ì´íŠ¸
    async function updatePlatformStatus() {
        try {
            const response = await fetch('/api/dashboard/platforms');

            if (response.ok) {
                const data = await response.json();

                if (data.success && data.platforms) {
                    const platforms = data.platforms;

                    // ê° í”Œë«í¼ë³„ ìƒíƒœ ì—…ë°ì´íŠ¸
                    Object.keys(platforms).forEach(platformName => {
                        const platform = platforms[platformName];
                        const platformCard = document.querySelector(`[data-platform="${platformName}"]`);

                        if (platformCard) {
                            const statusElement = platformCard.querySelector('.platform-status');
                            const connectBtn = platformCard.querySelector('.platform-connect-btn');

                            const syncBtn = platformCard.querySelector('.platform-sync-btn');

                            // OAuth ì—°ê²°ë¨ ë˜ëŠ” ì„¤ì • ì™„ë£Œë¨
                            if (statusElement && (platform.configured || platform.oauth_connected)) {
                                console.log(`âœ… ${platformName} ì—°ê²° ìƒíƒœ ë³µì›:`, platform);

                                // ì—°ê²°ëœ ìƒíƒœë¡œ í‘œì‹œ
                                statusElement.className = 'platform-status connected';
                                statusElement.innerHTML = '<span class="status-dot"></span>ì—°ê²°ë¨';

                                // ì—°ê²° ë²„íŠ¼ì„ ì—°ê²°í•´ì œ ë²„íŠ¼ìœ¼ë¡œ ë³€ê²½ (ìˆ¨ê¸°ì§€ ë§ê³ )
                                if (connectBtn) {
                                    connectBtn.className = 'platform-disconnect-btn';
                                    connectBtn.setAttribute('onclick', `disconnectPlatform('${platformName}')`);
                                    const buttonText = connectBtn.querySelector('.connect-text');
                                    if (buttonText) {
                                        buttonText.textContent = 'ì—°ê²° í•´ì œ';
                                    }
                                }

                                // ì›í´ë¦­ ë²„íŠ¼ ì²˜ë¦¬
                                const oneClickBtn = platformCard.querySelector('.one-click-btn-small');
                                if (oneClickBtn) {
                                    const buttonText = oneClickBtn.querySelector('.btn-text');
                                    if (buttonText) {
                                        buttonText.textContent = 'ì—°ê²°í•´ì œ';
                                    }
                                    oneClickBtn.setAttribute('onclick', `oneClickDisconnect('${platformName}')`);

                                    // Googleì€ markPlatformConnected í•¨ìˆ˜ì—ì„œ ë²„íŠ¼ ìƒì„±ë¨ (ì¤‘ë³µ ë°©ì§€)
                                }

                                // markPlatformConnected í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ì—¬ ì¼ê´€ëœ ë²„íŠ¼ ì²˜ë¦¬
                                markPlatformConnected(platformName);
                            } else {
                                // ì—°ê²°ë˜ì§€ ì•Šì€ ìƒíƒœ
                                console.log(`âŒ ${platformName} ì—°ê²°ë˜ì§€ ì•ŠìŒ:`, platform);

                                statusElement.className = 'platform-status disconnected';
                                statusElement.innerHTML = '<span class="status-dot"></span>ì—°ê²°ë˜ì§€ ì•ŠìŒ';

                                // ì—°ê²° ë²„íŠ¼ ë³µì›
                                if (connectBtn) {
                                    connectBtn.style.display = 'inline-block';
                                    connectBtn.className = 'platform-connect-btn';
                                    connectBtn.setAttribute('onclick', `connectPlatform('${platformName}')`);
                                }

                                // ì›í´ë¦­ ë²„íŠ¼ ë³µì›
                                const oneClickBtn = platformCard.querySelector('.one-click-btn-small');
                                if (oneClickBtn && platformName !== 'apple') { // Appleì€ ì›í´ë¦­ ë²„íŠ¼ ì—†ìŒ
                                    const buttonText = oneClickBtn.querySelector('.btn-text');
                                    if (buttonText) {
                                        buttonText.textContent = 'ì›í´ë¦­';
                                    }
                                    oneClickBtn.setAttribute('onclick', `oneClickConnect('${platformName}')`);
                                    oneClickBtn.className = 'one-click-btn-small';
                                    oneClickBtn.style.display = 'inline-block';
                                }

                                // Google ì—°ê²°í•´ì œ ë²„íŠ¼ ì œê±°
                                const googleDisconnectBtn = platformCard.querySelector('.google-disconnect-btn');
                                if (googleDisconnectBtn) {
                                    googleDisconnectBtn.remove();
                                }

                                // ìº˜ë¦°ë” ì—°ë™ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
                                if (syncBtn) {
                                    syncBtn.style.display = 'none';
                                }
                            }
                        }
                    });

                    console.log('Platform status updated with real data:', platforms);
                }
            }
        } catch (error) {
            console.error('Error updating platform status:', error);
            // API ì—ëŸ¬ ì‹œ ëª¨ë“  í”Œë«í¼ì„ ì—°ê²°ë˜ì§€ ì•Šì€ ìƒíƒœë¡œ ì„¤ì •
            const platformCards = document.querySelectorAll('.platform-card');
            platformCards.forEach(card => {
                const statusElement = card.querySelector('.platform-status');
                if (statusElement) {
                    statusElement.className = 'platform-status disconnected';
                    statusElement.innerHTML = '<span class="status-dot"></span>ì—°ê²°ë˜ì§€ ì•ŠìŒ';
                }
            });
        }
    }

    // ìº˜ë¦°ë” ê°œìˆ˜ í™•ì¸ ë° í”Œë«í¼ ì¹´ë“œ ìƒíƒœ ì—…ë°ì´íŠ¸
    async function checkCalendarsAndUpdatePlatforms() {
        try {
            // ì„œë²„ì—ì„œ ë Œë”ë§ëœ í†µê³„ ë°ì´í„° ì‚¬ìš©
            const connectedCount = {{ (stats.connected_count if stats and stats.connected_count else 0) | tojson }};
            const hasCalendars = connectedCount > 0;

    // ëª¨ë“  í”Œë«í¼ ì¹´ë“œ ì„ íƒ
    const platformCards = document.querySelectorAll('.platform-card');

    platformCards.forEach(card => {
        if (!hasCalendars) {
            // ìº˜ë¦°ë”ê°€ ì—†ìœ¼ë©´ ì¹´ë“œ ë¹„í™œì„±í™”
            card.classList.add('disabled');

            // ì•ˆë‚´ ë©”ì‹œì§€ ì¶”ê°€ (ì•„ì§ ì—†ìœ¼ë©´)
            if (!card.querySelector('.no-calendar-notice')) {
                const notice = document.createElement('div');
                notice.className = 'no-calendar-notice';
                notice.innerHTML = '<div class="no-calendar-notice-text">ğŸ“… ë¨¼ì € ìº˜ë¦°ë”ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”</div>';
                card.appendChild(notice);
            }

            // ë²„íŠ¼ë“¤ ë¹„í™œì„±í™”
            const buttons = card.querySelectorAll('button');
            buttons.forEach(btn => {
                btn.disabled = true;
                btn.style.pointerEvents = 'none';
            });
        } else {
            // ìº˜ë¦°ë”ê°€ ìˆìœ¼ë©´ ì¹´ë“œ í™œì„±í™”
            card.classList.remove('disabled');

            // ì•ˆë‚´ ë©”ì‹œì§€ ì œê±°
            const notice = card.querySelector('.no-calendar-notice');
            if (notice) {
                notice.remove();
            }

            // ë²„íŠ¼ë“¤ í™œì„±í™”
            const buttons = card.querySelectorAll('button');
            buttons.forEach(btn => {
                btn.disabled = false;
                btn.style.pointerEvents = '';
            });
        }
    });

    return hasCalendars;
        } catch (error) {
        // ì—ëŸ¬ ì‹œ ê¸°ë³¸ì ìœ¼ë¡œ ë¹„í™œì„±í™” (ì¡°ìš©íˆ)
        const platformCards = document.querySelectorAll('.platform-card');
        platformCards.forEach(card => {
            card.classList.add('disabled');
        });
        return false;
    }
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ í†µê³„ ì—…ë°ì´íŠ¸
    document.addEventListener('DOMContentLoaded', async function () {
        // Check if we just came back from Google OAuth
        const urlParams = new URLSearchParams(window.location.search);
        const fromOAuth = urlParams.get('from_oauth') || document.referrer.includes('/auth/google/callback');
        if (fromOAuth) {
            console.log('Detected Google OAuth completion - setting flag');
            sessionStorage.setItem('google_oauth_completed', 'true');
            // Clean up URL
            if (urlParams.get('from_oauth')) {
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }

        try {
            // ì´ˆê¸° ë¡œë“œ (ì¡°ìš©íˆ)
            await checkCalendarsAndUpdatePlatforms();
            await updatePlatformStatus();
            await updateConnectionStats();
            // í†µê³„ ì—…ë°ì´íŠ¸ í›„ ê°€ì´ë“œ ì²´í¬
            checkAndHideGuide();
        } catch (error) {
            // ì—ëŸ¬ ì‹œ ê¸°ë³¸ê°’ ì„¤ì • (ì¡°ìš©íˆ)
            const connectedCountEl = document.getElementById('connected-count');
            const syncCountEl = document.getElementById('sync-count');
            const successRateEl = document.getElementById('success-rate');
            const syncSpeedEl = document.getElementById('sync-speed');
            
            if (connectedCountEl) connectedCountEl.textContent = '0';
            if (syncCountEl) syncCountEl.textContent = '0';
            if (successRateEl) successRateEl.textContent = '0%';
            if (syncSpeedEl) syncSpeedEl.textContent = 'N/A';
            // ì—ëŸ¬ ì‹œì—ë„ ê°€ì´ë“œ ì²´í¬
            checkAndHideGuide();
        }

        // 30ì´ˆë§ˆë‹¤ ì—…ë°ì´íŠ¸ (ì¡°ìš©íˆ)
        setInterval(async () => {
            try {
                await checkCalendarsAndUpdatePlatforms();
                await updatePlatformStatus();
                await updateConnectionStats();
            } catch (error) {
                // ì—ëŸ¬ ë¬´ì‹œ (ì¡°ìš©íˆ)
            }
        }, 30000);

        // íƒ­ í¬ì»¤ìŠ¤ ì‹œ ì—…ë°ì´íŠ¸ (ì¡°ìš©íˆ)
        document.addEventListener('visibilitychange', async function () {
            if (!document.hidden) {
                try {
                    await checkCalendarsAndUpdatePlatforms();
                    await updatePlatformStatus();
                    await updateConnectionStats();
                } catch (error) {
                    // ì—ëŸ¬ ë¬´ì‹œ (ì¡°ìš©íˆ)
                }
            }
        });
    });

    async function updateConnectionStats() {
        try {
            // ì„œë²„ì—ì„œ ë Œë”ë§ëœ ë°ì´í„° ì‚¬ìš© (ì¡°ìš©íˆ)
            const stats = {
                connected_count: {{ (stats.connected_count if stats and stats.connected_count else 0) | tojson }},
                synced_events: {{ (stats.synced_events if stats and stats.synced_events else 0) | tojson }},
                success_rate: {{ (stats.success_rate if stats and stats.success_rate else "0%") | tojson }},
                avg_sync_time: {{ (stats.avg_sync_time if stats and stats.avg_sync_time else "N/A") | tojson }}
            };

    // DOM ì—…ë°ì´íŠ¸ (null ì²´í¬ í¬í•¨)
    const connectedCountEl = document.getElementById('connected-count');
    const syncCountEl = document.getElementById('sync-count');
    const successRateEl = document.getElementById('success-rate');
    const syncSpeedEl = document.getElementById('sync-speed');
    
    if (connectedCountEl) connectedCountEl.textContent = stats.connected_count;
    if (syncCountEl) syncCountEl.textContent = stats.synced_events;
    if (successRateEl) successRateEl.textContent = stats.success_rate;
    if (syncSpeedEl) syncSpeedEl.textContent = stats.avg_sync_time;
        } catch (error) {
        // ì—ëŸ¬ ì‹œ ê¸°ë³¸ê°’ ì„¤ì • (ì¡°ìš©íˆ)
        const connectedCountEl = document.getElementById('connected-count');
        const syncCountEl = document.getElementById('sync-count');
        const successRateEl = document.getElementById('success-rate');
        const syncSpeedEl = document.getElementById('sync-speed');
        
        if (connectedCountEl) connectedCountEl.textContent = '0';
        if (syncCountEl) syncCountEl.textContent = '0';
        if (successRateEl) successRateEl.textContent = '0%';
        if (syncSpeedEl) syncSpeedEl.textContent = 'N/A';
    }
    }

    // ê°œë³„ í”Œë«í¼ ì›í´ë¦­ ì—°ë™ ê¸°ëŠ¥
    async function oneClickConnect(platform) {
        // Appleì˜ ê²½ìš° ìŠ¤ë§ˆíŠ¸ ë§ˆë²•ì‚¬ ì‹¤í–‰
        if (platform === 'apple') {
            const button = document.querySelector(`[data-platform="${platform}"] .one-click-btn-small`);

            if (button) {
                const loader = button.querySelector('.btn-loader');
                const buttonText = button.querySelector('.btn-text');

                // ë²„íŠ¼ ìƒíƒœ ë³€ê²½
                button.disabled = true;
                if (buttonText) buttonText.style.display = 'none';
                if (loader) loader.style.display = 'flex';

                // ì ê¹ ë¡œë”© í‘œì‹œ í›„ ë§ˆë²•ì‚¬ ì‹¤í–‰
                setTimeout(() => {
                    button.disabled = false;
                    if (buttonText) buttonText.style.display = 'inline';
                    if (loader) loader.style.display = 'none';
                }, 500);
            }

            if (window.appleWizard) {
                window.appleWizard.start(platform);
            } else {
                console.error('Apple Setup Wizard not loaded');
                showNotification('Apple ì„¤ì • ë§ˆë²•ì‚¬ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
            return;
        }

        const button = document.querySelector(`[data-platform="${platform}"] .one-click-btn-small`);

        if (!button) {
            console.error(`Button not found for platform: ${platform}`);
            showNotification(`${getKoreanPlatformName(platform)} ì—°ê²° ë²„íŠ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`, 'error');
            return;
        }

        const loader = button.querySelector('.btn-loader');
        const buttonText = button.querySelector('.btn-text');

        // ë²„íŠ¼ ìƒíƒœ ë³€ê²½
        button.disabled = true;
        if (buttonText) buttonText.style.display = 'none';
        if (loader) loader.style.display = 'flex';

        try {
            // OAuth ì§€ì› í”Œë«í¼ë“¤
            const oauthPlatforms = ['google', 'notion', 'slack', 'outlook'];

            if (oauthPlatforms.includes(platform)) {
                // OAuth í”Œë¡œìš° ì‹¤í–‰
                await performOAuthConnection(platform);
            } else {
                // ì¼ë°˜ API í‚¤ ë°©ì‹
                showNotification(`${getKoreanPlatformName(platform)} ì—°ê²°ì„ ìœ„í•´ ì„¤ì • í¼ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.`, 'info');
                togglePlatformDetails(platform);
            }

        } catch (error) {
            console.error(`${platform} ì—°ë™ ì¤‘ ì˜¤ë¥˜:`, error);
            showNotification(`${getKoreanPlatformName(platform)} ì—°ë™ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.`, 'error');
        } finally {
            // ë²„íŠ¼ ìƒíƒœ ë³µì›
            setTimeout(() => {
                button.disabled = false;
                if (buttonText) buttonText.style.display = 'inline';
                if (loader) loader.style.display = 'none';
            }, 1000);
        }
    }

    // OAuth ì—°ê²° ìˆ˜í–‰
    async function performOAuthConnection(platform) {
        try {
            // OAuth ì„¤ì • í™•ì¸
            const configCheck = await fetch(`/oauth/${platform}/check`);
            const configData = await configCheck.json();

            if (!configData.configured) {
                showNotification(
                    `${getKoreanPlatformName(platform)} OAuthê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ìˆ˜ë™ ì„¤ì •ì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.`,
                    'warning'
                );
                // ìˆ˜ë™ ì„¤ì • í¼ í‘œì‹œ
                togglePlatformDetails(platform);
                return;
            }

            const width = 500;
            const height = 700;
            const left = (screen.width - width) / 2;
            const top = (screen.height - height) / 2;

            const popup = window.open(
                `/oauth/${platform}/authorize`,
                `oauth_${platform}`,
                `width=${width},height=${height},left=${left},top=${top},scrollbars=yes,resizable=yes`
            );

            if (!popup) {
                throw new Error('íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. OAuth ì¸ì¦ì„ ìœ„í•´ íŒì—…ì„ í—ˆìš©í•´ì£¼ì„¸ìš”.');
            }

            // OAuth ì™„ë£Œ ëŒ€ê¸° - ë” ê¸´ íƒ€ì„ì•„ì›ƒìœ¼ë¡œ API ì²˜ë¦¬ ì‹œê°„ í™•ë³´
            return new Promise((resolve, reject) => {
                const checkInterval = 500;
                let timeoutCount = 0;
                const maxTimeout = 360; // 3ë¶„ íƒ€ì„ì•„ì›ƒ (API ì‘ë‹µ ëŒ€ê¸° ì‹œê°„ í™•ë³´)

                // íŒì—…ìœ¼ë¡œë¶€í„° ë©”ì‹œì§€ ìˆ˜ì‹  ëŒ€ê¸°
                const messageHandler = (event) => {
                    if (event.origin !== window.location.origin) {
                        return;
                    }

                    if (event.data && event.data.type) {
                        if (event.data.type === 'oauth_success') {
                            cleanup();

                            // Googleì˜ ê²½ìš° ìº˜ë¦°ë” ì„ íƒ íŒì—…ì„ í‘œì‹œ
                            if (event.data.platform === 'google') {
                                console.log('ğŸ“… Google OAuth ì„±ê³µ ì²˜ë¦¬ ì¤‘...');

                                // ë¨¼ì € í”Œë«í¼ì„ ì—°ê²°ëœ ìƒíƒœë¡œ í‘œì‹œ (ì—°ê²°í•´ì œ ë²„íŠ¼ ìƒì„±)
                                markPlatformConnected(event.data.platform);
                                updatePlatformStatus(event.data.platform, 'connected');
                                updateConnectionStats();
                                updatePlatformStatus();

                                // Google Calendar ì„ íƒ íŒì—… í‘œì‹œ
                                setTimeout(async () => {
                                    try {
                                        console.log('ğŸ“… Google ìº˜ë¦°ë” ì„ íƒ ëª¨ë‹¬ í‘œì‹œ...');
                                        await showCalendarSelectionModal('google');
                                        showNotification('Google Calendar ì—°ê²°ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                                    } catch (error) {
                                        console.error('Google Calendar ì„ íƒ ì˜¤ë¥˜:', error);
                                        showNotification('Google Calendar ì„ íƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                                    }
                                }, 500);

                                resolve(event.data);
                            } else if (event.data.platform === 'notion') {
                                // Notionì˜ ê²½ìš° ì‹¤ì œ ë™ê¸°í™” ì‹¤í–‰
                                console.log('ğŸ“… Notion OAuth ì„±ê³µ ì²˜ë¦¬ ì¤‘...');

                                // í™•ì‹¤í•˜ê²Œ ë¸”ëŸ¬ ì œê±°
                                removeAnyBlurEffects();

                                markPlatformConnected(event.data.platform);
                                updatePlatformStatus(event.data.platform, 'connected');
                                showNotification('Notion ì—°ê²°ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ìº˜ë¦°ë”ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'success');
                                updateConnectionStats();
                                updatePlatformStatus();

                                // ì‹¤ì œ ë™ê¸°í™” ì‹¤í–‰
                                setTimeout(async () => {
                                    try {
                                        // ë‹¤ì‹œ í•œë²ˆ ë¸”ëŸ¬ ì œê±° (ì•ˆì „ì¥ì¹˜)
                                        removeAnyBlurEffects();

                                        console.log('ğŸ“… Notion ìº˜ë¦°ë” ì„ íƒ ëª¨ë‹¬ í‘œì‹œ...');

                                        // ìº˜ë¦°ë” ì„ íƒ ëª¨ë‹¬ í‘œì‹œ
                                        await showCalendarSelectionModal('notion');

                                    } catch (modalError) {
                                        console.error('ìº˜ë¦°ë” ì„ íƒ ëª¨ë‹¬ ì˜¤ë¥˜:', modalError);
                                        showNotification('ìº˜ë¦°ë” ì„ íƒ ëª¨ë‹¬ì„ ì—¬ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                                    }
                                }, 500);

                                resolve(event.data);
                            } else {
                                // ë‹¤ë¥¸ í”Œë«í¼ì˜ ê²½ìš° ê¸°ì¡´ ë¡œì§ ìœ ì§€
                                markPlatformConnected(event.data.platform);
                                updatePlatformStatus(event.data.platform, 'connected');
                                showNotification(`${getKoreanPlatformName(event.data.platform)} ì—°ê²°ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!`, 'success');
                                updateConnectionStats();
                                updatePlatformStatus();
                                resolve(event.data);
                            }
                        } else if (event.data.type === 'oauth_error') {
                            cleanup();
                            console.error(`OAuth Error for ${platform}:`, event.data);

                            // ë” êµ¬ì²´ì ì¸ ì—ëŸ¬ ë©”ì‹œì§€ ì œê³µ
                            let errorMessage = event.data.error || 'OAuth ì¸ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤';
                            if (errorMessage.includes('Failed to exchange authorization code for tokens')) {
                                errorMessage = 'API ì‘ë‹µì´ ì§€ì—°ë˜ê³  ìˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                            } else if (errorMessage.includes('authorization_code') && errorMessage.includes('expired')) {
                                errorMessage = 'OAuth ì½”ë“œê°€ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì—°ê²°í•´ì£¼ì„¸ìš”.';
                            } else if (errorMessage.includes('invalid_grant') || errorMessage.includes('expired')) {
                                errorMessage = 'OAuth ì½”ë“œê°€ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì—°ê²°í•´ì£¼ì„¸ìš”.';
                            } else if (errorMessage.includes('timeout')) {
                                errorMessage = 'ì—°ê²° ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ ìƒíƒœë¥¼ í™•ì¸í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                            } else if (errorMessage.includes('rate limit')) {
                                errorMessage = 'API ìš”ì²­ í•œë„ì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤. 1ë¶„ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                            } else if (errorMessage.includes('access_denied')) {
                                errorMessage = 'ì‚¬ìš©ìê°€ OAuth ì¸ì¦ì„ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤.';
                            } else if (errorMessage.includes('Cross-Origin')) {
                                errorMessage = 'ë¸Œë¼ìš°ì € ì •ì±…ìœ¼ë¡œ ì¸í•œ ì¼ì‹œì  ì˜¤ë¥˜ì…ë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                            }

                            showNotification(`ì—°ê²° ì‹¤íŒ¨: ${errorMessage}`, 'error');
                            reject(new Error(errorMessage));
                        }
                    }
                };

                // íŒì—… ë‹«í˜ ê°ì§€ (Cross-Origin Policy ë¬¸ì œ í•´ê²°)
                const checkClosed = setInterval(() => {
                    try {
                        // popup.closed ì ‘ê·¼ì„ try-catchë¡œ ê°ì‹¸ì„œ Cross-Origin Policy ì˜¤ë¥˜ ë°©ì§€
                        if (popup.closed) {
                            cleanup();
                            reject(new Error('OAuth ì¸ì¦ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤'));
                            return;
                        }
                    } catch (e) {
                        // Cross-Origin Policyë¡œ popup.closedì— ì ‘ê·¼í•  ìˆ˜ ì—†ëŠ” ê²½ìš°
                        // ì´ëŠ” ë³´í†µ íŒì—…ì´ ë‹¤ë¥¸ ë„ë©”ì¸ìœ¼ë¡œ ì´ë™í–ˆìŒì„ ì˜ë¯¸í•˜ë¯€ë¡œ ì •ìƒì ì¸ ìƒí™©
                        console.log('íŒì—…ì´ OAuth í˜ì´ì§€ë¡œ ì´ë™í–ˆìŠµë‹ˆë‹¤ (ì •ìƒ)');
                    }

                    timeoutCount++;
                    if (timeoutCount >= maxTimeout) {
                        cleanup();
                        try {
                            if (!popup.closed) {
                                popup.close();
                            }
                        } catch (e) {
                            // popup.close() ì‹¤íŒ¨ ì‹œì—ë„ ì²˜ë¦¬ ê³„ì†
                            console.log('íŒì—… ë‹«ê¸° ì‹¤íŒ¨ (ì´ë¯¸ ë‹«í˜”ì„ ìˆ˜ ìˆìŒ)');
                        }
                        reject(new Error('OAuth ì¸ì¦ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. API ì„œë²„ ì‘ë‹µì´ ì§€ì—°ë˜ê³  ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.'));
                    }
                }, checkInterval);

                const cleanup = () => {
                    console.log('ğŸ§¹ OAuth íŒì—… cleanup ì‹œì‘...');

                    // ë¸”ëŸ¬ íš¨ê³¼ ì œê±°
                    removeAnyBlurEffects();

                    window.removeEventListener('message', messageHandler);
                    clearInterval(checkClosed);
                    try {
                        // Cross-Origin Policyë¡œ popup.closed ì ‘ê·¼ì´ ì°¨ë‹¨ë  ìˆ˜ ìˆìŒ
                        if (popup && !popup.closed) {
                            popup.close();
                        }
                    } catch (e) {
                        // Cross-Origin ì œí•œìœ¼ë¡œ popup ìƒíƒœ í™•ì¸ ë¶ˆê°€ëŠ¥í•œ ê²½ìš°
                        console.log('íŒì—… ì •ë¦¬ ì¤‘ Cross-Origin ì œí•œ (ì •ìƒ):', e.message);
                        try {
                            // ê·¸ë˜ë„ ë‹«ê¸° ì‹œë„
                            popup.close();
                        } catch (closeError) {
                            console.log('íŒì—… ë‹«ê¸° ìµœì¢… ì‹œë„ ì‹¤íŒ¨ (ì •ìƒ)');
                        }
                    }
                };

                window.addEventListener('message', messageHandler);
            });
        } catch (error) {
            console.error('OAuth ì—°ê²° ì‹¤íŒ¨:', error);
            throw error;
        }
    }

    // í”Œë«í¼ ìƒíƒœ ì—…ë°ì´íŠ¸
    function updatePlatformStatus(platform, status) {
        const card = document.querySelector(`[data-platform="${platform}"]`);
        if (!card) return;

        const statusElement = card.querySelector('.platform-status');
        const connectBtn = card.querySelector('.platform-connect-btn');
        const disconnectBtn = card.querySelector('.platform-disconnect-btn');
        const syncBtn = card.querySelector('.platform-sync-btn');

        if (status === 'connected') {
            statusElement.className = 'platform-status connected';
            statusElement.innerHTML = '<span class="status-dot"></span>ì—°ê²°ë¨';

            // ê¸°ì¡´ ì—°ê²° ë²„íŠ¼ ìˆ¨ê¸°ê¸° (ì›í´ë¦­ ë²„íŠ¼ì´ ì—°ê²°í•´ì œ ì—­í• ì„ í•¨)
            if (connectBtn) {
                connectBtn.style.display = 'none';
            }

            // ì›í´ë¦­ ë²„íŠ¼ì„ ì—°ê²°í•´ì œ ë²„íŠ¼ìœ¼ë¡œ ë³€ê²½
            const oneClickBtn = card.querySelector('.one-click-btn-small');
            if (oneClickBtn) {
                // Google Calendarì˜ ê²½ìš° ì‘ì€ ë²„íŠ¼ ìˆ¨ê¸°ê³  ì—°ê²°í•´ì œ ë²„íŠ¼ë§Œ ì¶”ê°€
                if (platform === 'google') {
                    // Google Calendarì˜ ê²½ìš° ì—°ê²°í•´ì œ ë²„íŠ¼ì„ ì¶”ê°€
                    const actionContainer = oneClickBtn.parentElement;
                    const syncBtn = card.querySelector('.platform-sync-btn');

                    // Google ì—°ê²°í•´ì œ ë²„íŠ¼ì€ markPlatformConnected í•¨ìˆ˜ì—ì„œë§Œ ìƒì„± (ì¤‘ë³µ ë°©ì§€)

                    // ì›í´ë¦­ ë²„íŠ¼ì€ ìˆ¨ê¸°ê¸°
                    oneClickBtn.style.display = 'none';
                } else {
                    // ë‹¤ë¥¸ í”Œë«í¼ì€ ê¸°ì¡´ ë¡œì§ ìœ ì§€
                    oneClickBtn.className = 'one-click-disconnect-btn';
                    oneClickBtn.setAttribute('onclick', `oneClickDisconnect('${platform}')`);
                    oneClickBtn.innerHTML = `
                        <span class="btn-text">ì—°ê²°í•´ì œ</span>
                        <div class="btn-loader" style="display: none;">
                            <div class="loader-spinner"></div>
                        </div>
                    `;
                }
            }

            // ìº˜ë¦°ë” ë³€ê²½ ë²„íŠ¼ í‘œì‹œ (ì´ë¯¸ ì—°ê²°ë˜ì–´ ìˆì–´ë„ ë³€ê²½ ê°€ëŠ¥)
            if (syncBtn) {
                syncBtn.style.display = 'block';
                const syncText = syncBtn.querySelector('.sync-text');
                if (syncText) {
                    if (syncText) syncText.textContent = 'ìº˜ë¦°ë” ë³€ê²½';
                }
            }
        } else {
            statusElement.className = 'platform-status disconnected';
            statusElement.innerHTML = '<span class="status-dot"></span>ì—°ê²°ë˜ì§€ ì•ŠìŒ';

            // ì—°ê²° ë²„íŠ¼ì„ ë‹¤ì‹œ í‘œì‹œ
            if (connectBtn) {
                connectBtn.style.display = 'inline-flex';
            }

            // ì—°ê²°í•´ì œ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
            if (disconnectBtn) {
                disconnectBtn.style.display = 'none';
            }

            // ì›í´ë¦­ ë²„íŠ¼ì„ ì›ë˜ ìƒíƒœë¡œ ë˜ëŒë¦¬ê¸°
            const oneClickDisconnectBtn = card.querySelector('.one-click-disconnect-btn');
            const oneClickChangeBtn = card.querySelector('.one-click-change-btn');
            const googleDisconnectBtn = card.querySelector('.google-disconnect-btn');

            // Google Calendarì˜ ê²½ìš° ì¶”ê°€ ë²„íŠ¼ë“¤ ì •ë¦¬
            if (platform === 'google') {
                // ìˆ¨ê²¨ì§„ ì›í´ë¦­ ë²„íŠ¼ì„ ë‹¤ì‹œ í‘œì‹œ
                const oneClickBtn = card.querySelector('.one-click-btn-small');
                if (oneClickBtn) {
                    oneClickBtn.style.display = 'inline-flex';
                }

                // Google ì „ìš© ì—°ê²°í•´ì œ ë²„íŠ¼ ì œê±°
                if (googleDisconnectBtn) {
                    googleDisconnectBtn.remove();
                }
            } else {
                // ë‹¤ë¥¸ í”Œë«í¼ì€ ê¸°ì¡´ ë¡œì§ ìœ ì§€
                if (oneClickDisconnectBtn) {
                    oneClickDisconnectBtn.className = 'one-click-btn-small';
                    oneClickDisconnectBtn.setAttribute('onclick', `oneClickConnect('${platform}')`);
                    oneClickDisconnectBtn.innerHTML = `
                        <span class="btn-text">ì›í´ë¦­</span>
                        <div class="btn-loader" style="display: none;">
                            <div class="loader-spinner"></div>
                        </div>
                    `;
                }
            }

            // ì—°ê²°ë˜ì§€ ì•Šì€ ìƒíƒœì—ì„œëŠ” ìº˜ë¦°ë” ì—°ë™ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
            const syncBtn = card.querySelector('.platform-sync-btn');
            if (syncBtn) {
                syncBtn.style.display = 'none';
            }
        }
    }

    // í”Œë«í¼ ì„¸ë¶€ì‚¬í•­ í† ê¸€
    function togglePlatformDetails(platform) {
        const details = document.getElementById(`${platform}-details`);
        if (details) {
            const isVisible = details.style.display !== 'none';
            details.style.display = isVisible ? 'none' : 'block';

            const expandBtn = document.querySelector(`[data-platform="${platform}"] .platform-expand-btn`);
            if (expandBtn) {
                expandBtn.style.transform = isVisible ? 'rotate(0deg)' : 'rotate(180deg)';
            }
        }
    }

    // ìº˜ë¦°ë” ì—°ë™ ëª¨ë‹¬ ì—´ê¸°

    // ìº˜ë¦°ë” ì„ íƒ
    window.selectedCalendarId = null;
    window.selectedCalendarName = null;

    function selectCalendar(calendarId, calendarName) {
        // ì´ì „ ì„ íƒ í•´ì œ
        document.querySelectorAll('.calendar-card').forEach(card => {
            card.classList.remove('selected');
        });

        // ìƒˆ ì„ íƒ ì ìš©
        const selectedCard = document.querySelector(`[data-calendar-id="${calendarId}"]`);
        if (selectedCard) {
            selectedCard.classList.add('selected');
        }

        window.selectedCalendarId = calendarId;
        window.selectedCalendarName = calendarName;

        // ë‹¤ìŒ ë²„íŠ¼ í™œì„±í™”
        const nextBtn = document.getElementById('next-step-btn');
        if (nextBtn) {
            nextBtn.disabled = false;
        }
    }

    // ë‹¤ìŒ ë‹¨ê³„ë¡œ ì´ë™
    function nextSyncStep() {
        const currentStep = document.querySelector('.step.active');
        const currentStepNumber = parseInt(currentStep.dataset.step);

        if (currentStepNumber === 1) {
            // 1ë‹¨ê³„ â†’ 2ë‹¨ê³„
            currentStep.classList.remove('active');
            document.querySelector('[data-step="2"]').classList.add('active');

            document.getElementById('step1').classList.add('hidden');
            document.getElementById('step2').classList.remove('hidden');

            // ì„ íƒëœ ìº˜ë¦°ë” ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
            const preview = document.getElementById('selected-calendar-preview');
            if (preview && window.selectedCalendarName) {
                preview.innerHTML = `
                    <div class="calendar-preview">
                        <h6>${window.selectedCalendarName}</h6>
                        <p>ì„ íƒëœ ìº˜ë¦°ë”ì…ë‹ˆë‹¤.</p>
                    </div>
                `;
            }

            // ë²„íŠ¼ ìƒíƒœ ë³€ê²½
            document.getElementById('next-step-btn').classList.add('hidden');
            document.getElementById('sync-btn').classList.remove('hidden');

        } else if (currentStepNumber === 2) {
            // 2ë‹¨ê³„ â†’ 3ë‹¨ê³„ëŠ” performSyncì—ì„œ ì²˜ë¦¬
        }
    }

    // ì—°ë™ ìˆ˜í–‰
    async function performSync(platform) {
        if (!window.selectedCalendarId) {
            showNotification('ìº˜ë¦°ë”ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
            return;
        }

        const syncBtn = document.getElementById('sync-btn');
        const originalText = syncBtn.textContent;

        try {
            syncBtn.disabled = true;
            syncBtn.innerHTML = '<div class="loader-spinner"></div> ì—°ë™ ì¤‘...';

            // ì—°ë™ API í˜¸ì¶œ
            const response = await fetch('/api/calendar/connect-platform', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    platform: platform,
                    calendar_id: window.selectedCalendarId,
                    import_existing: document.getElementById('import-existing')?.checked || false,
                    real_time_sync: document.getElementById('real-time-sync')?.checked || true
                })
            });

            const result = await response.json();

            if (result.success) {
                // 3ë‹¨ê³„ë¡œ ì´ë™
                document.querySelector('.step.active').classList.remove('active');
                document.querySelector('[data-step="3"]').classList.add('active');

                document.getElementById('step2').classList.add('hidden');
                document.getElementById('step3').classList.remove('hidden');

                // ì™„ë£Œ ì •ë³´ ì—…ë°ì´íŠ¸
                const syncedCalendarNameEl = document.getElementById('synced-calendar-name');
                if (syncedCalendarNameEl) syncedCalendarNameEl.textContent = window.selectedCalendarName;

                // ë²„íŠ¼ ìƒíƒœ ë³€ê²½
                document.getElementById('sync-btn').classList.add('hidden');
                document.getElementById('complete-btn').classList.remove('hidden');

                // í”Œë«í¼ ìƒíƒœ ì—…ë°ì´íŠ¸
                updatePlatformSyncStatus(platform, window.selectedCalendarName);

                showNotification(`${platform} ì—°ë™ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!`, 'success');
            } else {
                throw new Error(result.error || 'ì—°ë™ ì‹¤íŒ¨');
            }

        } catch (error) {
            console.error('Sync error:', error);
            showNotification(`ì—°ë™ ì‹¤íŒ¨: ${error.message}`, 'error');

            syncBtn.disabled = false;
            if (syncBtn) syncBtn.textContent = originalText;
        }
    }

    // ì—°ë™ ìƒíƒœ ì—…ë°ì´íŠ¸
    function updatePlatformSyncStatus(platform, calendarName) {
        const card = document.querySelector(`[data-platform="${platform}"]`);
        if (!card) return;

        const syncBtn = card.querySelector('.platform-sync-btn');
        if (syncBtn) {
            const syncText = syncBtn.querySelector('.sync-text');
            if (syncText) {
                if (syncText) syncText.textContent = `ì—°ë™ë¨: ${calendarName}`;
                syncBtn.classList.add('synced');
                syncBtn.title = `${calendarName}ê³¼ ì—°ë™ë¨`;
            }

            // X ë²„íŠ¼ ì¶”ê°€ ì œê±° - ì—°ê²°í•´ì œ ë²„íŠ¼ì´ ì´ë¯¸ ë³„ë„ë¡œ ìˆìŒ
            // ì¤‘ë³µ ë²„íŠ¼ ìƒì„± ë°©ì§€
        }
    }

    // ì—°ë™ í•´ì œ
    async function disconnectPlatformSync(platform) {
        if (!confirm(`${platform} ìº˜ë¦°ë” ì—°ë™ì„ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
            return;
        }

        try {
            const response = await fetch('/api/calendar/disconnect-platform', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ platform: platform })
            });

            const result = await response.json();

            if (result.success) {
                // UI ìƒíƒœ ë˜ëŒë¦¬ê¸°
                const card = document.querySelector(`[data-platform="${platform}"]`);
                const syncBtn = card?.querySelector('.platform-sync-btn');
                if (syncBtn) {
                    const syncText = syncBtn.querySelector('.sync-text');
                    if (syncText) {
                        if (syncText) syncText.textContent = 'ìº˜ë¦°ë” ì—°ë™';
                    }
                    syncBtn.classList.remove('synced');
                    syncBtn.title = '';

                    const disconnectBtn = syncBtn.querySelector('.sync-disconnect-btn');
                    if (disconnectBtn) {
                        disconnectBtn.remove();
                    }
                }

                showNotification(`${platform} ì—°ë™ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
            } else {
                throw new Error(result.error || 'ì—°ë™ í•´ì œ ì‹¤íŒ¨');
            }

        } catch (error) {
            console.error('Disconnect error:', error);
            showNotification(`ì—°ë™ í•´ì œ ì‹¤íŒ¨: ${error.message}`, 'error');
        }
    }

    // ëª¨ë‹¬ ë‹«ê¸°
    function closeCalendarSyncModal() {
        const modal = document.getElementById('calendar-sync-modal');
        if (modal) {
            modal.remove();
        }

        // ì „ì—­ ë³€ìˆ˜ ì´ˆê¸°í™”
        window.selectedCalendarId = null;
        window.selectedCalendarName = null;
    }

    // ìº˜ë¦°ë” ì•ˆë‚´ ê´€ë ¨ í•¨ìˆ˜ë“¤
    function hideCalendarGuide() {
        const guide = document.getElementById('calendar-setup-guide');
        if (guide) {
            guide.style.animation = 'slideOutUp 0.3s ease-in forwards';
            setTimeout(() => {
                guide.classList.add('hidden');
            }, 300);

            // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ìˆ¨ê¹€ ìƒíƒœ ì €ì¥
            localStorage.setItem('calendar_guide_hidden', 'true');
        }
    }

    // ì—°ê²°ëœ í”Œë«í¼ì´ ìˆìœ¼ë©´ ìë™ìœ¼ë¡œ ì•ˆë‚´ ìˆ¨ê¸°ê¸°
    function checkAndHideGuide() {
        const guide = document.getElementById('calendar-setup-guide');
        if (!guide) return;

        const isHidden = localStorage.getItem('calendar_guide_hidden') === 'true';

        // ì „ì—­ ë³€ìˆ˜ hasCalendar ì‚¬ìš© (ìœ„ì—ì„œ ì„¤ì •ë¨)
        if (typeof hasCalendar !== 'undefined' && (hasCalendar || isHidden)) {
            guide.style.display = 'none';
        } else if (!isHidden) {
            guide.style.display = 'block';
        }
    }

    // ìº˜ë¦°ë” ë™ê¸°í™” ëª¨ë‹¬ ì—´ê¸° (ê¸°ì¡´ ìº˜ë¦°ë” ì„ íƒ ëª¨ë‹¬ ì‚¬ìš©)
    async function openCalendarSyncModal(platform) {
        console.log('ğŸ“… ìº˜ë¦°ë” ë³€ê²½ ëª¨ë‹¬ ì—´ê¸°, platform:', platform);

        // ê¸°ì¡´ ìº˜ë¦°ë” ì„ íƒ ëª¨ë‹¬ ì‚¬ìš©
        await showCalendarSelectionModal(platform);
    }

    // í”Œë«í¼ ì—°ê²° í‘œì‹œ í•¨ìˆ˜ (markPlatformConnected)
    function markPlatformConnected(platform) {
        const card = document.querySelector(`[data-platform="${platform}"]`);
        if (!card) return;

        // ê¸°ì¡´ ì¤‘ë³µ ë²„íŠ¼ë“¤ ì œê±° (ì¤‘ë³µ ë°©ì§€)
        const existingGoogleDisconnectBtns = card.querySelectorAll('.google-disconnect-btn');
        existingGoogleDisconnectBtns.forEach(btn => btn.remove());
        console.log(`ğŸ§¹ ${platform} ê¸°ì¡´ ì—°ê²°í•´ì œ ë²„íŠ¼ ${existingGoogleDisconnectBtns.length}ê°œ ì œê±°ë¨`);

        // í”Œë«í¼ ìƒíƒœë¥¼ ì—°ê²°ë¨ìœ¼ë¡œ í‘œì‹œ
        const statusElement = card.querySelector('.platform-status');
        if (statusElement) {
            statusElement.className = 'platform-status connected';
            statusElement.innerHTML = '<span class="status-dot"></span>ì—°ê²°ë¨';
        }

        // ì—°ê²° ë²„íŠ¼ì„ ì—°ê²°í•´ì œ ë²„íŠ¼ìœ¼ë¡œ ë³€ê²½
        const connectBtn = card.querySelector('.platform-connect-btn');
        const oneClickBtn = card.querySelector('.one-click-btn-small');

        if (connectBtn) {
            connectBtn.className = 'platform-disconnect-btn';
            connectBtn.setAttribute('onclick', `disconnectPlatform('${platform}')`);
            const buttonText = connectBtn.querySelector('.connect-text');
            if (buttonText) {
                buttonText.textContent = 'ì—°ê²° í•´ì œ';
            }
        }

        // ì›í´ë¦­ ë²„íŠ¼ì„ ì—°ê²°í•´ì œ ë²„íŠ¼ìœ¼ë¡œ ë³€ê²½
        if (oneClickBtn) {
            const buttonText = oneClickBtn.querySelector('.btn-text');
            if (buttonText) {
                buttonText.textContent = 'ì—°ê²°í•´ì œ';
            }
            oneClickBtn.setAttribute('onclick', `oneClickDisconnect('${platform}')`);
            oneClickBtn.className = 'google-disconnect-btn';
        }

        // ğŸ¯ ìº˜ë¦°ë” ë™ê¸°í™” ë²„íŠ¼ í‘œì‹œ (ì¤‘ìš”!)
        const syncBtn = card.querySelector('.platform-sync-btn');
        if (syncBtn) {
            syncBtn.style.display = 'inline-flex';
            syncBtn.style.visibility = 'visible';
            const syncText = syncBtn.querySelector('.sync-text');
            if (syncText) {
                syncText.textContent = 'ìº˜ë¦°ë” ë³€ê²½';
            }
            console.log(`âœ… ${platform} ìº˜ë¦°ë” ë³€ê²½ ë²„íŠ¼ í‘œì‹œë¨ (display: ${syncBtn.style.display})`);
        } else {
            console.error(`âŒ ${platform} ìº˜ë¦°ë” ë³€ê²½ ë²„íŠ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ`);
        }
    }

    // loadAllPlatformStatus í•¨ìˆ˜ ì •ì˜ (updatePlatformStatusë¥¼ ì‚¬ìš©)
    async function loadAllPlatformStatus() {
        await updatePlatformStatus();
    }

    // loadSyncedCalendars í•¨ìˆ˜ ì •ì˜ (checkCalendarsAndUpdatePlatformsë¥¼ ì‚¬ìš©)
    async function loadSyncedCalendars() {
        await checkCalendarsAndUpdatePlatforms();
    }

    // ê°•í™”ëœ ë¸”ëŸ¬ íš¨ê³¼ ì œê±° í•¨ìˆ˜
    function removeAnyBlurEffects() {
        console.log('ğŸ”§ ê°•í™”ëœ ë¸”ëŸ¬ íš¨ê³¼ ì œê±° ì¤‘...');

        // 1. ìˆ¨ê²¨ì§„ ì˜¤ë²„ë ˆì´ë“¤ ì°¾ì•„ì„œ ì œê±°
        const overlays = [
            '#sync-modal-overlay',
            '.calendar-overlay-form',
            '.modal-overlay',
            '.popup-overlay',
            '.event-creation-popup',
            '[style*="backdrop-filter"]',
            '[style*="filter: blur"]'
        ];

        overlays.forEach(selector => {
            const elements = document.querySelectorAll(selector);
            elements.forEach(element => {
                console.log(`ğŸ”§ ì˜¤ë²„ë ˆì´ ìš”ì†Œ ì²˜ë¦¬: ${selector}`, element);
                element.style.display = 'none';
                element.style.filter = '';
                element.style.backdropFilter = '';
                element.style.zIndex = '';
            });
        });

        // 2. ëª¨ë“  ê°€ëŠ¥í•œ ë¸”ëŸ¬/í•„í„° ìŠ¤íƒ€ì¼ ì™„ì „ ì œê±°
        const allElements = document.querySelectorAll('*');
        allElements.forEach(el => {
            if (el.style.filter && el.style.filter.includes('blur')) {
                console.log('ğŸ”§ ë¸”ëŸ¬ ìŠ¤íƒ€ì¼ ì œê±°:', el);
                el.style.filter = '';
                el.style.removeProperty('filter');
            }
            if (el.style.backdropFilter) {
                el.style.backdropFilter = '';
                el.style.removeProperty('backdrop-filter');
            }
        });

        // 3. bodyì™€ ê´€ë ¨ í´ë˜ìŠ¤ ì™„ì „ ì •ë¦¬
        document.body.classList.remove('modal-open', 'blur', 'blurred');
        document.body.style.filter = '';
        document.body.style.backdropFilter = '';
        document.body.style.removeProperty('filter');
        document.body.style.removeProperty('backdrop-filter');
        document.documentElement.style.filter = '';
        document.documentElement.style.backdropFilter = '';

        // 4. ê°•ì œ CSS ì£¼ì…ìœ¼ë¡œ ë¸”ëŸ¬ íš¨ê³¼ ì™„ì „ ì°¨ë‹¨
        let forceStyleId = 'force-no-blur-style';
        let existingStyle = document.getElementById(forceStyleId);
        if (existingStyle) existingStyle.remove();

        const forceStyle = document.createElement('style');
        forceStyle.id = forceStyleId;
        forceStyle.textContent = `
            * {
                filter: none !important;
                backdrop-filter: none !important;
            }
            .main-content, .dashboard-content, .content-wrapper {
                filter: none !important;
                backdrop-filter: none !important;
                opacity: 1 !important;
                pointer-events: auto !important;
            }
            .sidebar {
                z-index: 100;
            }
        `;
        document.head.appendChild(forceStyle);

        // 5. 3ì´ˆ í›„ ì„ì‹œ ìŠ¤íƒ€ì¼ ì œê±°
        setTimeout(() => {
            const tempStyle = document.getElementById(forceStyleId);
            if (tempStyle) tempStyle.remove();
        }, 3000);

        console.log('âœ… ê°•í™”ëœ ë¸”ëŸ¬ íš¨ê³¼ ì œê±° ì™„ë£Œ');
    }

    // í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ í›„ ì—°ë™ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
    document.addEventListener('DOMContentLoaded', async function () {
        // ë¸”ëŸ¬ íš¨ê³¼ ì œê±°
        removeAnyBlurEffects();

        // ë¨¼ì € í”Œë«í¼ ì—°ê²° ìƒíƒœë¥¼ ë¡œë“œí•˜ê³  UIë¥¼ ì´ˆê¸°í™”
        await loadAllPlatformStatus(); // Load platform connection states first
        // ê·¸ ë‹¤ìŒì— ìº˜ë¦°ë” ë™ê¸°í™” ì •ë³´ë¥¼ ë¡œë“œ (ì‹¤ì œ ì—°ë™ëœ ê²½ìš°ì—ë§Œ ì—…ë°ì´íŠ¸)
        await loadSyncedCalendars();
    });

    // í˜ì´ì§€ í´ë¦­ ì‹œ ë¸”ëŸ¬ íš¨ê³¼ ì œê±° (ì•ˆì „ì¥ì¹˜)
    document.addEventListener('click', function() {
        // 3ì´ˆ í›„ì— ë¸”ëŸ¬ íš¨ê³¼ ì œê±° (ë”œë ˆì´ë¥¼ ë‘ì–´ ì˜ë„ì¹˜ ì•Šì€ ì œê±° ë°©ì§€)
        setTimeout(removeAnyBlurEffects, 3000);
    });

</script>
{% endblock %}