{% extends "base_dashboard.html" %}

{% block title %}API Keys - NotionFlow{% endblock %}

{% block extra_css %}
<link rel="stylesheet"
    href="{{ url_for('static', filename='css/api-keys-redesign.css') }}?v={{ range(100000, 999999) | random }}">
{% endblock %}

{% block content %}
<!-- API í‚¤ ê´€ë¦¬ ë©”ì¸ ì»¨í…Œì´ë„ˆ -->
<div class="api-container">

    <!-- í—¤ë” ì„¹ì…˜ -->
    <div class="api-header-container">
        <div class="api-header">
            <div class="api-title-section">
                <h1 class="api-main-title">ğŸ”‘ API í‚¤ ê´€ë¦¬</h1>
                <p class="api-subtitle">í”Œë«í¼ê³¼ ì•ˆì „í•˜ê²Œ ì—°ê²°í•˜ê³  ìº˜ë¦°ë”ë¥¼ ë™ê¸°í™”í•˜ì„¸ìš”</p>
            </div>
        </div>

        <!-- ìƒíƒœ ìš”ì•½ ì¹´ë“œ -->
        <div class="api-status-cards">
            <div class="status-card active">
                <div class="status-icon">ğŸ”—</div>
                <div class="status-content">
                    <div class="status-number" id="connected-count">{{ stats.connected_count if stats else 0 }}</div>
                    <div class="status-label">ì—°ê²°ëœ í”Œë«í¼</div>
                </div>
            </div>
            <div class="status-card">
                <div class="status-icon">ğŸ“…</div>
                <div class="status-content">
                    <div class="status-number" id="sync-count">{{ stats.synced_events if stats else 0 }}</div>
                    <div class="status-label">ë™ê¸°í™”ëœ ì´ë²¤íŠ¸</div>
                </div>
            </div>
            <div class="status-card">
                <div class="status-icon">âœ…</div>
                <div class="status-content">
                    <div class="status-number success" id="success-rate">{{ stats.success_rate if stats else "0%" }}
                    </div>
                    <div class="status-label">ì„±ê³µë¥ </div>
                </div>
            </div>
            <div class="status-card">
                <div class="status-icon">âš¡</div>
                <div class="status-content">
                    <div class="status-number" id="sync-speed">{{ stats.avg_sync_time if stats else 'N/A' }}</div>
                    <div class="status-label">í‰ê·  ë™ê¸°í™” ì‹œê°„</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ìº˜ë¦°ë” ìƒì„± ì•ˆë‚´ ì„¹ì…˜ -->
    <div class="calendar-setup-guide" id="calendar-setup-guide">
        <div class="guide-card">
            <div class="guide-content">
                <h3 class="guide-title">ğŸ¯ ì‹œì‘í•˜ê¸° ì „ì—</h3>
                <p class="guide-description">
                    í”Œë«í¼ì„ ì—°ê²°í•˜ê¸° ì „ì— ë¨¼ì € <strong>ìº˜ë¦°ë”ë¥¼ ìƒì„±</strong>í•´ì•¼ í•©ë‹ˆë‹¤.<br>
                    ìº˜ë¦°ë”ê°€ ìˆì–´ì•¼ ê° í”Œë«í¼ì˜ ì´ë²¤íŠ¸ë¥¼ ë™ê¸°í™”í•  ìˆ˜ ìˆì–´ìš”!
                </p>
                <div class="guide-steps">
                    <div class="step-item">
                        <span class="step-number">1</span>
                        <span class="step-text">ìº˜ë¦°ë” ìƒì„±í•˜ê¸°</span>
                    </div>
                    <div class="step-item">
                        <span class="step-number">2</span>
                        <span class="step-text">í”Œë«í¼ ì—°ê²°í•˜ê¸°</span>
                    </div>
                    <div class="step-item">
                        <span class="step-number">3</span>
                        <span class="step-text">ìë™ ë™ê¸°í™” ì‹œì‘</span>
                    </div>
                </div>
                <div class="guide-actions">
                    <a href="/calendar" class="guide-btn primary">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path
                                d="M8 2v4M16 2v4M3 10h18M5 4h14a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2z" />
                        </svg>
                        ìº˜ë¦°ë” ìƒì„±í•˜ê¸°
                    </a>
                    <button class="guide-btn secondary" onclick="hideCalendarGuide()">
                        ë‚˜ì¤‘ì— í•˜ê¸°
                    </button>
                </div>
            </div>
            <button class="guide-close" onclick="hideCalendarGuide()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6l-12 12M6 6l12 12" />
                </svg>
            </button>
        </div>
    </div>

    <!-- í”Œë«í¼ ì—°ê²° ì„¹ì…˜ -->
    <div class="platforms-section">

        <!-- Notion ì—°ê²° ì¹´ë“œ -->
        <div class="platform-card" data-platform="notion">
            <div class="platform-header">
                <div class="platform-info">
                    <div class="platform-icon notion">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M4.459 4.208c.746.606 1.026.56 2.428.466l13.215-.793c.28 0 .047-.28-.046-.326L17.86 1.968c-.42-.326-.981-.7-2.055-.607L3.01 2.295c-.466.046-.56.28-.374.466zm.793 3.08v13.904c0 .747.373 1.027 1.214.98l14.523-.84c.841-.046 1.121-.56 1.121-1.167V6.354c0-.606-.233-.933-.747-.887l-15.177.887c-.56.047-.934.373-.934 1.027zm13.748.327c.093.42 0 .84-.42.888l-.7.14v10.264c-.608.327-1.168.514-1.635.514-.748 0-.935-.234-1.495-.933l-4.577-7.186v6.952L12.21 19s0 .84-1.168.84l-3.222.186c-.093-.186 0-.653.327-.746l.84-.233V9.854L7.822 9.76c-.094-.42.14-1.026.793-1.073l3.456-.233 4.764 7.279v-6.44l-1.215-.139c-.093-.514.28-.887.747-.933z" />
                        </svg>
                    </div>
                    <div class="platform-details">
                        <h3 class="platform-name">Notion</h3>
                        <div class="platform-status disconnected">
                            <span class="status-dot"></span>
                            ì—°ê²°ë˜ì§€ ì•ŠìŒ
                        </div>
                    </div>
                </div>
                <div class="platform-actions">
                    <button class="one-click-btn-small" onclick="oneClickConnect('notion')" data-platform="notion">
                        <span class="btn-text">ì›í´ë¦­</span>
                        <div class="btn-loader" style="display: none;">
                            <div class="loader-spinner"></div>
                        </div>
                    </button>
                    <button class="platform-sync-btn" onclick="openCalendarSyncModal('notion')" data-platform="notion"
                        style="display: none;">
                        <span class="sync-text">ìº˜ë¦°ë” ì—°ë™</span>
                        <div class="sync-loader" style="display: none;">
                            <div class="loader-dot"></div>
                        </div>
                    </button>
                    <button class="platform-connect-btn" onclick="connectPlatform('notion')" data-platform="notion">
                        <span class="connect-text">ì—°ê²°í•˜ê¸°</span>
                        <div class="connect-loader" style="display: none;">
                            <div class="loader-dot"></div>
                        </div>
                    </button>
                    <button class="platform-expand-btn" onclick="togglePlatformDetails('notion')">
                        <svg class="expand-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M6 9l6 6 6-6" />
                        </svg>
                    </button>
                </div>
            </div>

            <!-- ì—°ê²° ìƒì„¸ í¼ -->
            <div class="platform-details-form" id="notion-details" style="display: none;">
                <div class="form-group">
                    <label for="notion-token">Internal Integration Token</label>
                    <input type="password" id="notion-token" name="notion-token" placeholder="secret_ìœ¼ë¡œ ì‹œì‘í•˜ëŠ” í† í°ì„ ì…ë ¥í•˜ì„¸ìš”">
                    <small class="form-help">
                        <a href="https://www.notion.so/my-integrations" target="_blank" class="help-link">
                            ğŸ“– í† í° ë°œê¸‰ë°›ê¸°
                        </a>
                        | í˜ì´ì§€ ì ‘ê·¼ ê¶Œí•œ í•„ìš”
                    </small>
                </div>
                <div class="form-actions">
                    <button class="btn btn-secondary" onclick="togglePlatformDetails('notion')">ì·¨ì†Œ</button>
                    <button class="btn btn-primary" onclick="connectPlatform('notion')">
                        <span class="loading-spinner" style="display: none;"></span>
                        ì—°ê²°í•˜ê¸°
                    </button>
                </div>
            </div>
        </div>

        <!-- Google Calendar ì—°ê²° ì¹´ë“œ -->
        <div class="platform-card" data-platform="google">
            <div class="platform-header">
                <div class="platform-info">
                    <div class="platform-icon google">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z" />
                        </svg>
                    </div>
                    <div class="platform-details">
                        <h3 class="platform-name">Google Calendar</h3>
                        <div class="platform-status disconnected">
                            <span class="status-dot"></span>
                            ì—°ê²°ë˜ì§€ ì•ŠìŒ
                        </div>
                    </div>
                </div>
                <div class="platform-actions">
                    <button class="platform-sync-btn" onclick="openCalendarSyncModal('google')" data-platform="google"
                        style="display: none;">
                        <span class="sync-text">ìº˜ë¦°ë” ì—°ë™</span>
                        <div class="sync-loader" style="display: none;">
                            <div class="loader-dot"></div>
                        </div>
                    </button>
                    <button class="one-click-btn-small" onclick="oneClickConnect('google')" data-platform="google">
                        <span class="btn-text">ì›í´ë¦­</span>
                        <div class="btn-loader" style="display: none;">
                            <div class="loader-spinner"></div>
                        </div>
                    </button>
                    <button class="platform-connect-btn" onclick="connectPlatform('google')" data-platform="google">
                        <span class="connect-text">ì—°ê²°í•˜ê¸°</span>
                        <div class="connect-loader" style="display: none;">
                            <div class="loader-dot"></div>
                        </div>
                    </button>
                </div>
            </div>
        </div>

        <!-- Apple Calendar ì—°ê²° ì¹´ë“œ -->
        <div class="platform-card" data-platform="apple">
            <div class="platform-header">
                <div class="platform-info">
                    <div class="platform-icon apple">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M19.5 4h-1.44a2.04 2.04 0 0 0-1.98 1.22l-1.58 4.49c-.25.7-.91 1.16-1.65 1.16-.73 0-1.39-.46-1.64-1.16l-1.58-4.49A2.04 2.04 0 0 0 7.62 4H6.5C5.67 4 5 4.67 5 5.5S5.67 7 6.5 7h1.12c.14 0 .27.09.32.22l1.58 4.49c.5 1.4 1.82 2.29 3.31 2.29s2.81-.89 3.31-2.29L17.72 7.22c.05-.13.18-.22.32-.22H19.5c.83 0 1.5-.67 1.5-1.5S20.33 4 19.5 4z" />
                        </svg>
                    </div>
                    <div class="platform-details">
                        <h3 class="platform-name">Apple Calendar</h3>
                        <div class="platform-status disconnected">
                            <span class="status-dot"></span>
                            ì—°ê²°ë˜ì§€ ì•ŠìŒ
                        </div>
                    </div>
                </div>
                <div class="platform-actions">
                    <button class="platform-sync-btn" onclick="openCalendarSyncModal('apple')" data-platform="apple"
                        style="display: none;">
                        <span class="sync-text">ìº˜ë¦°ë” ì—°ë™</span>
                        <div class="sync-loader" style="display: none;">
                            <div class="loader-dot"></div>
                        </div>
                    </button>
                    <button class="one-click-btn-small" onclick="oneClickConnect('apple')" data-platform="apple">
                        <span class="btn-text">ì›í´ë¦­</span>
                        <div class="btn-loader" style="display: none;">
                            <div class="loader-spinner"></div>
                        </div>
                    </button>
                    <button class="platform-connect-btn" onclick="connectPlatform('apple')" data-platform="apple">
                        <span class="connect-text">ì—°ê²°í•˜ê¸°</span>
                        <div class="connect-loader" style="display: none;">
                            <div class="loader-dot"></div>
                        </div>
                    </button>
                    <button class="platform-expand-btn" onclick="togglePlatformDetails('apple')">
                        <svg class="expand-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M6 9l6 6 6-6" />
                        </svg>
                    </button>
                </div>
            </div>

            <!-- ì—°ê²° ìƒì„¸ í¼ -->
            <div class="platform-details-form" id="apple-details" style="display: none;">
                <div class="form-group">
                    <label for="apple-username">Apple ID</label>
                    <input type="email" id="apple-username" name="apple-username"
                        placeholder="your-apple-id@icloud.com">
                </div>
                <div class="form-group">
                    <label for="apple-password">ì•± ì „ìš© ì•”í˜¸</label>
                    <input type="password" id="apple-password" name="apple-password" placeholder="ì•± ì „ìš© ì•”í˜¸">
                    <small class="form-help">
                        <a href="https://support.apple.com/en-us/HT204397" target="_blank" class="help-link">
                            ğŸ“– ì•± ì „ìš© ì•”í˜¸ ë§Œë“¤ê¸°
                        </a>
                        | 2ë‹¨ê³„ ì¸ì¦ í•„ìš”
                    </small>
                </div>
                <div class="form-actions">
                    <button class="btn btn-secondary" onclick="togglePlatformDetails('apple')">ì·¨ì†Œ</button>
                    <button class="btn btn-primary" onclick="connectPlatform('apple')">
                        <span class="loading-spinner" style="display: none;"></span>
                        ì—°ê²°í•˜ê¸°
                    </button>
                </div>
            </div>
        </div>

        <!-- Outlook ì—°ê²° ì¹´ë“œ -->
        <div class="platform-card" data-platform="outlook">
            <div class="platform-header">
                <div class="platform-info">
                    <div class="platform-icon outlook">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M7.88 12.04q0 .45-.11.87-.1.41-.33.74-.22.33-.58.52-.37.2-.87.2-.51 0-.87-.2-.37-.19-.59-.52-.21-.33-.32-.74-.1-.42-.1-.87 0-.44.1-.86.11-.41.32-.73.22-.33.59-.52.36-.2.87-.2.5 0 .87.2.36.19.58.52.23.32.33.73.11.42.11.86zM21.5 4v16q0 .41-.3.7-.29.3-.7.3H3.5q-.41 0-.7-.3-.3-.29-.3-.7V4q0-.41.3-.7Q2.79 3 3.2 3h17.6q.41 0 .7.29.3.29.3.71zM8.5 13.5H7.25v.75H8.5v-.75zm0-3H7.25V11H8.5v-.5zM12 7.98H9v8h3V7.98zm6.5 2.53-2.25 2.02 2.25 2.05V10.51z" />
                        </svg>
                    </div>
                    <div class="platform-details">
                        <h3 class="platform-name">Outlook</h3>
                        <div class="platform-status disconnected">
                            <span class="status-dot"></span>
                            ì—°ê²°ë˜ì§€ ì•ŠìŒ
                        </div>
                    </div>
                </div>
                <div class="platform-actions">
                    <button class="platform-sync-btn" onclick="openCalendarSyncModal('outlook')" data-platform="outlook"
                        style="display: none;">
                        <span class="sync-text">ìº˜ë¦°ë” ì—°ë™</span>
                        <div class="sync-loader" style="display: none;">
                            <div class="loader-dot"></div>
                        </div>
                    </button>
                    <button class="one-click-btn-small" onclick="oneClickConnect('outlook')" data-platform="outlook">
                        <span class="btn-text">ì›í´ë¦­</span>
                        <div class="btn-loader" style="display: none;">
                            <div class="loader-spinner"></div>
                        </div>
                    </button>
                    <button class="platform-connect-btn" onclick="connectPlatform('outlook')" data-platform="outlook">
                        <span class="connect-text">ì—°ê²°í•˜ê¸°</span>
                        <div class="connect-loader" style="display: none;">
                            <div class="loader-dot"></div>
                        </div>
                    </button>
                    <button class="platform-expand-btn" onclick="togglePlatformDetails('outlook')">
                        <svg class="expand-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M6 9l6 6 6-6" />
                        </svg>
                    </button>
                </div>
            </div>

            <!-- ì—°ê²° ìƒì„¸ í¼ -->
            <div class="platform-details-form" id="outlook-details" style="display: none;">
                <div class="form-group">
                    <label for="outlook-email">Microsoft ê³„ì •</label>
                    <input type="email" id="outlook-email" name="outlook-email" placeholder="your-email@outlook.com">
                </div>
                <div class="form-group">
                    <label for="outlook-client-id">í´ë¼ì´ì–¸íŠ¸ ID</label>
                    <input type="text" id="outlook-client-id" name="outlook-client-id"
                        placeholder="Azure ì•± ë“±ë¡ì—ì„œ ë°œê¸‰ë°›ì€ í´ë¼ì´ì–¸íŠ¸ ID">
                    <small class="form-help">
                        <a href="https://portal.azure.com/" target="_blank" class="help-link">
                            ğŸ“– Azure Portalì—ì„œ ì•± ë“±ë¡í•˜ê¸°
                        </a>
                        | Graph API ê¶Œí•œ í•„ìš”
                    </small>
                </div>
                <div class="form-actions">
                    <button class="btn btn-secondary" onclick="togglePlatformDetails('outlook')">ì·¨ì†Œ</button>
                    <button class="btn btn-primary" onclick="connectPlatform('outlook')">
                        <span class="loading-spinner" style="display: none;"></span>
                        ì—°ê²°í•˜ê¸°
                    </button>
                </div>
            </div>
        </div>

        <!-- Slack ì—°ê²° ì¹´ë“œ -->
        <div class="platform-card" data-platform="slack">
            <div class="platform-header">
                <div class="platform-info">
                    <div class="platform-icon slack">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M5.042 15.165a2.528 2.528 0 0 1-2.52 2.523A2.528 2.528 0 0 1 0 15.165a2.527 2.527 0 0 1 2.522-2.52h2.52v2.52zM6.313 15.165a2.527 2.527 0 0 1 2.521-2.52 2.527 2.527 0 0 1 2.521 2.52v6.313A2.528 2.528 0 0 1 8.834 24a2.528 2.528 0 0 1-2.521-2.522v-6.313zM8.834 5.042a2.528 2.528 0 0 1-2.521-2.52A2.528 2.528 0 0 1 8.834 0a2.528 2.528 0 0 1 2.521 2.522v2.52H8.834zM8.834 6.313a2.528 2.528 0 0 1 2.521 2.521 2.528 2.528 0 0 1-2.521 2.521H2.522A2.528 2.528 0 0 1 0 8.834a2.528 2.528 0 0 1 2.522-2.521h6.312zM18.956 8.834a2.528 2.528 0 0 1 2.521-2.521A2.528 2.528 0 0 1 24 8.834a2.528 2.528 0 0 1-2.523 2.521h-2.521V8.834zM17.688 8.834a2.528 2.528 0 0 1-2.523 2.521 2.527 2.527 0 0 1-2.52-2.521V2.522A2.527 2.527 0 0 1 15.165 0a2.528 2.528 0 0 1 2.523 2.522v6.312zM15.165 18.956a2.528 2.528 0 0 1 2.523 2.521A2.528 2.528 0 0 1 15.165 24a2.527 2.527 0 0 1-2.52-2.523v-2.521h2.52zM15.165 17.688a2.527 2.527 0 0 1-2.52-2.523 2.526 2.526 0 0 1 2.52-2.52h6.313A2.527 2.527 0 0 1 24 15.165a2.528 2.528 0 0 1-2.522 2.523h-6.313z" />
                        </svg>
                    </div>
                    <div class="platform-details">
                        <h3 class="platform-name">Slack</h3>
                        <div class="platform-status disconnected">
                            <span class="status-dot"></span>
                            ì—°ê²°ë˜ì§€ ì•ŠìŒ
                        </div>
                    </div>
                </div>
                <div class="platform-actions">
                    <button class="platform-sync-btn" onclick="openCalendarSyncModal('slack')" data-platform="slack"
                        style="display: none;">
                        <span class="sync-text">ìº˜ë¦°ë” ì—°ë™</span>
                        <div class="sync-loader" style="display: none;">
                            <div class="loader-dot"></div>
                        </div>
                    </button>
                    <button class="one-click-btn-small" onclick="oneClickConnect('slack')" data-platform="slack">
                        <span class="btn-text">ì›í´ë¦­</span>
                        <div class="btn-loader" style="display: none;">
                            <div class="loader-spinner"></div>
                        </div>
                    </button>
                    <button class="platform-connect-btn" onclick="connectPlatform('slack')" data-platform="slack">
                        <span class="connect-text">ì—°ê²°í•˜ê¸°</span>
                        <div class="connect-loader" style="display: none;">
                            <div class="loader-dot"></div>
                        </div>
                    </button>
                    <button class="platform-expand-btn" onclick="togglePlatformDetails('slack')">
                        <svg class="expand-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M6 9l6 6 6-6" />
                        </svg>
                    </button>
                </div>
            </div>

            <!-- ì—°ê²° ìƒì„¸ í¼ -->
            <div class="platform-details-form" id="slack-details" style="display: none;">
                <div class="form-group">
                    <label for="slack-webhook">Webhook URL</label>
                    <input type="url" id="slack-webhook" name="slack-webhook"
                        placeholder="https://hooks.slack.com/services/...">
                    <small class="form-help">
                        <a href="https://api.slack.com/messaging/webhooks" target="_blank" class="help-link">
                            ğŸ“– Slack Webhook ë§Œë“¤ê¸°
                        </a>
                        | ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ê´€ë¦¬ì ê¶Œí•œ í•„ìš”
                    </small>
                </div>
                <div class="form-actions">
                    <button class="btn btn-secondary" onclick="togglePlatformDetails('slack')">ì·¨ì†Œ</button>
                    <button class="btn btn-primary" onclick="connectPlatform('slack')">
                        <span class="loading-spinner" style="display: none;"></span>
                        ì—°ê²°í•˜ê¸°
                    </button>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- ìº˜ë¦°ë” ì„ íƒ ëª¨ë‹¬ -->
<div class="calendar-selection-modal" id="calendar-selection-modal" style="display: none;">
    <div class="modal-overlay" onclick="closeCalendarSelectionModal()"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">ìº˜ë¦°ë” ì„ íƒ</h3>
            <button class="modal-close-btn" onclick="closeCalendarSelectionModal()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6l-12 12M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <p class="modal-description">
                <span id="platform-name-display"></span> ì—°ê²°ì„ ìœ„í•´ ë™ê¸°í™”í•  ìº˜ë¦°ë”ë¥¼ ì„ íƒí•˜ì„¸ìš”.
            </p>
            <div class="calendar-list" id="calendar-list">
                <div class="loading-state">
                    <div class="loading-spinner"></div>
                    <p>ìº˜ë¦°ë” ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="closeCalendarSelectionModal()">ì·¨ì†Œ</button>
            <button class="btn-primary" id="confirm-calendar-selection" onclick="confirmCalendarSelection()" disabled>
                ì„ íƒí•œ ìº˜ë¦°ë”ë¡œ ì—°ê²°
            </button>
        </div>
    </div>
</div>

<!-- ì´ˆê¸° ë°ì´í„° ì„¤ì • ìŠ¤í¬ë¦½íŠ¸ -->
<script>
    // ì„œë²„ì—ì„œ ë Œë”ë§ëœ ë°ì´í„° (ìº˜ë¦°ë”ê°€ ìˆëŠ”ì§€ í™•ì¸)
    const hasCalendar = {{ (stats.connected_count if stats and stats.connected_count else 0)| tojson }} > 0;

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì¦‰ì‹œ ê°€ì´ë“œ ì²˜ë¦¬
    document.addEventListener('DOMContentLoaded', function () {
        const guide = document.getElementById('calendar-setup-guide');
        if (guide) {
            const isHidden = localStorage.getItem('calendar_guide_hidden') === 'true';

            // ìº˜ë¦°ë”ê°€ ìˆê±°ë‚˜ ì‚¬ìš©ìê°€ ì´ë¯¸ ìˆ¨ê¸´ ê²½ìš°
            if (hasCalendar || isHidden) {
                guide.style.display = 'none';
            } else {
                guide.style.display = 'block';
            }
        }
    });
</script>

<style>
    /* ìº˜ë¦°ë” ì„ íƒ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
    .calendar-selection-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 999999;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .modal-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(4px);
    }

    .modal-content {
        position: relative;
        background: #ffffff;
        border-radius: 16px;
        max-width: 600px;
        width: 90%;
        max-height: 80vh;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        overflow: hidden;
    }

    .modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 24px 32px;
        border-bottom: 1px solid #f0f0f0;
    }

    .modal-title {
        font-size: 20px;
        font-weight: 600;
        color: #000000;
        margin: 0;
    }

    .modal-close-btn {
        background: none;
        border: none;
        cursor: pointer;
        padding: 4px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #6b7280;
        transition: all 0.2s ease;
    }

    .modal-close-btn:hover {
        background: #f9fafb;
        color: #000000;
    }

    .modal-body {
        padding: 32px;
        max-height: 400px;
        overflow-y: auto;
    }

    .modal-description {
        font-size: 16px;
        color: #6b7280;
        margin-bottom: 24px;
        line-height: 1.5;
    }

    .calendar-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .calendar-item {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 16px;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        background: #ffffff;
    }

    .calendar-item:hover {
        border-color: #3b82f6;
        background: #f8faff;
    }

    .calendar-item.selected {
        border-color: #3b82f6;
        background: #eff6ff;
    }

    .calendar-radio {
        width: 20px;
        height: 20px;
        border: 2px solid #d1d5db;
        border-radius: 50%;
        position: relative;
        flex-shrink: 0;
    }

    .calendar-item.selected .calendar-radio {
        border-color: #3b82f6;
    }

    .calendar-item.selected .calendar-radio::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 10px;
        height: 10px;
        background: #3b82f6;
        border-radius: 50%;
    }

    .calendar-info {
        flex: 1;
    }

    .calendar-name {
        font-size: 16px;
        font-weight: 500;
        color: #000000;
        margin-bottom: 4px;
    }

    .calendar-description {
        font-size: 14px;
        color: #6b7280;
    }

    .calendar-type {
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 500;
        text-transform: uppercase;
    }

    .calendar-type.primary {
        background: #dbeafe;
        color: #1d4ed8;
    }

    .calendar-type.shared {
        background: #d1fae5;
        color: #047857;
    }

    .calendar-type.personal {
        background: #fef3c7;
        color: #d97706;
    }

    .loading-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 16px;
        padding: 40px 20px;
        color: #6b7280;
    }

    .loading-spinner {
        width: 32px;
        height: 32px;
        border: 3px solid #e5e7eb;
        border-top: 3px solid #3b82f6;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    .modal-footer {
        display: flex;
        gap: 12px;
        padding: 24px 32px;
        border-top: 1px solid #f0f0f0;
        justify-content: flex-end;
    }

    .btn-secondary,
    .btn-primary {
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 15px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        border: none;
        min-width: 120px;
    }

    .btn-secondary {
        background: #ffffff;
        color: #6b7280;
        border: 1px solid #e5e7eb;
    }

    .btn-secondary:hover {
        background: #f9fafb;
        color: #000000;
    }

    .btn-primary {
        background: #3b82f6;
        color: #ffffff;
    }

    .btn-primary:hover:not(:disabled) {
        background: #2563eb;
    }

    .btn-primary:disabled {
        background: #9ca3af;
        cursor: not-allowed;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    /* ìƒˆë¡œìš´ ë²„íŠ¼ ë””ìì¸ ìŠ¤íƒ€ì¼ */
    .one-click-btn-small {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 10px 18px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border-radius: 12px;
        position: relative;
        min-width: 100px;
        justify-content: center;
        background: #3b82f6;
        color: white;
        border: none;
        overflow: hidden;
        letter-spacing: 0.3px;
    }

    .one-click-btn-small::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        opacity: 0;
        transition: opacity 0.3s ease;
        z-index: 0;
    }

    .one-click-btn-small:hover::before {
        opacity: 1;
    }

    .one-click-btn-small:hover {
        transform: translateY(-2px) scale(1.02);
        box-shadow: 0 10px 25px rgba(59, 130, 246, 0.4);
    }

    .one-click-btn-small .btn-icon {
        font-size: 16px;
        position: relative;
        z-index: 1;
    }

    .one-click-btn-small .btn-text {
        position: relative;
        z-index: 1;
    }

    .platform-connect-btn,
    .platform-sync-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 20px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border-radius: 12px;
        position: relative;
        min-width: 110px;
        justify-content: center;
        background: #ffffff;
        color: #1a1a1a;
        border: 2px solid #e5e7eb;
        overflow: hidden;
    }

    .platform-sync-btn {
        background: #3b82f6;
        color: white;
        border: none;
        min-width: 160px;
        white-space: nowrap;
    }

    .platform-sync-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);
    }

    .platform-connect-btn::before,
    .platform-sync-btn::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        border-radius: 50%;
        background: #3b82f6;
        transform: translate(-50%, -50%);
        transition: width 0.4s ease, height 0.4s ease;
        z-index: 0;
    }

    .platform-connect-btn:hover::before {
        width: 300px;
        height: 300px;
    }

    .platform-connect-btn:hover {
        color: white;
        border-color: #3b82f6;
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
    }

    .platform-connect-btn .connect-text {
        position: relative;
        z-index: 1;
        transition: color 0.3s ease;
    }

    .platform-connect-btn:hover .connect-text {
        color: white;
    }

    .platform-disconnect-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 20px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border-radius: 12px;
        position: relative;
        min-width: 110px;
        justify-content: center;
        background: linear-gradient(135deg, #ff6b6b 0%, #ff8787 100%);
        color: white;
        border: none;
    }

    .platform-disconnect-btn:hover {
        background: linear-gradient(135deg, #ff5252 0%, #ff6b6b 100%);
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(255, 107, 107, 0.3);
    }

    /* ì—°ê²°í•˜ê¸° ë²„íŠ¼ ë¡œë”© ìƒíƒœ */
    .platform-connect-btn.loading {
        pointer-events: none;
        opacity: 0.8;
    }

    .connect-loader {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: inherit;
        border-radius: inherit;
    }

    .loader-dot {
        width: 8px;
        height: 8px;
        background: #3b82f6;
        border-radius: 50%;
        animation: bounce 1.4s infinite ease-in-out both;
    }

    .loader-dot::before,
    .loader-dot::after {
        content: '';
        position: absolute;
        width: 8px;
        height: 8px;
        background: #3b82f6;
        border-radius: 50%;
        animation: bounce 1.4s infinite ease-in-out both;
    }

    .loader-dot::before {
        left: -16px;
        animation-delay: -0.32s;
    }

    .loader-dot::after {
        left: 16px;
        animation-delay: -0.16s;
    }

    @keyframes bounce {

        0%,
        80%,
        100% {
            transform: scale(0);
        }

        40% {
            transform: scale(1);
        }
    }


    /* ìº˜ë¦°ë”ê°€ ì—†ì„ ë•Œ í”Œë«í¼ ì¹´ë“œ ë¹„í™œì„±í™” ìŠ¤íƒ€ì¼ */
    .platform-card.disabled {
        opacity: 0.5;
        pointer-events: none;
        position: relative;
    }

    .platform-card.disabled::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.3);
        border-radius: 12px;
        cursor: not-allowed;
    }

    .platform-card.disabled .platform-actions button {
        cursor: not-allowed;
        opacity: 0.6;
    }

    .no-calendar-notice {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(255, 255, 255, 0.95);
        padding: 12px 20px;
        border-radius: 8px;
        border: 1px solid #fbbf24;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        z-index: 10;
        display: none;
    }

    .platform-card.disabled:hover .no-calendar-notice {
        display: block;
    }

    .no-calendar-notice-text {
        color: #92400e;
        font-size: 14px;
        font-weight: 500;
    }
</style>
{% endblock %}

{% block extra_js %}
<!-- Core notification systemì´ ë¨¼ì € ë¡œë“œë˜ì–´ì•¼ í•¨ -->
<script
    src="{{ url_for('static', filename='js/notification-utils.js') }}?v={{ range(100000, 999999) | random }}"></script>
<script
    src="{{ url_for('static', filename='js/apple-setup-wizard.js') }}?v={{ range(100000, 999999) | random }}"></script>
<script src="{{ url_for('static', filename='js/platform-health.js') }}?v={{ range(100000, 999999) | random }}"></script>
<script>
    // í˜„ì¬ ì—°ê²° ì¤‘ì¸ í”Œë«í¼ê³¼ ì„ íƒëœ ìº˜ë¦°ë”ë¥¼ ì €ì¥
    let currentConnectingPlatform = null;
    let selectedCalendarId = null;

    // ê°œë³„ í”Œë«í¼ ì—°ë™ ê¸°ëŠ¥ - ìº˜ë¦°ë” ì„ íƒ í›„ ì—°ê²°
    async function connectPlatform(platformName) {
        // OAuth ì§€ì› í”Œë«í¼ ì²´í¬
        const oauthPlatforms = ['google', 'notion', 'slack', 'outlook'];

        if (oauthPlatforms.includes(platformName)) {
            // OAuth í”Œë«í¼ì˜ ê²½ìš° ì›í´ë¦­ ì—°ë™ ì‹¤í–‰
            await oneClickConnect(platformName);
        } else {
            // ìˆ˜ë™ ì„¤ì • í”Œë«í¼ì˜ ê²½ìš° ìº˜ë¦°ë” ì„ íƒ ëª¨ë‹¬ í‘œì‹œ
            await showCalendarSelectionModal(platformName);
        }
    }

    // ìº˜ë¦°ë” ì„ íƒ ëª¨ë‹¬ í‘œì‹œ (ì¼ë°˜ ì—°ê²°ìš©)
    async function showCalendarSelectionModal(platformName) {
        currentConnectingPlatform = platformName;
        const modal = document.getElementById('calendar-selection-modal');
        const platformDisplay = document.getElementById('platform-name-display');
        const calendarList = document.getElementById('calendar-list');

        // í”Œë«í¼ ì´ë¦„ í‘œì‹œ
        platformDisplay.textContent = getKoreanPlatformName(platformName);

        // ëª¨ë‹¬ í‘œì‹œ
        modal.style.display = 'flex';

        // ìº˜ë¦°ë” ëª©ë¡ ë¡œë”©
        await loadUserCalendars(calendarList);
    }

    // [REMOVED] Old deprecated openCalendarSyncModal function removed - using new implementation below
    /* DEPRECATED FUNCTION - COMMENTED OUT
    async function openCalendarSyncModal(platformName) {
        currentConnectingPlatform = platformName;
        const modal = document.getElementById('calendar-selection-modal');
        const platformDisplay = document.getElementById('platform-name-display');
        const calendarList = document.getElementById('calendar-list');
        const modalTitle = modal.querySelector('.modal-title');
        const confirmBtn = document.getElementById('confirm-calendar-selection');
        
        // ëª¨ë‹¬ ì œëª©ê³¼ ì„¤ëª… ë³€ê²½
        modalTitle.textContent = 'ìº˜ë¦°ë” ì—°ë™ ì„¤ì •';
        platformDisplay.textContent = getKoreanPlatformName(platformName);
        
        // ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½
        confirmBtn.textContent = 'ì„ íƒí•œ ìº˜ë¦°ë”ì™€ ì—°ë™';
        
        // ëª¨ë‹¬ í‘œì‹œ
        modal.style.display = 'flex';
        
        // ìº˜ë¦°ë” ëª©ë¡ ë¡œë”©
        await loadUserCalendars(calendarList);
    }

    // ì‚¬ìš©ì ìº˜ë¦°ë” ëª©ë¡ ë¡œë“œ
    async function loadUserCalendars(calendarListContainer) {
        try {
            // APIì—ì„œ ì‚¬ìš©ì ìº˜ë¦°ë” ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
            // API ì—”ë“œí¬ì¸íŠ¸ê°€ ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ ìƒ˜í”Œ ë°ì´í„° ì‚¬ìš©
            throw new Error('Calendar API not available, using sample data');
            
            if (response.ok) {
                const data = await response.json();
                
                if (data.success && data.calendars && data.calendars.length > 0) {
                    displayCalendarList(data.calendars, calendarListContainer);
                } else {
                    // ìº˜ë¦°ë”ê°€ ì—†ìœ¼ë©´ ìƒì„± ì•ˆë‚´
                    displayNoCalendarsMessage(calendarListContainer);
                }
            } else {
                // ìƒ˜í”Œ ìº˜ë¦°ë” ë°ì´í„° í‘œì‹œ (APIê°€ ì—†ëŠ” ê²½ìš°)
                displaySampleCalendars(calendarListContainer);
            }
        } catch (error) {
            console.error('ìº˜ë¦°ë” ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
            // ì—ëŸ¬ ì‹œ ìƒ˜í”Œ ë°ì´í„° í‘œì‹œ
            displaySampleCalendars(calendarListContainer);
        }
    }

    // ìº˜ë¦°ë” ëª©ë¡ í‘œì‹œ
    function displayCalendarList(calendars, container) {
        container.innerHTML = '';
        
        calendars.forEach(calendar => {
            const calendarItem = createCalendarItem(calendar);
            container.appendChild(calendarItem);
        });
    }

    // ìƒ˜í”Œ ìº˜ë¦°ë” ë°ì´í„° í‘œì‹œ (APIê°€ ì—†ëŠ” ê²½ìš°)
    function displaySampleCalendars(container) {
        const sampleCalendars = [
            {
                id: 'main-calendar',
                name: 'ë©”ì¸ ìº˜ë¦°ë”',
                description: 'ê¸°ë³¸ ê°œì¸ ìº˜ë¦°ë”',
                type: 'primary',
                color: '#3b82f6'
            },
            {
                id: 'work-calendar',
                name: 'ì—…ë¬´ ìº˜ë¦°ë”',
                description: 'ì—…ë¬´ ê´€ë ¨ ì¼ì • ê´€ë¦¬',
                type: 'personal',
                color: '#f59e0b'
            },
            {
                id: 'shared-calendar',
                name: 'íŒ€ ê³µìœ  ìº˜ë¦°ë”',
                description: 'íŒ€ì›ë“¤ê³¼ ê³µìœ í•˜ëŠ” ìº˜ë¦°ë”',
                type: 'shared',
                color: '#10b981'
            }
        ];
        
        displayCalendarList(sampleCalendars, container);
    }

    // ìº˜ë¦°ë”ê°€ ì—†ì„ ë•Œ ë©”ì‹œì§€ í‘œì‹œ
    function displayNoCalendarsMessage(container) {
        container.innerHTML = 
            '<div class="no-calendars-message">' +
                '<div class="no-calendars-icon">' +
                    '<svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">' +
                        '<path d="M8 2v4M16 2v4M3 10h18M5 4h14a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2z"/>' +
                    '</svg>' +
                '</div>' +
                '<h4>ìº˜ë¦°ë”ê°€ ì—†ìŠµë‹ˆë‹¤</h4>' +
                '<p>ë¨¼ì € ìº˜ë¦°ë”ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.</p>' +
                '<button class="btn-primary" onclick="redirectToCalendarCreation()">' +
                    'ìº˜ë¦°ë” ìƒì„±í•˜ëŸ¬ ê°€ê¸°' +
                '</button>' +
            '</div>';
    }

    // ìº˜ë¦°ë” ì•„ì´í…œ ìƒì„±
    function createCalendarItem(calendar) {
        const item = document.createElement('div');
        item.className = 'calendar-item';
        item.setAttribute('data-calendar-id', calendar.id);
        item.onclick = () => selectCalendar(calendar.id);
        
        item.innerHTML = 
            '<div class="calendar-radio"></div>' +
            '<div class="calendar-info">' +
                '<div class="calendar-name">' + (calendar.name || '') + '</div>' +
                '<div class="calendar-description">' + (calendar.description || '') + '</div>' +
            '</div>' +
            '<div class="calendar-type ' + (calendar.type || 'personal') + '">' + getCalendarTypeText(calendar.type) + '</div>';
        
        return item;
    }

    // ìº˜ë¦°ë” íƒ€ì… í…ìŠ¤íŠ¸ ë°˜í™˜
    function getCalendarTypeText(type) {
        switch (type) {
            case 'primary': return 'ê¸°ë³¸';
            case 'shared': return 'ê³µìœ ';
            case 'personal': return 'ê°œì¸';
            default: return 'ê°œì¸';
        }
    }

    // ìº˜ë¦°ë” ì„ íƒ
    function selectCalendar(calendarId) {
        // ê¸°ì¡´ ì„ íƒ í•´ì œ
        document.querySelectorAll('.calendar-item').forEach(item => {
            item.classList.remove('selected');
        });
        
        // ìƒˆ ì„ íƒ ì ìš©
        const selectedItem = document.querySelector('[data-calendar-id="' + calendarId + '"]');
        if (selectedItem) {
            selectedItem.classList.add('selected');
            selectedCalendarId = calendarId;
            
            // í™•ì¸ ë²„íŠ¼ í™œì„±í™”
            document.getElementById('confirm-calendar-selection').disabled = false;
        }
    }

    // ìº˜ë¦°ë” ì„ íƒ í™•ì¸
    async function confirmCalendarSelection() {
        if (!selectedCalendarId || !currentConnectingPlatform) {
            showNotification('ìº˜ë¦°ë”ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
            return;
        }

        // ëª¨ë‹¬ ë‹«ê¸°
        closeCalendarSelectionModal();

        // ì‹¤ì œ í”Œë«í¼ ì—°ê²° ì§„í–‰
        await performPlatformConnection(currentConnectingPlatform, selectedCalendarId);
    }

    // ì‹¤ì œ í”Œë«í¼ ì—°ê²° ìˆ˜í–‰
    async function performPlatformConnection(platformName, calendarId) {
        const button = document.querySelector('[data-platform="' + platformName + '"] .platform-connect-btn');
        const loader = button.querySelector('.connect-loader');
        const buttonText = button.querySelector('.connect-text');
        const card = document.querySelector('[data-platform="' + platformName + '"]');
        const status = card.querySelector('.platform-status');

        // ë²„íŠ¼ ìƒíƒœ ë³€ê²½
        button.disabled = true;
        buttonText.textContent = 'ì—°ê²° ì¤‘...';
        loader.style.display = 'flex';

        // ì¹´ë“œ ì• ë‹ˆë©”ì´ì…˜
        card.style.transform = 'scale(1.02)';
        card.style.boxShadow = 'var(--shadow-lg)';

        try {
            // ì‹¤ì œ ì—°ê²° API í˜¸ì¶œ
            const response = await fetch('/api/platform/connect', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    platform: platformName,
                    calendar_id: calendarId
                })
            });

            if (response.ok) {
                const result = await response.json();
                
                if (result.success) {
                    // ì—°ê²° ì„±ê³µ
                    status.className = 'platform-status connected';
                    status.innerHTML = '<span class="status-dot"></span>ì—°ê²°ë¨';

                    // ë²„íŠ¼ì„ ì—°ê²°í•´ì œ ë²„íŠ¼ìœ¼ë¡œ ë³€ê²½
                    button.className = 'platform-disconnect-btn';
                    button.setAttribute('onclick', 'disconnectPlatform(\'' + platformName + '\')');
                    buttonText.textContent = 'ì—°ê²° í•´ì œ';

                    // í†µê³„ ë° í”Œë«í¼ ìƒíƒœ ì—…ë°ì´íŠ¸
                    updateConnectionStats();
                    updatePlatformStatus();

                    showNotification(getKoreanPlatformName(platformName) + ' ì—°ê²° ì™„ë£Œ!', 'success');
                } else {
                    showNotification(result.message || 'ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                }
            } else {
                // ì—°ê²° ì‹œë®¬ë ˆì´ì…˜ (APIê°€ ì—†ëŠ” ê²½ìš°)
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // 80% ì„±ê³µë¥ ë¡œ ì‹œë®¬ë ˆì´ì…˜
                if (Math.random() > 0.2) {
                    status.className = 'platform-status connected';
                    status.innerHTML = '<span class="status-dot"></span>ì—°ê²°ë¨';

                    button.className = 'platform-disconnect-btn';
                    button.setAttribute('onclick', 'disconnectPlatform(\'' + platformName + '\')');
                    buttonText.textContent = 'ì—°ê²° í•´ì œ';

                    updateConnectionStats();
                    updatePlatformStatus();

                    showNotification(getKoreanPlatformName(platformName) + ' ì—°ê²° ì™„ë£Œ!', 'success');
                } else {
                    showNotification('ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'error');
                }
            }
        } catch (error) {
            console.error('ì—°ê²° ì¤‘ ì˜¤ë¥˜:', error);
            showNotification('ì—°ê²° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        }

        // ì• ë‹ˆë©”ì´ì…˜ ë° ìƒíƒœ ë³µì›
        setTimeout(() => {
            button.disabled = false;
            if (button.className === 'platform-connect-btn') {
                buttonText.textContent = 'ì—°ê²°í•˜ê¸°';
            }
            loader.style.display = 'none';
            card.style.transform = '';
            card.style.boxShadow = '';
        }, 500);

        // ì„ íƒ ìƒíƒœ ì´ˆê¸°í™”
        selectedCalendarId = null;
        currentConnectingPlatform = null;
    }

    // ìº˜ë¦°ë” ì„ íƒ ëª¨ë‹¬ ë‹«ê¸°
    function closeCalendarSelectionModal() {
        const modal = document.getElementById('calendar-selection-modal');
        modal.style.display = 'none';
        
        // ì„ íƒ ìƒíƒœ ì´ˆê¸°í™”
        selectedCalendarId = null;
        currentConnectingPlatform = null;
        document.getElementById('confirm-calendar-selection').disabled = true;
    }

    // ìº˜ë¦°ë” ìƒì„± í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
    function redirectToCalendarCreation() {
        closeCalendarSelectionModal();
        window.location.href = '/calendar';
    }
    END OF DEPRECATED FUNCTIONS */

    // ê°œë³„ í”Œë«í¼ ì—°ê²° í•´ì œ ê¸°ëŠ¥
    async function disconnectPlatform(platformName) {
        const button = document.querySelector('[data-platform="' + platformName + '"]');
        const loader = button.querySelector('.disconnect-loader');
        const buttonText = button.querySelector('.disconnect-text');
        const card = document.querySelector('[data-platform="' + platformName + '"]');
        const status = card.querySelector('.platform-status');

        if (!confirm(getKoreanPlatformName(platformName) + ' ì—°ê²°ì„ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            return;
        }

        // ë²„íŠ¼ ìƒíƒœ ë³€ê²½
        button.disabled = true;
        buttonText.textContent = 'í•´ì œ ì¤‘...';
        loader.style.display = 'flex';

        try {
            // ë°±ì—”ë“œì— ì—°ê²° í•´ì œ í‘œì‹œ
            await markPlatformDisconnected(platformName);

            // ì‹¤ì œ ì—°ê²° í•´ì œ ë¡œì§ ì‹œë®¬ë ˆì´ì…˜
            await new Promise(resolve => setTimeout(resolve, 1500));

            // ìƒíƒœ ì—…ë°ì´íŠ¸
            status.className = 'platform-status disconnected';
            status.innerHTML = '<span class="status-dot"></span>ì—°ê²°ë˜ì§€ ì•ŠìŒ';

            // ë²„íŠ¼ì„ ì—°ê²° ë²„íŠ¼ìœ¼ë¡œ ë³€ê²½
            button.className = 'platform-connect-btn';
            button.setAttribute('onclick', 'connectPlatform(\'' + platformName + '\')');
            buttonText.textContent = 'ì—°ê²°í•˜ê¸°';

            // í†µê³„ ë° í”Œë«í¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            updateConnectionStats();
            updatePlatformStatus();

            showNotification(`${getKoreanPlatformName(platformName)} ì—°ê²° í•´ì œ ì™„ë£Œ`, 'success');
        } catch (error) {
            console.error('ì—°ê²° í•´ì œ ì¤‘ ì˜¤ë¥˜:', error);
            showNotification('ì—°ê²° í•´ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        }

        // ìƒíƒœ ë³µì›
        setTimeout(() => {
            button.disabled = false;
            if (button.className === 'platform-disconnect-btn') {
                buttonText.textContent = 'ì—°ê²° í•´ì œ';
            }
            loader.style.display = 'none';
        }, 500);
    }


    // í”Œë«í¼ ì´ë¦„ í•œêµ­ì–´ ë³€í™˜
    function getKoreanPlatformName(platform) {
        const names = {
            'notion': 'Notion',
            'google': 'Google Calendar',
            'apple': 'Apple Calendar',
            'outlook': 'Outlook',
            'slack': 'Slack'
        };
        return names[platform] || platform;
    }

    // ì•Œë¦¼ í‘œì‹œ í•¨ìˆ˜ - NotificationUtils ì‚¬ìš©
    function showNotification(message, type = 'info') {
        if (window.NotificationUtils) {
            return window.NotificationUtils.show(message, type);
        }
        // Fallback if NotificationUtils not loaded
        console.log('[' + type + '] ' + message);
    }

    // ì‹¤ì œ í”Œë«í¼ ì—°ê²° ìƒíƒœ ì—…ë°ì´íŠ¸
    async function updatePlatformStatus() {
        try {
            const response = await fetch('/api/dashboard/platforms');

            if (response.ok) {
                const data = await response.json();

                if (data.success && data.platforms) {
                    const platforms = data.platforms;

                    // ê° í”Œë«í¼ë³„ ìƒíƒœ ì—…ë°ì´íŠ¸
                    Object.keys(platforms).forEach(platformName => {
                        const platform = platforms[platformName];
                        const platformCard = document.querySelector('[data-platform="' + platformName + '"]');

                        if (platformCard) {
                            const statusElement = platformCard.querySelector('.platform-status');
                            const connectBtn = platformCard.querySelector('.platform-connect-btn');

                            if (statusElement && platform.configured && platform.enabled) {
                                // ì—°ê²°ëœ ìƒíƒœ
                                statusElement.className = 'platform-status connected';
                                statusElement.innerHTML = '<span class="status-dot"></span>ì—°ê²°ë¨';

                                if (connectBtn) {
                                    connectBtn.className = 'platform-disconnect-btn';
                                    connectBtn.setAttribute('onclick', 'disconnectPlatform(\'' + platformName + '\')');
                                    connectBtn.innerHTML = `
                                        <span class="disconnect-text">ì—°ê²° í•´ì œ</span>
                                        <div class="disconnect-loader" style="display: none;">
                                            <div class="loader-dot"></div>
                                        </div>
                                    `;
                                }
                            } else {
                                // ì—°ê²°ë˜ì§€ ì•Šì€ ìƒíƒœ
                                statusElement.className = 'platform-status disconnected';
                                statusElement.innerHTML = '<span class="status-dot"></span>ì—°ê²°ë˜ì§€ ì•ŠìŒ';

                                if (connectBtn && connectBtn.className !== 'platform-connect-btn') {
                                    connectBtn.className = 'platform-connect-btn';
                                    connectBtn.setAttribute('onclick', 'connectPlatform(\'' + platformName + '\')');
                                    connectBtn.innerHTML = `
                                        <span class="connect-text">ì—°ê²°í•˜ê¸°</span>
                                        <div class="connect-loader" style="display: none;">
                                            <div class="loader-dot"></div>
                                        </div>
                                    `;
                                }
                            }
                        }
                    });

                    console.log('Platform status updated with real data:', platforms);
                }
            }
        } catch (error) {
            console.error('Error updating platform status:', error);
            // API ì—ëŸ¬ ì‹œ ëª¨ë“  í”Œë«í¼ì„ ì—°ê²°ë˜ì§€ ì•Šì€ ìƒíƒœë¡œ ì„¤ì •
            const platformCards = document.querySelectorAll('.platform-card');
            platformCards.forEach(card => {
                const statusElement = card.querySelector('.platform-status');
                if (statusElement) {
                    statusElement.className = 'platform-status disconnected';
                    statusElement.innerHTML = '<span class="status-dot"></span>ì—°ê²°ë˜ì§€ ì•ŠìŒ';
                }
            });
        }
    }

    // ìº˜ë¦°ë” ê°œìˆ˜ í™•ì¸ ë° í”Œë«í¼ ì¹´ë“œ ìƒíƒœ ì—…ë°ì´íŠ¸
    async function checkCalendarsAndUpdatePlatforms() {
        try {
            // ì„œë²„ì—ì„œ ë Œë”ë§ëœ í†µê³„ ë°ì´í„° ì‚¬ìš©
            const connectedCount = {{ (stats.connected_count if stats and stats.connected_count else 0)| tojson
        }};
    const hasCalendars = connectedCount > 0;

    // ëª¨ë“  í”Œë«í¼ ì¹´ë“œ ì„ íƒ
    const platformCards = document.querySelectorAll('.platform-card');

    platformCards.forEach(card => {
        if (!hasCalendars) {
            // ìº˜ë¦°ë”ê°€ ì—†ìœ¼ë©´ ì¹´ë“œ ë¹„í™œì„±í™”
            card.classList.add('disabled');

            // ì•ˆë‚´ ë©”ì‹œì§€ ì¶”ê°€ (ì•„ì§ ì—†ìœ¼ë©´)
            if (!card.querySelector('.no-calendar-notice')) {
                const notice = document.createElement('div');
                notice.className = 'no-calendar-notice';
                notice.innerHTML = '<div class="no-calendar-notice-text">ğŸ“… ë¨¼ì € ìº˜ë¦°ë”ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”</div>';
                card.appendChild(notice);
            }

            // ë²„íŠ¼ë“¤ ë¹„í™œì„±í™”
            const buttons = card.querySelectorAll('button');
            buttons.forEach(btn => {
                btn.disabled = true;
                btn.style.pointerEvents = 'none';
            });
        } else {
            // ìº˜ë¦°ë”ê°€ ìˆìœ¼ë©´ ì¹´ë“œ í™œì„±í™”
            card.classList.remove('disabled');

            // ì•ˆë‚´ ë©”ì‹œì§€ ì œê±°
            const notice = card.querySelector('.no-calendar-notice');
            if (notice) {
                notice.remove();
            }

            // ë²„íŠ¼ë“¤ í™œì„±í™”
            const buttons = card.querySelectorAll('button');
            buttons.forEach(btn => {
                btn.disabled = false;
                btn.style.pointerEvents = '';
            });
        }
    });

        return hasCalendars;
        } catch (error) {
        // ì—ëŸ¬ ì‹œ ê¸°ë³¸ì ìœ¼ë¡œ ë¹„í™œì„±í™” (ì¡°ìš©íˆ)
        const platformCards = document.querySelectorAll('.platform-card');
        platformCards.forEach(card => {
            card.classList.add('disabled');
        });
        return false;
    }
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ í†µê³„ ì—…ë°ì´íŠ¸
    document.addEventListener('DOMContentLoaded', async function () {
        try {
            // ì´ˆê¸° ë¡œë“œ (ì¡°ìš©íˆ)
            await checkCalendarsAndUpdatePlatforms();
            await updatePlatformStatus();
            await updateConnectionStats();
            // í†µê³„ ì—…ë°ì´íŠ¸ í›„ ê°€ì´ë“œ ì²´í¬
            checkAndHideGuide();
        } catch (error) {
            // ì—ëŸ¬ ì‹œ ê¸°ë³¸ê°’ ì„¤ì • (ì¡°ìš©íˆ)
            document.getElementById('connected-count').textContent = '0';
            document.getElementById('sync-count').textContent = '0';
            document.getElementById('success-rate').textContent = '0%';
            document.getElementById('sync-speed').textContent = 'N/A';
            // ì—ëŸ¬ ì‹œì—ë„ ê°€ì´ë“œ ì²´í¬
            checkAndHideGuide();
        }

        // 30ì´ˆë§ˆë‹¤ ì—…ë°ì´íŠ¸ (ì¡°ìš©íˆ)
        setInterval(async () => {
            try {
                await checkCalendarsAndUpdatePlatforms();
                await updatePlatformStatus();
                await updateConnectionStats();
            } catch (error) {
                // ì—ëŸ¬ ë¬´ì‹œ (ì¡°ìš©íˆ)
            }
        }, 30000);

        // íƒ­ í¬ì»¤ìŠ¤ ì‹œ ì—…ë°ì´íŠ¸ (ì¡°ìš©íˆ)
        document.addEventListener('visibilitychange', async function () {
            if (!document.hidden) {
                try {
                    await checkCalendarsAndUpdatePlatforms();
                    await updatePlatformStatus();
                    await updateConnectionStats();
                } catch (error) {
                    // ì—ëŸ¬ ë¬´ì‹œ (ì¡°ìš©íˆ)
                }
            }
        });
    });

    async function updateConnectionStats() {
        try {
            // ì„œë²„ì—ì„œ ë Œë”ë§ëœ ë°ì´í„° ì‚¬ìš© (ì¡°ìš©íˆ)
            const stats = {
                connected_count: {{ (stats.connected_count if stats and stats.connected_count else 0)| tojson }},
                synced_events: {{ (stats.synced_events if stats and stats.synced_events else 0)| tojson }},
                success_rate: {{ (stats.success_rate if stats and stats.success_rate else "0%")| tojson }},
                avg_sync_time: {{ (stats.avg_sync_time if stats and stats.avg_sync_time else "N/A")| tojson }}
            };

    // DOM ì—…ë°ì´íŠ¸
    document.getElementById('connected-count').textContent = stats.connected_count;
    document.getElementById('sync-count').textContent = stats.synced_events;
    document.getElementById('success-rate').textContent = stats.success_rate;
    document.getElementById('sync-speed').textContent = stats.avg_sync_time;
        } catch (error) {
        // ì—ëŸ¬ ì‹œ ê¸°ë³¸ê°’ ì„¤ì • (ì¡°ìš©íˆ)
        document.getElementById('connected-count').textContent = '0';
        document.getElementById('sync-count').textContent = '0';
        document.getElementById('success-rate').textContent = '0%';
        document.getElementById('sync-speed').textContent = 'N/A';
    }
    }

    // ê°œë³„ í”Œë«í¼ ì›í´ë¦­ ì—°ë™ ê¸°ëŠ¥
    async function oneClickConnect(platform) {
        // Appleì˜ ê²½ìš° ìŠ¤ë§ˆíŠ¸ ë§ˆë²•ì‚¬ ì‹¤í–‰
        if (platform === 'apple') {
            if (window.appleWizard) {
                window.appleWizard.start(platform);
            } else {
                console.error('Apple Setup Wizard not loaded');
                showNotification('Apple ì„¤ì • ë§ˆë²•ì‚¬ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
            return;
        }

        const button = document.querySelector('[data-platform="' + platform + '"] .one-click-btn-small');

        if (!button) {
            console.error(`Button not found for platform: ${platform}`);
            showNotification(`${getKoreanPlatformName(platform)} ì—°ê²° ë²„íŠ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`, 'error');
            return;
        }

        const loader = button.querySelector('.btn-loader');
        const buttonText = button.querySelector('.btn-text');

        // ë²„íŠ¼ ìƒíƒœ ë³€ê²½
        button.disabled = true;
        if (buttonText) buttonText.style.display = 'none';
        if (loader) loader.style.display = 'flex';

        try {
            // OAuth ì§€ì› í”Œë«í¼ë“¤
            const oauthPlatforms = ['google', 'notion', 'slack', 'outlook'];

            if (oauthPlatforms.includes(platform)) {
                // OAuth í”Œë¡œìš° ì‹¤í–‰
                await performOAuthConnection(platform);
            } else {
                // ì¼ë°˜ API í‚¤ ë°©ì‹
                showNotification(`${getKoreanPlatformName(platform)} ì—°ê²°ì„ ìœ„í•´ ì„¤ì • í¼ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.`, 'info');
                togglePlatformDetails(platform);
            }

        } catch (error) {
            console.error(`${platform} ì—°ë™ ì¤‘ ì˜¤ë¥˜:`, error);
            showNotification(`${getKoreanPlatformName(platform)} ì—°ë™ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.`, 'error');
        } finally {
            // ë²„íŠ¼ ìƒíƒœ ë³µì›
            setTimeout(() => {
                button.disabled = false;
                if (buttonText) buttonText.style.display = 'inline';
                if (loader) loader.style.display = 'none';
            }, 1000);
        }
    }

    // OAuth ì—°ê²° ìˆ˜í–‰
    async function performOAuthConnection(platform) {
        try {
            // OAuth ì„¤ì • í™•ì¸
            const configCheck = await fetch(`/oauth/${platform}/check`);
            const configData = await configCheck.json();

            if (!configData.configured) {
                showNotification(
                    `${getKoreanPlatformName(platform)} OAuthê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ìˆ˜ë™ ì„¤ì •ì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.`,
                    'warning'
                );
                // ìˆ˜ë™ ì„¤ì • í¼ í‘œì‹œ
                togglePlatformDetails(platform);
                return;
            }

            const width = 500;
            const height = 700;
            const left = (screen.width - width) / 2;
            const top = (screen.height - height) / 2;

            const popup = window.open(
                `/oauth/${platform}/authorize`,
                `oauth_${platform}`,
                `width=${width},height=${height},left=${left},top=${top},scrollbars=yes,resizable=yes`
            );

            if (!popup) {
                throw new Error('íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. OAuth ì¸ì¦ì„ ìœ„í•´ íŒì—…ì„ í—ˆìš©í•´ì£¼ì„¸ìš”.');
            }

            // OAuth ì™„ë£Œ ëŒ€ê¸°
            return new Promise((resolve, reject) => {
                const checkInterval = 500;
                let timeoutCount = 0;
                const maxTimeout = 240; // 2ë¶„ íƒ€ì„ì•„ì›ƒ

                // íŒì—…ìœ¼ë¡œë¶€í„° ë©”ì‹œì§€ ìˆ˜ì‹  ëŒ€ê¸°
                const messageHandler = (event) => {
                    if (event.origin !== window.location.origin) {
                        return;
                    }

                    if (event.data && event.data.type) {
                        if (event.data.type === 'oauth_success') {
                            cleanup();

                            // Mark platform as connected in backend
                            markPlatformConnected(event.data.platform);

                            updatePlatformStatus(event.data.platform, 'connected');
                            showNotification(`${getKoreanPlatformName(event.data.platform)} ì—°ê²° ì„±ê³µ!`, 'success');
                            updateConnectionStats();
                            updatePlatformStatus();
                            resolve(event.data);
                        } else if (event.data.type === 'oauth_error') {
                            cleanup();
                            console.error(`OAuth Error for ${platform}:`, event.data);
                            showNotification(`ì—°ê²° ì‹¤íŒ¨: ${event.data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`, 'error');
                            reject(new Error(event.data.error || 'OAuth ì¸ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤'));
                        }
                    }
                };

                // íŒì—… ë‹«í˜ ê°ì§€
                const checkClosed = setInterval(() => {
                    if (popup.closed) {
                        cleanup();
                        reject(new Error('OAuth ì¸ì¦ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤'));
                        return;
                    }

                    timeoutCount++;
                    if (timeoutCount >= maxTimeout) {
                        cleanup();
                        if (!popup.closed) {
                            popup.close();
                        }
                        reject(new Error('OAuth ì¸ì¦ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤'));
                    }
                }, checkInterval);

                const cleanup = () => {
                    window.removeEventListener('message', messageHandler);
                    clearInterval(checkClosed);
                    if (!popup.closed) {
                        popup.close();
                    }
                };

                window.addEventListener('message', messageHandler);
            });
        } catch (error) {
            console.error('OAuth ì—°ê²° ì‹¤íŒ¨:', error);
            throw error;
        }
    }

    // í”Œë«í¼ ìƒíƒœ ì—…ë°ì´íŠ¸
    function updatePlatformStatus(platform, status) {
        const card = document.querySelector('[data-platform="' + platform + '"]');
        if (!card) return;

        const statusElement = card.querySelector('.platform-status');
        const connectBtn = card.querySelector('.platform-connect-btn');
        const disconnectBtn = card.querySelector('.platform-disconnect-btn');

        if (status === 'connected') {
            statusElement.className = 'platform-status connected';
            statusElement.innerHTML = '<span class="status-dot"></span>ì—°ê²°ë¨';

            // ê¸°ì¡´ ì—°ê²° ë²„íŠ¼ ìˆ¨ê¸°ê¸° (ì›í´ë¦­ ë²„íŠ¼ì´ ì—°ê²°í•´ì œ ì—­í• ì„ í•¨)
            if (connectBtn) {
                connectBtn.style.display = 'none';
            }

            // ì›í´ë¦­ ë²„íŠ¼ì„ ì—°ê²°í•´ì œ ë²„íŠ¼ìœ¼ë¡œ ë³€ê²½
            const oneClickBtn = card.querySelector('.one-click-btn-small');
            if (oneClickBtn) {
                oneClickBtn.className = 'one-click-disconnect-btn';
                oneClickBtn.setAttribute('onclick', 'oneClickDisconnect(\'' + platform + '\')');
                oneClickBtn.innerHTML = `
                    <span class="btn-text">ì—°ê²°í•´ì œ</span>
                    <div class="btn-loader" style="display: none;">
                        <div class="loader-spinner"></div>
                    </div>
                `;
            }

            // ìº˜ë¦°ë” ì—°ë™ ë²„íŠ¼ í‘œì‹œ (ì—°ê²°ë¨ ìƒíƒœì—ì„œë§Œ)
            const syncBtn = card.querySelector('.platform-sync-btn');
            if (syncBtn) {
                syncBtn.style.display = 'inline-flex';
                syncBtn.onclick = () => openCalendarSyncModal(platform);
            }
        } else {
            statusElement.className = 'platform-status disconnected';
            statusElement.innerHTML = '<span class="status-dot"></span>ì—°ê²°ë˜ì§€ ì•ŠìŒ';

            // ì—°ê²° ë²„íŠ¼ì„ ë‹¤ì‹œ í‘œì‹œ
            if (connectBtn) {
                connectBtn.style.display = 'inline-flex';
            }

            // ì—°ê²°í•´ì œ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
            if (disconnectBtn) {
                disconnectBtn.style.display = 'none';
            }

            // ì›í´ë¦­ ë²„íŠ¼ì„ ì›ë˜ ìƒíƒœë¡œ ë˜ëŒë¦¬ê¸°
            const oneClickDisconnectBtn = card.querySelector('.one-click-disconnect-btn');
            if (oneClickDisconnectBtn) {
                oneClickDisconnectBtn.className = 'one-click-btn-small';
                oneClickDisconnectBtn.setAttribute('onclick', 'oneClickConnect(\'' + platform + '\')');
                oneClickDisconnectBtn.innerHTML = `
                    <span class="btn-text">ì›í´ë¦­</span>
                    <div class="btn-loader" style="display: none;">
                        <div class="loader-spinner"></div>
                    </div>
                `;
            }

            // ì—°ê²°ë˜ì§€ ì•Šì€ ìƒíƒœì—ì„œëŠ” ìº˜ë¦°ë” ì—°ë™ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
            const syncBtn = card.querySelector('.platform-sync-btn');
            if (syncBtn) {
                syncBtn.style.display = 'none';
            }
        }
    }

    // í”Œë«í¼ ì„¸ë¶€ì‚¬í•­ í† ê¸€
    function togglePlatformDetails(platform) {
        const details = document.getElementById('' + platform + '-details');
        if (details) {
            const isVisible = details.style.display !== 'none';
            details.style.display = isVisible ? 'none' : 'block';

            const expandBtn = document.querySelector('[data-platform="' + platform + '"] .platform-expand-btn');
            if (expandBtn) {
                expandBtn.style.transform = isVisible ? 'rotate(0deg)' : 'rotate(180deg)';
            }
        }
    }

    // ìº˜ë¦°ë” ì•ˆë‚´ ê´€ë ¨ í•¨ìˆ˜ë“¤
    function hideCalendarGuide() {
        const guide = document.getElementById('calendar-setup-guide');
        if (guide) {
            guide.style.animation = 'slideOutUp 0.3s ease-in forwards';
            setTimeout(() => {
                guide.classList.add('hidden');
            }, 300);

            // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ìˆ¨ê¹€ ìƒíƒœ ì €ì¥
            localStorage.setItem('calendar_guide_hidden', 'true');
        }
    }

    // ì—°ê²°ëœ í”Œë«í¼ì´ ìˆìœ¼ë©´ ìë™ìœ¼ë¡œ ì•ˆë‚´ ìˆ¨ê¸°ê¸°
    function checkAndHideGuide() {
        const guide = document.getElementById('calendar-setup-guide');
        if (!guide) return;

        const isHidden = localStorage.getItem('calendar_guide_hidden') === 'true';

        // ì „ì—­ ë³€ìˆ˜ hasCalendar ì‚¬ìš© (ìœ„ì—ì„œ ì„¤ì •ë¨)
        if (typeof hasCalendar !== 'undefined' && (hasCalendar || isHidden)) {
            guide.style.display = 'none';
        } else if (!isHidden) {
            guide.style.display = 'block';
        }
    }

    // ìº˜ë¦°ë” ì—°ë™ ëª¨ë‹¬ ì—´ê¸°
    async function openCalendarSyncModal(platform) {
        try {
            // ì‚¬ìš©ìê°€ ìƒì„±í•œ ìº˜ë¦°ë” ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
            const response = await fetch('/api/user/calendars');
            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || 'Failed to fetch calendars');
            }

            // API ì‘ë‹µì—ì„œ ê°œì¸ ìº˜ë¦°ë”ì™€ ê³µìœ  ìº˜ë¦°ë”ë¥¼ í•©ì¹œë‹¤
            const calendars = [
                ...(data.personal_calendars || []),
                ...(data.shared_calendars || [])
            ];

            if (calendars.length === 0) {
                showNoCalendarsModal(platform);
                return;
            }

            // í”Œë«í¼ë³„ ì´ë¦„ ë§¤í•‘
            const platformNames = {
                notion: 'Notion',
                google: 'Google Calendar',
                apple: 'Apple Calendar',
                outlook: 'Outlook',
                slack: 'Slack'
            };

            // ëª¨ë‹¬ ìƒì„±
            const modal = document.createElement('div');
            modal.className = 'calendar-sync-modal';

            const platformDisplayName = platformNames[platform] || platform;

            modal.innerHTML = `
                <div class="modal-backdrop" onclick="closeCalendarSyncModal()"></div>
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title-section">
                            <div class="platform-icon">${getPlatformIcon(platform)}</div>
                            <div class="modal-title-text">
                                <h3>ìº˜ë¦°ë” ì—°ë™</h3>
                                <p class="platform-subtitle">${platformDisplayName} ì—°ë™ ì„¤ì •</p>
                            </div>
                        </div>
                        <button class="modal-close" onclick="closeCalendarSyncModal()">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="modal-body">
                        <div class="sync-step-indicator">
                            <div class="step active">
                                <div class="step-number">1</div>
                                <span>ìº˜ë¦°ë” ì„ íƒ</span>
                            </div>
                            <div class="step">
                                <div class="step-number">2</div>
                                <span>ì—°ë™ ì„¤ì •</span>
                            </div>
                            <div class="step">
                                <div class="step-number">3</div>
                                <span>ì™„ë£Œ</span>
                            </div>
                        </div>
                        
                        <div class="step-content" id="step1">
                            <div class="step-description">
                                <h4>ì—°ë™í•  ìº˜ë¦°ë”ë¥¼ ì„ íƒí•˜ì„¸ìš”</h4>
                                <p>NotionFlowì—ì„œ ìƒì„±í•œ ìº˜ë¦°ë” ì¤‘ ${platformDisplayName}ì™€ ì—°ë™í•  ìº˜ë¦°ë”ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</p>
                            </div>
                            
                            <div class="calendar-grid" id="calendar-grid">
                            </div>
                        </div>
                        
                        <div class="step-content hidden" id="step2">
                            <div class="step-description">
                                <h4>ì—°ë™ ì„¤ì •</h4>
                                <p>ì„ íƒí•œ ìº˜ë¦°ë”ì˜ ì—°ë™ ë°©ì‹ì„ ì„¤ì •í•´ì£¼ì„¸ìš”.</p>
                            </div>
                            
                            <div class="sync-settings">
                                <div class="setting-group">
                                    <label class="setting-label">
                                        <input type="checkbox" id="bidirectional-sync" checked>
                                        <span class="checkmark"></span>
                                        ì–‘ë°©í–¥ ë™ê¸°í™”
                                    </label>
                                    <p class="setting-description">NotionFlow â†” ${platformDisplayName} ì–‘ë°©í–¥ìœ¼ë¡œ ì¼ì •ì„ ë™ê¸°í™”í•©ë‹ˆë‹¤.</p>
                                </div>
                                
                                <div class="setting-group">
                                    <label class="setting-label">
                                        <input type="checkbox" id="real-time-sync" checked>
                                        <span class="checkmark"></span>
                                        ì‹¤ì‹œê°„ ë™ê¸°í™”
                                    </label>
                                    <p class="setting-description">ì¼ì • ë³€ê²½ ì‹œ ì¦‰ì‹œ ë™ê¸°í™”í•©ë‹ˆë‹¤.</p>
                                </div>
                                
                                <div class="setting-group">
                                    <label class="setting-label">
                                        <input type="checkbox" id="notification-sync">
                                        <span class="checkmark"></span>
                                        ì•Œë¦¼ ë™ê¸°í™”
                                    </label>
                                    <p class="setting-description">ì¼ì • ì•Œë¦¼ë„ í•¨ê»˜ ë™ê¸°í™”í•©ë‹ˆë‹¤.</p>
                                </div>
                            </div>
                            
                            <div class="selected-calendar-preview">
                                <h5>ì„ íƒëœ ìº˜ë¦°ë”</h5>
                                <div class="preview-card" id="selected-calendar-preview">
                                    <!-- ì„ íƒëœ ìº˜ë¦°ë” ì •ë³´ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                                </div>
                            </div>
                        </div>
                        
                        <div class="step-content hidden" id="step3">
                            <div class="completion-content">
                                <div class="success-icon">
                                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#10B981" stroke-width="2">
                                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                        <polyline points="22,4 12,14.01 9,11.01"></polyline>
                                    </svg>
                                </div>
                                <h4>ì—°ë™ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!</h4>
                                <p>ì´ì œ ${platformDisplayName}ì™€ NotionFlow ìº˜ë¦°ë”ê°€ ë™ê¸°í™”ë©ë‹ˆë‹¤.</p>
                                
                                <div class="completion-details">
                                    <div class="detail-item">
                                        <span class="detail-label">ì—°ë™ëœ ìº˜ë¦°ë”:</span>
                                        <span class="detail-value" id="synced-calendar-name"></span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">ì—°ë™ í”Œë«í¼:</span>
                                        <span class="detail-value">${platformDisplayName}</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">ì—°ë™ ì‹œê°„:</span>
                                        <span class="detail-value">${new Date().toLocaleString()}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="modal-footer">
                        <button class="btn-secondary" onclick="closeCalendarSyncModal()">ì·¨ì†Œ</button>
                        <button class="btn-primary" id="next-step-btn" onclick="nextSyncStep()" disabled>ë‹¤ìŒ</button>
                        <button class="btn-primary hidden" id="sync-btn" onclick="performSync('${platform}')">ì—°ë™ ì‹œì‘</button>
                        <button class="btn-primary hidden" id="complete-btn" onclick="closeCalendarSyncModal()">ì™„ë£Œ</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            modal.style.display = 'flex';

            // ìº˜ë¦°ë” ì¹´ë“œ ìƒì„±
            const calendarGrid = document.getElementById('calendar-grid');
            calendars.forEach(calendar => {
                const calendarCard = createCalendarCard(calendar, platform);
                calendarGrid.appendChild(calendarCard);
            });

        } catch (error) {
            console.error('ìº˜ë¦°ë” ì—°ë™ ëª¨ë‹¬ ì˜¤ë¥˜:', error);
            showErrorModal('ìº˜ë¦°ë” ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    }

    // ìº˜ë¦°ë” ì—°ë™ ëª¨ë‹¬ ë‹«ê¸°
    function closeCalendarSyncModal() {
        const modal = document.querySelector('.calendar-sync-modal');
        if (modal) {
            modal.remove();
        }
    }

    // ìº˜ë¦°ë” ì„ íƒ ë° ì—°ë™
    // ì „ì—­ ë³€ìˆ˜
    let selectedCalendarData = null;
    let currentSyncStep = 1;

    // í”Œë«í¼ ì•„ì´ì½˜ ê°€ì ¸ì˜¤ê¸°
    function getPlatformIcon(platform) {
        const icons = {
            notion: 'ğŸ”—',
            google: 'ğŸ“…',
            apple: 'ğŸ',
            outlook: 'ğŸ“§',
            slack: 'ğŸ’¬'
        };
        return icons[platform] || 'ğŸ”—';
    }

    // ë‚ ì§œ í¬ë§·íŒ…
    function formatDate(dateString) {
        if (!dateString || dateString === 'undefined') {
            return 'ì•Œ ìˆ˜ ì—†ìŒ';
        }
        const date = new Date(dateString);
        return date.toLocaleDateString('ko-KR', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
    }

    // ìº˜ë¦°ë” ì„ íƒ (ìƒˆë¡œìš´ step-by-step ë°©ì‹)
    function selectCalendarForSync(element, platform) {
        // ê¸°ì¡´ ì„ íƒ í•´ì œ
        document.querySelectorAll('.calendar-card').forEach(card => {
            card.classList.remove('selected');
        });

        // ìƒˆë¡œìš´ ì„ íƒ
        element.classList.add('selected');

        // ì„ íƒëœ ìº˜ë¦°ë” ë°ì´í„° ì €ì¥
        const calendarId = element.dataset.calendarId;
        const calendarName = element.querySelector('.calendar-name').textContent;
        const calendarDescription = element.querySelector('.calendar-description').textContent;
        const calendarIcon = element.querySelector('.calendar-icon-large').textContent;

        selectedCalendarData = {
            id: calendarId,
            name: calendarName,
            description: calendarDescription,
            icon: calendarIcon,
            platform: platform
        };

        // ë‹¤ìŒ ë²„íŠ¼ í™œì„±í™”
        const nextBtn = document.getElementById('next-step-btn');
        nextBtn.disabled = false;
        nextBtn.textContent = 'ë‹¤ìŒ';
    }

    // ìŠ¤í… ì´ë™ í•¨ìˆ˜
    function nextSyncStep() {
        if (currentSyncStep === 1) {
            showStep2();
            currentSyncStep = 2;
        } else if (currentSyncStep === 2) {
            showSyncButton();
        }
    }

    // 2ë‹¨ê³„ë¡œ ì´ë™
    function showStep2() {
        // ìŠ¤í… ì¸ë””ì¼€ì´í„° ì—…ë°ì´íŠ¸
        document.querySelectorAll('.step').forEach((step, index) => {
            if (index === 1) {
                step.classList.add('active');
            } else if (index === 0) {
                step.classList.add('completed');
                step.classList.remove('active');
            }
        });

        // ì½˜í…ì¸  ì „í™˜
        document.getElementById('step1').classList.add('hidden');
        document.getElementById('step2').classList.remove('hidden');

        // ì„ íƒëœ ìº˜ë¦°ë” í”„ë¦¬ë·° ì—…ë°ì´íŠ¸
        const previewContainer = document.getElementById('selected-calendar-preview');
        previewContainer.innerHTML = `
            <div class="preview-calendar-card">
                <div class="preview-icon">${selectedCalendarData.icon}</div>
                <div class="preview-info">
                    <h6>${selectedCalendarData.name}</h6>
                    <p>${selectedCalendarData.description}</p>
                </div>
            </div>
        `;

        // ë²„íŠ¼ ì—…ë°ì´íŠ¸
        const nextBtn = document.getElementById('next-step-btn');
        nextBtn.textContent = 'ì„¤ì • ì™„ë£Œ';
    }

    // ì—°ë™ ë²„íŠ¼ í‘œì‹œ
    function showSyncButton() {
        const nextBtn = document.getElementById('next-step-btn');
        const syncBtn = document.getElementById('sync-btn');

        nextBtn.classList.add('hidden');
        syncBtn.classList.remove('hidden');
    }

    // ì‹¤ì œ ì—°ë™ ìˆ˜í–‰
    async function performSync(platform) {
        const syncBtn = document.getElementById('sync-btn');
        const originalText = syncBtn.textContent;

        // ë¡œë”© ìƒíƒœ
        syncBtn.disabled = true;
        syncBtn.innerHTML = `
            <div class="btn-loading">
                <div class="spinner"></div>
                <span>ì—°ë™ ì¤‘...</span>
            </div>
        `;

        try {
            // 1ë‹¨ê³„: ë…¸ì…˜ ìº˜ë¦°ë”ì˜ ê¸°ì¡´ ì¼ì • ì¡°íšŒ
            syncBtn.innerHTML = `
                <div class="btn-loading">
                    <div class="spinner"></div>
                    <span>ë…¸ì…˜ ì¼ì • ì¡°íšŒ ì¤‘...</span>
                </div>
            `;
            
            const eventsResponse = await fetch(`/api/calendars/${selectedCalendarData.id}/events`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            let existingEvents = [];
            if (eventsResponse.ok) {
                const eventsData = await eventsResponse.json();
                existingEvents = eventsData.events || [];
                console.log(`Found ${existingEvents.length} existing events in Notion calendar`);
            }
            
            // 2ë‹¨ê³„: í”Œë«í¼ ì—°ë™ ë° ì¼ì • ë™ê¸°í™”
            syncBtn.innerHTML = `
                <div class="btn-loading">
                    <div class="spinner"></div>
                    <span>ì—°ë™ ë° ë™ê¸°í™” ì¤‘...</span>
                </div>
            `;

            const response = await fetch('/api/sync-calendar', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    platform: platform,
                    calendar_id: selectedCalendarData.id,
                    existing_events: existingEvents,
                    sync_existing: true,
                    settings: {
                        bidirectional: document.getElementById('bidirectional-sync').checked,
                        realTime: document.getElementById('real-time-sync').checked,
                        notifications: document.getElementById('notification-sync').checked
                    }
                })
            });

            const result = await response.json();

            if (response.ok && result.success) {
                // ë™ê¸°í™” ê²°ê³¼ í‘œì‹œ
                if (result.synced_events_count > 0) {
                    console.log(`Successfully synced ${result.synced_events_count}/${result.total_events} events`);
                    showNotification(
                        `${result.synced_events_count}ê°œì˜ ê¸°ì¡´ ì¼ì •ì´ ${result.platform}ê³¼ ë™ê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤!`, 
                        'success'
                    );
                } else if (result.total_events > 0) {
                    console.log(`No events were synced (${result.total_events} events found)`);
                    showNotification('ì—°ë™ì´ ì™„ë£Œë˜ì—ˆì§€ë§Œ ì¼ë¶€ ì¼ì • ë™ê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'warning');
                } else {
                    showNotification(`${result.platform} ì—°ë™ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!`, 'success');
                }
                
                showStep3();
            } else {
                throw new Error(result.error || 'ì—°ë™ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        } catch (error) {
            console.error('ìº˜ë¦°ë” ì—°ë™ ì˜¤ë¥˜:', error);
            showErrorInModal(error.message);

            // ë²„íŠ¼ ë³µì›
            syncBtn.disabled = false;
            syncBtn.textContent = originalText;
        }
    }

    // 3ë‹¨ê³„ í‘œì‹œ (ì™„ë£Œ)
    function showStep3() {
        currentSyncStep = 3;

        // ìŠ¤í… ì¸ë””ì¼€ì´í„° ì—…ë°ì´íŠ¸
        document.querySelectorAll('.step').forEach((step, index) => {
            if (index === 2) {
                step.classList.add('active');
            } else {
                step.classList.add('completed');
                step.classList.remove('active');
            }
        });

        // ì½˜í…ì¸  ì „í™˜
        document.getElementById('step2').classList.add('hidden');
        document.getElementById('step3').classList.remove('hidden');

        // ì™„ë£Œ ì •ë³´ ì—…ë°ì´íŠ¸
        document.getElementById('synced-calendar-name').textContent = selectedCalendarData.name;

        // ë²„íŠ¼ ì—…ë°ì´íŠ¸
        const syncBtn = document.getElementById('sync-btn');
        const completeBtn = document.getElementById('complete-btn');

        syncBtn.classList.add('hidden');
        completeBtn.classList.remove('hidden');

        // ì—°ë™ ìƒíƒœ ì—…ë°ì´íŠ¸
        const syncInfo = {
            calendar_name: selectedCalendarData.name,
            calendar_id: selectedCalendarData.id,
            synced_at: new Date().toLocaleString(),
            sync_status: 'active'
        };
        updateCalendarSyncStatus(selectedCalendarData.platform, syncInfo);
    }

    // ì—ëŸ¬ í‘œì‹œ
    function showErrorInModal(message) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'sync-error';
        errorDiv.innerHTML = `
            <div class="error-icon">âš ï¸</div>
            <div class="error-message">${message}</div>
        `;

        const modalBody = document.querySelector('.calendar-sync-modal .modal-body');
        modalBody.insertBefore(errorDiv, modalBody.firstChild);

        // 3ì´ˆ í›„ ì—ëŸ¬ ë©”ì‹œì§€ ì œê±°
        setTimeout(() => {
            errorDiv.remove();
        }, 3000);
    }

    // ìº˜ë¦°ë”ê°€ ì—†ì„ ë•Œ í‘œì‹œí•  ëª¨ë‹¬
    function showNoCalendarsModal(platform) {
        const modal = document.createElement('div');
        modal.className = 'calendar-sync-modal no-calendars-modal';
        modal.innerHTML = `
            <div class="modal-backdrop" onclick="closeCalendarSyncModal()"></div>
            <div class="modal-content">
                <div class="modal-header">
                    <h3>ìº˜ë¦°ë”ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
                    <button class="modal-close" onclick="closeCalendarSyncModal()">Ã—</button>
                </div>
                <div class="modal-body">
                    <div class="no-calendars-content">
                        <div class="empty-icon">ğŸ“…</div>
                        <h4>ì—°ë™í•  ìº˜ë¦°ë”ê°€ ì—†ìŠµë‹ˆë‹¤</h4>
                        <p>ë¨¼ì € NotionFlowì—ì„œ ìº˜ë¦°ë”ë¥¼ ìƒì„±í•œ í›„ ì—°ë™ì„ ì‹œë„í•´ì£¼ì„¸ìš”.</p>
                        <a href="/calendars" class="btn-primary">ìº˜ë¦°ë” ìƒì„±í•˜ëŸ¬ ê°€ê¸°</a>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="closeCalendarSyncModal()">ë‹«ê¸°</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        modal.style.display = 'flex';
    }

    // ì—ëŸ¬ ëª¨ë‹¬
    function showErrorModal(message) {
        const modal = document.createElement('div');
        modal.className = 'calendar-sync-modal error-modal';
        modal.innerHTML = `
            <div class="modal-backdrop" onclick="closeCalendarSyncModal()"></div>
            <div class="modal-content">
                <div class="modal-header">
                    <h3>ì˜¤ë¥˜ ë°œìƒ</h3>
                    <button class="modal-close" onclick="closeCalendarSyncModal()">Ã—</button>
                </div>
                <div class="modal-body">
                    <div class="error-content">
                        <div class="error-icon">âš ï¸</div>
                        <p>${message}</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-primary" onclick="closeCalendarSyncModal()">í™•ì¸</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        modal.style.display = 'flex';
    }

    // ìº˜ë¦°ë” ì¹´ë“œ ìƒì„± í•¨ìˆ˜
    function createCalendarCard(calendar, platform) {
        const cardDiv = document.createElement('div');
        cardDiv.className = 'calendar-card';
        cardDiv.setAttribute('data-calendar-id', calendar.id);
        cardDiv.onclick = () => selectCalendarForSync(cardDiv, platform);

        const iconStyle = 'background-color: ' + (calendar.color || '#3b82f6') + '; color: white; display: flex; align-items: center; justify-content: center; border-radius: 8px; font-size: 20px;';
        const createdDate = calendar.created_at ? formatDate(calendar.created_at) : 'ë‚ ì§œ ì—†ìŒ';

        const calendarName = calendar.name || 'ì´ë¦„ ì—†ìŒ';
        const calendarDesc = calendar.description || 'ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤';
        const calendarType = calendar.type || 'personal';

        cardDiv.innerHTML =
            '<div class="calendar-card-header">' +
            '<div class="calendar-icon-large" style="' + iconStyle + '">ğŸ“…</div>' +
            '<div class="selection-indicator">' +
            '<div class="radio-button"></div>' +
            '</div>' +
            '</div>' +
            '<div class="calendar-card-body">' +
            '<h5 class="calendar-name">' + calendarName + '</h5>' +
            '<p class="calendar-description">' + calendarDesc + '</p>' +
            '<div class="calendar-meta">' +
            '<span class="created-date">ìƒì„±ì¼: ' + createdDate + '</span>' +
            '<span class="calendar-type">' + calendarType + '</span>' +
            '</div>' +
            '</div>';

        return cardDiv;
    }

    // ê¸°ì¡´ selectCalendar í•¨ìˆ˜ (í˜¸í™˜ì„±ì„ ìœ„í•´ ìœ ì§€)
    async function selectCalendar(element, platform) {
        const calendarId = element.dataset.calendarId;
        const calendarName = element.querySelector('.calendar-name').textContent;

        if (!confirm(`"${calendarName}" ìº˜ë¦°ë”ë¥¼ ${platform}ê³¼ ì—°ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
            return;
        }

        try {
            const response = await fetch('/api/sync-calendar', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    platform: platform,
                    calendar_id: calendarId
                })
            });

            const result = await response.json();

            if (response.ok) {
                alert('' + platform + ' ìº˜ë¦°ë” ì—°ë™ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
                closeCalendarSyncModal();

                // ì—°ë™ ìƒíƒœ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
                const syncInfo = {
                    calendar_name: calendarName,
                    calendar_id: calendarId,
                    synced_at: new Date().toLocaleString(),
                    sync_status: 'active'
                };
                updateCalendarSyncStatus(platform, syncInfo);
            } else {
                throw new Error(result.error || 'Failed to sync calendar');
            }
        } catch (error) {
            console.error('ìº˜ë¦°ë” ì—°ë™ ì˜¤ë¥˜:', error);
            alert('ìº˜ë¦°ë” ì—°ë™ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    }

    // slideOutUp ì• ë‹ˆë©”ì´ì…˜ ì¶”ê°€
    const style = document.createElement('style');
    style.textContent = `
    @keyframes slideOutUp {
        from {
            opacity: 1;
            transform: translateY(0);
        }
        to {
            opacity: 0;
            transform: translateY(-20px);
        }
    }
    
    /* ìº˜ë¦°ë” ì—°ë™ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .calendar-sync-btn {
        background: #3b82f6;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        margin-left: 8px;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
    }
    
    .calendar-sync-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }
    
    .calendar-sync-btn:active {
        transform: translateY(0);
    }
    
    .sync-loader {
        display: inline-block;
        width: 16px;
        height: 16px;
    }
    
    .sync-loader .loader-dot {
        width: 16px;
        height: 16px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-top: 2px solid white;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    /* ìº˜ë¦°ë” ì—°ë™ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
    /* Enhanced Calendar Sync Modal Styles */
    .calendar-sync-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(4px);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        animation: fadeIn 0.3s ease-out;
    }
    
    .calendar-sync-modal .modal-content {
        background: white;
        border-radius: 16px;
        width: 700px;
        max-width: 95vw;
        max-height: 90vh;
        overflow: hidden;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        animation: slideInScale 0.4s ease-out;
    }
    
    .calendar-sync-modal .modal-header {
        padding: 24px;
        border-bottom: 1px solid #f3f4f6;
        background: #3b82f6;
        color: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .calendar-sync-modal .modal-title-section {
        display: flex;
        align-items: center;
        gap: 16px;
    }
    
    .calendar-sync-modal .platform-icon {
        font-size: 28px;
        background: rgba(255, 255, 255, 0.2);
        padding: 12px;
        border-radius: 12px;
    }
    
    .calendar-sync-modal .modal-title-text h3 {
        margin: 0;
        font-size: 20px;
        font-weight: 600;
    }
    
    .calendar-sync-modal .platform-subtitle {
        margin: 4px 0 0 0;
        opacity: 0.9;
        font-size: 14px;
    }
    
    .calendar-sync-modal .modal-close {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        cursor: pointer;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        transition: background 0.2s ease;
    }
    
    .calendar-sync-modal .modal-close:hover {
        background: rgba(255, 255, 255, 0.3);
    }
    
    .calendar-sync-modal .modal-body {
        padding: 24px;
        max-height: 60vh;
        overflow-y: auto;
    }
    
    /* Step Indicator */
    .sync-step-indicator {
        display: flex;
        justify-content: center;
        margin-bottom: 32px;
    }
    
    .sync-step-indicator .step {
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
        flex: 1;
        max-width: 120px;
    }
    
    .sync-step-indicator .step:not(:last-child)::after {
        content: '';
        position: absolute;
        top: 20px;
        right: -50%;
        width: 100%;
        height: 2px;
        background: #e5e7eb;
        z-index: -1;
    }
    
    .sync-step-indicator .step.active:not(:last-child)::after,
    .sync-step-indicator .step.completed:not(:last-child)::after {
        background: #3b82f6;
    }
    
    .sync-step-indicator .step-number {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #e5e7eb;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        margin-bottom: 8px;
        color: #6b7280;
        transition: all 0.3s ease;
    }
    
    .sync-step-indicator .step.active .step-number {
        background: #3b82f6;
        color: white;
    }
    
    .sync-step-indicator .step.completed .step-number {
        background: #10b981;
        color: white;
    }
    
    .sync-step-indicator .step span {
        font-size: 12px;
        color: #6b7280;
        text-align: center;
    }
    
    .sync-step-indicator .step.active span,
    .sync-step-indicator .step.completed span {
        color: #374151;
        font-weight: 500;
    }
    
    /* Step Content */
    .step-content {
        transition: all 0.3s ease;
    }
    
    .step-content.hidden {
        display: none;
    }
    
    .step-description {
        text-align: center;
        margin-bottom: 24px;
    }
    
    .step-description h4 {
        margin: 0 0 8px 0;
        color: #1f2937;
        font-size: 18px;
        font-weight: 600;
    }
    
    .step-description p {
        margin: 0;
        color: #6b7280;
        font-size: 14px;
    }
    
    /* Calendar Grid */
    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 16px;
        margin-top: 20px;
    }
    
    .calendar-card {
        border: 2px solid #f3f4f6;
        border-radius: 12px;
        padding: 16px;
        cursor: pointer;
        transition: all 0.3s ease;
        background: white;
    }
    
    .calendar-card:hover {
        border-color: #3b82f6;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        transform: translateY(-2px);
    }
    
    .calendar-card.selected {
        border-color: #3b82f6;
        background: linear-gradient(135deg, #f8f9ff 0%, #f0f4ff 100%);
    }
    
    .calendar-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
    }
    
    .calendar-icon-large {
        font-size: 32px;
    }
    
    .selection-indicator {
        position: relative;
    }
    
    .radio-button {
        width: 20px;
        height: 20px;
        border: 2px solid #d1d5db;
        border-radius: 50%;
        position: relative;
        transition: all 0.2s ease;
    }
    
    .calendar-card.selected .radio-button {
        border-color: #3b82f6;
        background: #3b82f6;
    }
    
    .calendar-card.selected .radio-button::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: white;
    }
    
    .calendar-card-body h5 {
        margin: 0 0 8px 0;
        color: #1f2937;
        font-size: 16px;
        font-weight: 600;
    }
    
    .calendar-card-body p {
        margin: 0 0 12px 0;
        color: #6b7280;
        font-size: 14px;
    }
    
    .calendar-meta {
        font-size: 12px;
        color: #9ca3af;
    }
    
    /* Sync Settings */
    .sync-settings {
        margin: 24px 0;
    }
    
    .setting-group {
        margin-bottom: 20px;
    }
    
    .setting-label {
        display: flex;
        align-items: center;
        cursor: pointer;
        font-weight: 500;
        color: #374151;
        margin-bottom: 4px;
    }
    
    .setting-label input[type="checkbox"] {
        display: none;
    }
    
    .checkmark {
        width: 20px;
        height: 20px;
        border: 2px solid #d1d5db;
        border-radius: 4px;
        margin-right: 12px;
        position: relative;
        transition: all 0.2s ease;
    }
    
    .setting-label input[type="checkbox"]:checked + .checkmark {
        background: #3b82f6;
        border-color: #3b82f6;
    }
    
    .setting-label input[type="checkbox"]:checked + .checkmark::after {
        content: 'âœ“';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-size: 12px;
        font-weight: bold;
    }
    
    .setting-description {
        margin: 0 0 0 32px;
        font-size: 14px;
        color: #6b7280;
    }
    
    /* Selected Calendar Preview */
    .selected-calendar-preview {
        margin-top: 24px;
        padding-top: 24px;
        border-top: 1px solid #f3f4f6;
    }
    
    .selected-calendar-preview h5 {
        margin: 0 0 12px 0;
        color: #374151;
        font-weight: 600;
    }
    
    .preview-calendar-card {
        display: flex;
        align-items: center;
        padding: 12px;
        background: #f8f9fa;
        border-radius: 8px;
        border-left: 4px solid #3b82f6;
    }
    
    .preview-icon {
        font-size: 24px;
        margin-right: 12px;
    }
    
    .preview-info h6 {
        margin: 0 0 4px 0;
        color: #1f2937;
        font-weight: 600;
    }
    
    .preview-info p {
        margin: 0;
        font-size: 14px;
        color: #6b7280;
    }
    
    /* Completion Content */
    .completion-content {
        text-align: center;
        padding: 20px;
    }
    
    .success-icon {
        margin-bottom: 16px;
    }
    
    .completion-content h4 {
        margin: 0 0 8px 0;
        color: #1f2937;
        font-size: 20px;
        font-weight: 600;
    }
    
    .completion-content p {
        margin: 0 0 24px 0;
        color: #6b7280;
    }
    
    .completion-details {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 16px;
        text-align: left;
    }
    
    .detail-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
    }
    
    .detail-item:last-child {
        margin-bottom: 0;
    }
    
    .detail-label {
        font-weight: 500;
        color: #6b7280;
    }
    
    .detail-value {
        font-weight: 600;
        color: #1f2937;
    }
    
    /* Modal Footer */
    .calendar-sync-modal .modal-footer {
        padding: 20px 24px;
        border-top: 1px solid #f3f4f6;
        display: flex;
        justify-content: flex-end;
        gap: 12px;
    }
    
    .calendar-sync-modal .btn-secondary,
    .calendar-sync-modal .btn-primary {
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .calendar-sync-modal .btn-secondary {
        background: #f3f4f6;
        color: #6b7280;
    }
    
    .calendar-sync-modal .btn-secondary:hover {
        background: #e5e7eb;
    }
    
    .calendar-sync-modal .btn-primary {
        background: #3b82f6;
        color: white;
    }
    
    .calendar-sync-modal .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }
    
    .calendar-sync-modal .btn-primary:disabled {
        background: #d1d5db;
        color: #9ca3af;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }
    
    .calendar-sync-modal .hidden {
        display: none !important;
    }
    
    /* Loading States */
    .btn-loading {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .spinner {
        width: 16px;
        height: 16px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 1s ease-in-out infinite;
    }
    
    /* Error States */
    .sync-error {
        background: #fef2f2;
        border: 1px solid #fecaca;
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .sync-error .error-icon {
        font-size: 18px;
    }
    
    .sync-error .error-message {
        color: #dc2626;
        font-size: 14px;
    }
    
    /* No Calendars Modal */
    .no-calendars-content,
    .error-content {
        text-align: center;
        padding: 40px 20px;
    }
    
    .no-calendars-content .empty-icon,
    .error-content .error-icon {
        font-size: 48px;
        margin-bottom: 16px;
    }
    
    .no-calendars-content h4 {
        margin: 0 0 8px 0;
        color: #1f2937;
        font-size: 18px;
    }
    
    .no-calendars-content p {
        margin: 0 0 24px 0;
        color: #6b7280;
    }
    
    /* Animations */
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    @keyframes slideInScale {
        from {
            opacity: 0;
            transform: scale(0.9) translateY(20px);
        }
        to {
            opacity: 1;
            transform: scale(1) translateY(0);
        }
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    /* ì—°ë™ëœ ìº˜ë¦°ë” ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .platform-sync-btn.synced {
        background: linear-gradient(45deg, #28a745 0%, #20c997 100%);
        color: white;
        min-width: 180px;
        white-space: nowrap;
    }
    
    .platform-sync-btn.synced:hover {
        background: linear-gradient(45deg, #218838 0%, #1ea080 100%);
        transform: translateY(-1px);
        box-shadow: 0 3px 10px rgba(40, 167, 69, 0.4);
    }
    
    .platform-sync-btn.synced .sync-text {
        font-weight: 600;
    }
    
    /* ì›í´ë¦­ ì—°ê²°í•´ì œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .one-click-disconnect-btn {
        background: linear-gradient(45deg, #dc3545 0%, #c82333 100%);
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(220, 53, 69, 0.3);
    }
    
    .one-click-disconnect-btn:hover {
        background: linear-gradient(45deg, #c82333 0%, #a71e2a 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(220, 53, 69, 0.4);
    }
    
    .one-click-disconnect-btn:active {
        transform: translateY(0);
    }
    
    .one-click-disconnect-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }
`;
    document.head.appendChild(style);

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì—°ë™ëœ ìº˜ë¦°ë” ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadSyncedCalendars() {
        try {
            const response = await fetch('/api/synced-calendars');
            const syncedCalendars = await response.json();

            if (response.ok) {
                // ê° í”Œë«í¼ì˜ ì—°ë™ ìƒíƒœ ì—…ë°ì´íŠ¸
                Object.keys(syncedCalendars).forEach(platform => {
                    const syncInfo = syncedCalendars[platform];
                    updateCalendarSyncStatus(platform, syncInfo);
                });
            }
        } catch (error) {
            console.error('ì—°ë™ëœ ìº˜ë¦°ë” ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
        }
    }

    // ìº˜ë¦°ë” ì—°ë™ ìƒíƒœ ì—…ë°ì´íŠ¸
    function updateCalendarSyncStatus(platform, syncInfo) {
        const card = document.querySelector('[data-platform="' + platform + '"]');
        if (!card) return;

        const syncBtn = card.querySelector('.platform-sync-btn');
        if (syncBtn) {
            // ì—°ë™ëœ ìº˜ë¦°ë”ê°€ ìˆìœ¼ë©´ ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½
            const syncText = syncBtn.querySelector('.sync-text');
            if (syncText) {
                syncText.textContent = 'ì—°ë™ë¨: ' + syncInfo.calendar_name + '';
                syncBtn.classList.add('synced');
                syncBtn.title = syncInfo.calendar_name + 'ê³¼ ì—°ë™ë¨ (' + syncInfo.synced_at + ')';
            }
        }
    }

    // ì›í´ë¦­ ì—°ê²°í•´ì œ í•¨ìˆ˜
    async function oneClickDisconnect(platform) {
        const card = document.querySelector('[data-platform="' + platform + '"]');
        if (!card) return;

        const button = card.querySelector('.one-click-disconnect-btn');
        if (!button) return;

        const buttonText = button.querySelector('.btn-text');
        const loader = button.querySelector('.btn-loader');

        if (!confirm(`${getKoreanPlatformName(platform)} ì—°ê²°ì„ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
            return;
        }

        try {
            // ë¡œë”© ìƒíƒœ í‘œì‹œ
            buttonText.style.display = 'none';
            loader.style.display = 'inline-block';
            button.disabled = true;

            // ì—°ê²° í•´ì œ API í˜¸ì¶œ
            await markPlatformDisconnected(platform);

            const response = await fetch(`/api/platform/${platform}/disconnect`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });

            if (response.ok) {
                // í”Œë«í¼ ìƒíƒœë¥¼ ì—°ê²°ë˜ì§€ ì•ŠìŒìœ¼ë¡œ ì—…ë°ì´íŠ¸
                updatePlatformStatus(platform, 'disconnected');

                // ì„±ê³µ ë©”ì‹œì§€
                showNotification(`${getKoreanPlatformName(platform)} ì—°ê²°ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
            } else {
                const errorData = await response.json();
                throw new Error(errorData.error || 'ì—°ê²° í•´ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        } catch (error) {
            console.error('ì›í´ë¦­ ì—°ê²°í•´ì œ ì˜¤ë¥˜:', error);
            showNotification(`ì—°ê²° í•´ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`, 'error');
        } finally {
            // ë¡œë”© ìƒíƒœ í•´ì œ
            buttonText.style.display = 'inline';
            loader.style.display = 'none';
            button.disabled = false;
        }
    }

    // Platform connection management functions
    async function markPlatformConnected(platform) {
        try {
            const response = await fetch(`/api/platform/${platform}/connect`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                console.error('Failed to mark ' + platform + ' as connected');
            }
        } catch (error) {
            console.error('Error marking ' + platform + ' as connected:', error);
        }
    }

    async function markPlatformDisconnected(platform) {
        try {
            const response = await fetch(`/api/platform/${platform}/disconnect`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                console.error('Failed to mark ' + platform + ' as disconnected');
            }
        } catch (error) {
            console.error('Error marking ' + platform + ' as disconnected:', error);
        }
    }

    async function loadAllPlatformStatus() {
        try {
            const response = await fetch('/api/platforms/status');
            const data = await response.json();

            if (data.success && data.platforms) {
                // Update UI based on stored platform statuses
                for (const [platform, status] of Object.entries(data.platforms)) {
                    if (status.connected) {
                        updatePlatformStatus(platform, 'connected');
                    } else {
                        updatePlatformStatus(platform, 'disconnected');
                    }
                }
                console.log('Platform statuses loaded:', data.platforms);
            }
        } catch (error) {
            console.error('Error loading platform statuses:', error);
        }
    }

    // í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ í›„ ì—°ë™ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
    document.addEventListener('DOMContentLoaded', function () {
        loadSyncedCalendars();
        loadAllPlatformStatus(); // Load platform connection states
    });

</script>
{% endblock %}