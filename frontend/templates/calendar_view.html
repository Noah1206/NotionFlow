{% extends "base_dashboard.html" %}

{% block body_class %}calendar-view-page{% endblock %}

{% block title %}캘린더 - NotionFlow{% endblock %}

{% block description %}NotionFlow 통합 캘린더에서 일정을 관리하고 할일을 추가하세요.{% endblock %}

{% block extra_css %}
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    :root {
        --bg-primary: #ffffff;
        --bg-secondary: #f8f9fa;
        --bg-tertiary: #f5f5f5;
        --text-primary: #000000;
        --text-secondary: #666666;
        --text-tertiary: #999999;
        --accent-primary: #3B82F6;
        --accent-secondary: #e3f2fd;
        --border-color: #e5e5e5;
        --border-light: #f0f0f0;
        --shadow-light: rgba(0, 0, 0, 0.1);
        --shadow-medium: rgba(0, 0, 0, 0.15);
        --success-color: #10b981;
        --warning-color: #f59e0b;
        --error-color: #ef4444;
    }

    .calendar-container {
        background: var(--bg-secondary);
        min-height: calc(100vh - 80px);
        padding: 2rem;
    }

    .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        background: var(--bg-primary);
        padding: 1.5rem;
        border-radius: 12px;
        box-shadow: 0 2px 8px var(--shadow-light);
    }

    .calendar-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .calendar-nav {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .nav-button {
        background: none;
        border: none;
        padding: 0.5rem;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s ease;
        color: var(--text-secondary);
    }

    .nav-button:hover {
        background: var(--bg-tertiary);
        color: var(--text-primary);
    }

    .month-year {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-primary);
        min-width: 140px;
        text-align: center;
    }

    .notion-badge {
        background: #ff6b35;
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 600;
    }

    /* 캘린더 그리드 */
    .calendar-grid {
        background: var(--bg-primary);
        border-radius: 12px;
        box-shadow: 0 2px 8px var(--shadow-light);
        overflow: hidden;
    }

    .calendar-weekdays {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        background: var(--bg-tertiary);
        border-bottom: 1px solid var(--border-color);
    }

    .weekday {
        padding: 1rem;
        text-align: center;
        font-weight: 600;
        font-size: 0.9rem;
        color: var(--text-secondary);
    }

    .calendar-days {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
    }

    .calendar-day {
        min-height: 120px;
        border-right: 1px solid var(--border-light);
        border-bottom: 1px solid var(--border-light);
        padding: 0.75rem;
        position: relative;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .calendar-day:hover {
        background: var(--bg-secondary);
    }

    .calendar-day:nth-child(7n) {
        border-right: none;
    }

    .day-number {
        font-weight: 600;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
    }

    .day-number.today {
        background: #ff4757;
        color: white;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .day-number.other-month {
        color: var(--text-tertiary);
    }

    /* 이벤트 스타일 */
    .event {
        background: var(--bg-tertiary);
        border-radius: 6px;
        padding: 0.25rem 0.5rem;
        margin-bottom: 0.25rem;
        font-size: 0.8rem;
        cursor: pointer;
        transition: all 0.2s ease;
        border-left: 3px solid var(--accent-primary);
    }

    .event:hover {
        background: var(--accent-secondary);
        transform: translateX(2px);
    }

    .event.task {
        border-left-color: var(--warning-color);
    }

    .event.completed {
        border-left-color: var(--success-color);
        text-decoration: line-through;
        opacity: 0.7;
    }

    .event-title {
        font-weight: 500;
        margin-bottom: 0.1rem;
    }

    .event-subtitle {
        font-size: 0.7rem;
        color: var(--text-secondary);
    }

    .event-done {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        font-size: 0.7rem;
        color: var(--success-color);
        font-weight: 600;
    }

    /* 멀티데이 이벤트 스타일 */
    .multi-day-event {
        position: relative;
        margin-bottom: 0.25rem;
    }

    .multi-day-event.event-start {
        border-top-right-radius: 0;
        border-bottom-right-radius: 0;
        border-right: none;
    }

    .multi-day-event.event-middle {
        border-radius: 0;
        border-right: none;
        border-left: none;
    }

    .multi-day-event.event-end {
        border-top-left-radius: 0;
        border-bottom-left-radius: 0;
        border-left: none;
    }

    /* 연속된 이벤트 바 효과 */
    .multi-day-event.event-start::after {
        content: '';
        position: absolute;
        top: 0;
        right: -1px;
        width: 1px;
        height: 100%;
        background: var(--accent-primary);
    }

    .multi-day-event.event-middle::before,
    .multi-day-event.event-middle::after {
        content: '';
        position: absolute;
        top: 0;
        width: 1px;
        height: 100%;
        background: var(--accent-primary);
    }

    .multi-day-event.event-middle::before {
        left: -1px;
    }

    .multi-day-event.event-middle::after {
        right: -1px;
    }

    .multi-day-event.event-end::before {
        content: '';
        position: absolute;
        top: 0;
        left: -1px;
        width: 1px;
        height: 100%;
        background: var(--accent-primary);
    }

    /* 반응형 */
    @media (max-width: 768px) {
        .calendar-container {
            padding: 1rem;
        }

        .calendar-day {
            min-height: 80px;
            padding: 0.5rem;
        }

        .calendar-header {
            flex-direction: column;
            gap: 1rem;
        }
    }

    /* 추가 스타일 */
    .add-event-btn {
        position: absolute;
        bottom: 0.5rem;
        right: 0.5rem;
        width: 20px;
        height: 20px;
        background: var(--accent-primary);
        color: white;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        opacity: 0;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
    }

    .calendar-day:hover .add-event-btn {
        opacity: 1;
    }

    .task-dump {
        background: #ff4757;
        color: white;
        padding: 0.5rem;
        border-radius: 6px;
        font-size: 0.8rem;
        cursor: pointer;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .task-dump:hover {
        background: #ff3742;
    }

    /* 컨텍스트 메뉴 스타일 */
    .context-menu {
        position: fixed;
        background: white;
        border: 1px solid #e5e5e5;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        padding: 0.5rem 0;
        min-width: 120px;
        display: none;
    }

    .context-menu-item {
        padding: 0.75rem 1rem;
        cursor: pointer;
        transition: background-color 0.2s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.9rem;
        color: var(--text-primary);
    }

    .context-menu-item:hover {
        background-color: var(--bg-tertiary);
    }

    .context-menu-item.delete {
        color: var(--error-color);
    }

    .context-menu-item.edit {
        color: var(--accent-primary);
    }
</style>
{% endblock %}

{% block content %}
<div class="calendar-container">
    <!-- 캘린더 헤더 -->
    <div class="calendar-header">
        <div class="calendar-title">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                <line x1="16" y1="2" x2="16" y2="6"/>
                <line x1="8" y1="2" x2="8" y2="6"/>
                <line x1="3" y1="10" x2="21" y2="10"/>
            </svg>
            To Do List
            <span class="notion-badge">Notion 캘린더에서 열기</span>
        </div>
        <div class="calendar-nav">
            <button class="nav-button" onclick="previousMonth()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="15,18 9,12 15,6"/>
                </svg>
            </button>
            <div class="month-year" id="monthYear">2025년 1월</div>
            <button class="nav-button" onclick="nextMonth()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="9,18 15,12 9,6"/>
                </svg>
            </button>
            <button class="nav-button" onclick="goToToday()">오늘</button>
        </div>
    </div>

    <!-- 캘린더 그리드 -->
    <div class="calendar-grid">
        <div class="calendar-weekdays">
            <div class="weekday">일</div>
            <div class="weekday">월</div>
            <div class="weekday">화</div>
            <div class="weekday">수</div>
            <div class="weekday">목</div>
            <div class="weekday">금</div>
            <div class="weekday">토</div>
        </div>
        <div class="calendar-days" id="calendarDays">
            <!-- 동적으로 생성됨 -->
        </div>
    </div>
</div>

<!-- 컨텍스트 메뉴 -->
<div id="contextMenu" class="context-menu">
    <div class="context-menu-item edit" onclick="editEvent()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
            <path d="m18.5 2.5 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
        </svg>
        편집
    </div>
    <div class="context-menu-item delete" onclick="deleteEvent()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="3,6 5,6 21,6"/>
            <path d="m19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"/>
            <line x1="10" y1="11" x2="10" y2="17"/>
            <line x1="14" y1="11" x2="14" y2="17"/>
        </svg>
        삭제
    </div>
</div>

<script>
    let currentDate = new Date();
    let currentYear = currentDate.getFullYear();
    let currentMonth = currentDate.getMonth();

    // 컨텍스트 메뉴 변수 (DOM 로드 후 초기화)
    let contextMenu = null;
    let selectedEvent = null;

    // 멀티데이 이벤트 데이터 구조
    const multiDayEvents = [
        { 
            id: 1, 
            title: 'Task2', 
            subtitle: '오후', 
            type: 'task', 
            completed: false, 
            status: 'D-1일',
            startDate: '2025-01-01',
            endDate: '2025-01-01'
        },
        { 
            id: 2, 
            title: 'Task3', 
            subtitle: '오후', 
            type: 'task', 
            completed: false,
            startDate: '2025-01-08',
            endDate: '2025-01-08'
        },
        { 
            id: 3, 
            title: 'Task 1', 
            subtitle: '개인', 
            type: 'task', 
            completed: true, 
            status: 'D-28일',
            startDate: '2025-01-14',
            endDate: '2025-01-14'
        },
        { 
            id: 4, 
            title: '자지', 
            subtitle: '중일 일정', 
            type: 'task', 
            completed: false,
            startDate: '2025-01-08',
            endDate: '2025-01-09'
        }
    ];

    // 기존 이벤트 형식으로 변환하는 함수
    function getEventsForDate(dateStr) {
        return multiDayEvents.filter(event => {
            const eventStart = new Date(event.startDate);
            const eventEnd = new Date(event.endDate);
            const checkDate = new Date(dateStr);
            return checkDate >= eventStart && checkDate <= eventEnd;
        });
    }

    function generateCalendar(year, month) {
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const startDate = new Date(firstDay);
        startDate.setDate(startDate.getDate() - firstDay.getDay());

        const calendarDays = document.getElementById('calendarDays');
        calendarDays.innerHTML = '';

        const monthYear = document.getElementById('monthYear');
        monthYear.textContent = `${year}년 ${month + 1}월`;

        const today = new Date();
        today.setHours(0, 0, 0, 0);

        for (let i = 0; i < 42; i++) {
            const date = new Date(startDate);
            date.setDate(startDate.getDate() + i);

            const dayElement = document.createElement('div');
            dayElement.className = 'calendar-day';
            
            const dayNumber = document.createElement('div');
            dayNumber.className = 'day-number';
            dayNumber.textContent = date.getDate();

            // 오늘 날짜 표시
            if (date.getTime() === today.getTime()) {
                dayNumber.classList.add('today');
            }

            // 다른 월 날짜 스타일
            if (date.getMonth() !== month) {
                dayNumber.classList.add('other-month');
            }

            dayElement.appendChild(dayNumber);

            // 이벤트 추가 (멀티데이 지원)
            const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
            const dayEvents = getEventsForDate(dateStr);
            
            dayEvents.forEach(event => {
                const eventStart = new Date(event.startDate);
                const eventEnd = new Date(event.endDate);
                const currentDate = new Date(dateStr);
                
                const eventElement = document.createElement('div');
                eventElement.className = `event ${event.type}${event.completed ? ' completed' : ''}`;
                eventElement.setAttribute('data-event-id', event.id);
                
                // 멀티데이 이벤트의 경우 연속된 바로 표시
                if (event.startDate !== event.endDate) {
                    eventElement.classList.add('multi-day-event');
                    
                    // 시작일, 중간일, 마지막일에 따른 스타일링
                    if (dateStr === event.startDate) {
                        eventElement.classList.add('event-start');
                    } else if (dateStr === event.endDate) {
                        eventElement.classList.add('event-end');
                    } else {
                        eventElement.classList.add('event-middle');
                    }
                    
                    // 이벤트가 며칠간 지속되는지 계산
                    const daysDiff = Math.ceil((eventEnd - eventStart) / (1000 * 60 * 60 * 24)) + 1;
                    eventElement.setAttribute('data-duration', daysDiff);
                }
                
                const eventTitle = document.createElement('div');
                eventTitle.className = 'event-title';
                eventTitle.textContent = event.title;
                eventElement.appendChild(eventTitle);

                if (event.subtitle) {
                    const eventSubtitle = document.createElement('div');
                    eventSubtitle.className = 'event-subtitle';
                    eventSubtitle.textContent = event.subtitle;
                    eventElement.appendChild(eventSubtitle);
                }

                if (event.status && !event.completed) {
                    const eventStatus = document.createElement('div');
                    eventStatus.className = 'event-subtitle';
                    eventStatus.textContent = event.status;
                    eventElement.appendChild(eventStatus);
                }

                if (event.completed) {
                    const doneElement = document.createElement('div');
                    doneElement.className = 'event-done';
                    doneElement.innerHTML = '✓ DONE';
                    eventElement.appendChild(doneElement);
                }

                // 기존 클릭 이벤트
                eventElement.addEventListener('click', () => openEvent(event));

                // 우클릭 컨텍스트 메뉴 이벤트
                eventElement.addEventListener('contextmenu', (e) => {
                    console.log('우클릭 이벤트 감지됨:', event.title); // 디버그용
                    e.preventDefault();
                    e.stopPropagation();
                    selectedEvent = event;
                    showContextMenu(e.pageX, e.pageY);
                });
                dayElement.appendChild(eventElement);
            });

            // Task Dump 추가 (특정 날짜에)
            if (dateStr === '2025-01-27') {
                const taskDump = document.createElement('div');
                taskDump.className = 'task-dump';
                taskDump.innerHTML = '▶ Task Dump';
                taskDump.addEventListener('click', () => openTaskDump());
                dayElement.appendChild(taskDump);
            }

            // 추가 버튼
            const addBtn = document.createElement('button');
            addBtn.className = 'add-event-btn';
            addBtn.innerHTML = '+';
            addBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                addEvent(dateStr);
            });
            dayElement.appendChild(addBtn);

            dayElement.addEventListener('click', () => selectDate(dateStr));
            calendarDays.appendChild(dayElement);
        }
    }

    function previousMonth() {
        currentMonth--;
        if (currentMonth < 0) {
            currentMonth = 11;
            currentYear--;
        }
        generateCalendar(currentYear, currentMonth);
    }

    function nextMonth() {
        currentMonth++;
        if (currentMonth > 11) {
            currentMonth = 0;
            currentYear++;
        }
        generateCalendar(currentYear, currentMonth);
    }

    function goToToday() {
        const today = new Date();
        currentYear = today.getFullYear();
        currentMonth = today.getMonth();
        generateCalendar(currentYear, currentMonth);
    }

    function selectDate(dateStr) {
        console.log('Selected date:', dateStr);
    }

    function addEvent(dateStr) {
        const title = prompt('이벤트 제목을 입력하세요:');
        if (title) {
            if (!events[dateStr]) {
                events[dateStr] = [];
            }
            events[dateStr].push({
                id: Date.now(),
                title: title,
                type: 'task',
                completed: false
            });
            generateCalendar(currentYear, currentMonth);
        }
    }

    function openEvent(event) {
        alert(`이벤트: ${event.title}\n상태: ${event.completed ? '완료' : '진행중'}`);
    }

    function openTaskDump() {
        window.location.href = '/task-dump';
    }

    // 컨텍스트 메뉴 관련 함수들
    function showContextMenu(x, y) {
        // DOM 로드 확인
        if (!contextMenu) {
            contextMenu = document.getElementById('contextMenu');
        }

        if (contextMenu) {
            console.log('컨텍스트 메뉴 표시:', x, y); // 디버그용
            contextMenu.style.left = x + 'px';
            contextMenu.style.top = y + 'px';
            contextMenu.style.display = 'block';
        } else {
            console.error('컨텍스트 메뉴 엘리먼트를 찾을 수 없습니다');
        }
    }

    function hideContextMenu() {
        if (contextMenu) {
            contextMenu.style.display = 'none';
        }
        selectedEvent = null;
    }

    // 편집 기능 - 기존 API 사용
    function editEvent() {
        if (!selectedEvent) return;
        hideContextMenu();

        // 기존 편집 로직 호출 (이미 있는 함수 사용)
        openEvent(selectedEvent);
    }

    // 삭제 기능 - 기존 API 사용
    function deleteEvent() {
        if (!selectedEvent) return;

        if (confirm(`"${selectedEvent.title}" 이벤트를 삭제하시겠습니까?`)) {
            // 기존 삭제 API 호출
            deleteCalendarEvent(selectedEvent.id);
        }
        hideContextMenu();
    }

    // 기존 삭제 API 함수 (이미 있는 로직 사용)
    function deleteCalendarEvent(eventId) {
        // Calendar ID는 현재 URL에서 가져오거나 전역 변수에서 가져옴
        const currentCalendarId = '{{ calendar_id }}' || 'default-calendar';

        fetch(`/api/calendar/${currentCalendarId}/events/${eventId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('이벤트가 삭제되었습니다:', data);
                // 로컬 배열에서도 제거
                const index = multiDayEvents.findIndex(event => event.id === eventId);
                if (index > -1) {
                    multiDayEvents.splice(index, 1);
                }
                generateCalendar(currentYear, currentMonth);
            } else {
                alert('삭제 중 오류가 발생했습니다: ' + (data.error || '알 수 없는 오류'));
            }
        })
        .catch(error => {
            console.error('삭제 API 호출 오류:', error);
            alert('삭제 중 오류가 발생했습니다.');
        });
    }

    // 전역 클릭 이벤트로 컨텍스트 메뉴 숨기기
    document.addEventListener('click', (e) => {
        if (contextMenu && !contextMenu.contains(e.target)) {
            hideContextMenu();
        }
    });

    // ESC 키로 컨텍스트 메뉴 숨기기
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            hideContextMenu();
        }
    });

    // 초기 캘린더 생성
    generateCalendar(currentYear, currentMonth);
</script>
{% endblock %}