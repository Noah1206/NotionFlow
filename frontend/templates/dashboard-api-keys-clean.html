{% extends "base_dashboard.html" %}

{% block title %}API Keys - NotionFlow{% endblock %}

{% block extra_css %}
<link rel="stylesheet"
    href="{{ url_for('static', filename='css/api-keys-redesign.css') }}?v={{ range(100000, 999999) | random }}">
{% endblock %}

{% block content %}
<!-- API í‚¤ ê´€ë¦¬ ë©”ì¸ ì»¨í…Œì´ë„ˆ -->
<div class="api-container">

    <!-- í—¤ë” ì„¹ì…˜ -->
    <div class="api-header-container">
        <div class="api-header">
            <div class="api-title-section">
                <h1 class="api-main-title">ğŸ”‘ API í‚¤ ê´€ë¦¬</h1>
                <p class="api-subtitle">í”Œë«í¼ê³¼ ì•ˆì „í•˜ê²Œ ì—°ê²°í•˜ê³  ìº˜ë¦°ë”ë¥¼ ë™ê¸°í™”í•˜ì„¸ìš”</p>
            </div>
        </div>

        <!-- ìƒíƒœ ìš”ì•½ ì¹´ë“œ -->
        <div class="api-status-cards">
            <div class="status-card active">
                <div class="status-icon">ğŸ”—</div>
                <div class="status-content">
                    <div class="status-number" id="connected-count">{{ stats.connected_count if stats else 0 }}</div>
                    <div class="status-label">ì—°ê²°ëœ í”Œë«í¼</div>
                </div>
            </div>
            <div class="status-card">
                <div class="status-icon">ğŸ“…</div>
                <div class="status-content">
                    <div class="status-number" id="sync-count">{{ stats.synced_events if stats else 0 }}</div>
                    <div class="status-label">ë™ê¸°í™”ëœ ì´ë²¤íŠ¸</div>
                </div>
            </div>
            <div class="status-card">
                <div class="status-icon">âœ…</div>
                <div class="status-content">
                    <div class="status-number success" id="success-rate">{{ stats.success_rate if stats else "0%" }}
                    </div>
                    <div class="status-label">ì„±ê³µë¥ </div>
                </div>
            </div>
            <div class="status-card">
                <div class="status-icon">âš¡</div>
                <div class="status-content">
                    <div class="status-number" id="sync-speed">{{ stats.avg_sync_time if stats else 'N/A' }}</div>
                    <div class="status-label">í‰ê·  ë™ê¸°í™” ì‹œê°„</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ìº˜ë¦°ë” ì„¤ì • ê°€ì´ë“œ -->
    {% if not stats or stats.connected_count == 0 %}
    <div class="calendar-setup-guide" id="calendar-setup-guide">
        <div class="guide-content">
            <div class="guide-icon">ğŸ¯</div>
            <h3>ì‹œì‘í•˜ê¸°</h3>
            <p>ë¨¼ì € í”Œë«í¼ì„ ì—°ê²°í•˜ì—¬ ìº˜ë¦°ë” ë™ê¸°í™”ë¥¼ ì„¤ì •í•´ë³´ì„¸ìš”.</p>
            <button class="guide-close-btn" onclick="hideCalendarGuide()">Ã—</button>
        </div>
    </div>
    {% endif %}

    <!-- í”Œë«í¼ ì¹´ë“œ ê·¸ë¦¬ë“œ -->
    <div class="platforms-grid">

        <!-- Notion ì¹´ë“œ -->
        <div class="platform-card" data-platform="notion">
            <div class="platform-header">
                <div class="platform-icon">
                    <img src="{{ url_for('static', filename='images/notion-icon.png') }}" alt="Notion"
                        onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                    <div class="platform-icon-fallback" style="display: none;">
                        <span class="icon-text">N</span>
                    </div>
                </div>
                <div class="platform-info">
                    <h3 class="platform-name">Notion</h3>
                    <div class="platform-status disconnected">
                        <span class="status-dot"></span>ì—°ê²°ë˜ì§€ ì•ŠìŒ
                    </div>
                </div>
                <div class="platform-actions">
                    <button class="one-click-btn-small" onclick="oneClickConnect('notion')">
                        <span class="btn-text">ì›í´ë¦­</span>
                        <div class="btn-loader" style="display: none;">
                            <div class="loader-spinner"></div>
                        </div>
                    </button>
                </div>
            </div>

            <div class="platform-body">
                <p class="platform-description">Notion ë°ì´í„°ë² ì´ìŠ¤ì™€ ìº˜ë¦°ë”ë¥¼ ë™ê¸°í™”í•˜ì„¸ìš”</p>

                <div class="platform-features">
                    <div class="feature-item">
                        <span class="feature-icon">ğŸ“</span>
                        <span>í˜ì´ì§€ ìƒì„±</span>
                    </div>
                    <div class="feature-item">
                        <span class="feature-icon">ğŸ“Š</span>
                        <span>ë°ì´í„°ë² ì´ìŠ¤ ì—°ë™</span>
                    </div>
                </div>

                <div class="platform-buttons">
                    <button class="platform-connect-btn" onclick="connectPlatform('notion')">
                        <span class="connect-text">ì—°ê²°í•˜ê¸°</span>
                        <div class="connect-loader" style="display: none;">
                            <div class="loader-spinner"></div>
                        </div>
                    </button>
                    <button class="platform-sync-btn" style="display: none;">
                        <span class="sync-text">ìº˜ë¦°ë” ì—°ë™</span>
                        <span class="sync-status"></span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Google Calendar ì¹´ë“œ -->
        <div class="platform-card" data-platform="google">
            <div class="platform-header">
                <div class="platform-icon">
                    <img src="{{ url_for('static', filename='images/google-calendar-icon.png') }}" alt="Google Calendar"
                        onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                    <div class="platform-icon-fallback" style="display: none;">
                        <span class="icon-text">ğŸ“…</span>
                    </div>
                </div>
                <div class="platform-info">
                    <h3 class="platform-name">Google Calendar</h3>
                    <div class="platform-status disconnected">
                        <span class="status-dot"></span>ì—°ê²°ë˜ì§€ ì•ŠìŒ
                    </div>
                </div>
                <div class="platform-actions">
                    <button class="one-click-btn-small" onclick="oneClickConnect('google')">
                        <span class="btn-text">ì›í´ë¦­</span>
                        <div class="btn-loader" style="display: none;">
                            <div class="loader-spinner"></div>
                        </div>
                    </button>
                </div>
            </div>

            <div class="platform-body">
                <p class="platform-description">Google Calendarì™€ ì‹¤ì‹œê°„ ë™ê¸°í™”ë¥¼ ì„¤ì •í•˜ì„¸ìš”</p>

                <div class="platform-features">
                    <div class="feature-item">
                        <span class="feature-icon">ğŸ“…</span>
                        <span>ì¼ì • ë™ê¸°í™”</span>
                    </div>
                    <div class="feature-item">
                        <span class="feature-icon">ğŸ””</span>
                        <span>ì•Œë¦¼ ì—°ë™</span>
                    </div>
                </div>

                <div class="platform-buttons">
                    <button class="platform-connect-btn" onclick="connectPlatform('google')">
                        <span class="connect-text">ì—°ê²°í•˜ê¸°</span>
                        <div class="connect-loader" style="display: none;">
                            <div class="loader-spinner"></div>
                        </div>
                    </button>
                    <button class="platform-sync-btn" style="display: none;">
                        <span class="sync-text">ìº˜ë¦°ë” ì—°ë™</span>
                        <span class="sync-status"></span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Apple Calendar ì¹´ë“œ -->
        <div class="platform-card" data-platform="apple">
            <div class="platform-header">
                <div class="platform-icon">
                    <div class="platform-icon-fallback">
                        <span class="icon-text">ğŸ</span>
                    </div>
                </div>
                <div class="platform-info">
                    <h3 class="platform-name">Apple Calendar</h3>
                    <div class="platform-status disconnected">
                        <span class="status-dot"></span>ì—°ê²°ë˜ì§€ ì•ŠìŒ
                    </div>
                </div>
                <div class="platform-actions">
                    <button class="one-click-btn-small" onclick="oneClickConnect('apple')">
                        <span class="btn-text">ì›í´ë¦­</span>
                        <div class="btn-loader" style="display: none;">
                            <div class="loader-spinner"></div>
                        </div>
                    </button>
                </div>
            </div>

            <div class="platform-body">
                <p class="platform-description">Apple Calendarì™€ ìº˜ë¦°ë”ë¥¼ ë™ê¸°í™”í•˜ì„¸ìš”</p>

                <div class="platform-features">
                    <div class="feature-item">
                        <span class="feature-icon">ğŸ“±</span>
                        <span>ëª¨ë°”ì¼ ë™ê¸°í™”</span>
                    </div>
                    <div class="feature-item">
                        <span class="feature-icon">ğŸ”„</span>
                        <span>ì‹¤ì‹œê°„ ì—°ë™</span>
                    </div>
                </div>

                <div class="platform-buttons">
                    <button class="platform-connect-btn" onclick="connectPlatform('apple')">
                        <span class="connect-text">ì—°ê²°í•˜ê¸°</span>
                        <div class="connect-loader" style="display: none;">
                            <div class="loader-spinner"></div>
                        </div>
                    </button>
                    <button class="platform-sync-btn" style="display: none;">
                        <span class="sync-text">ìº˜ë¦°ë” ì—°ë™</span>
                        <span class="sync-status"></span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Microsoft Outlook ì¹´ë“œ -->
        <div class="platform-card" data-platform="outlook">
            <div class="platform-header">
                <div class="platform-icon">
                    <div class="platform-icon-fallback">
                        <span class="icon-text">ğŸ“§</span>
                    </div>
                </div>
                <div class="platform-info">
                    <h3 class="platform-name">Microsoft Outlook</h3>
                    <div class="platform-status disconnected">
                        <span class="status-dot"></span>ì—°ê²°ë˜ì§€ ì•ŠìŒ
                    </div>
                </div>
                <div class="platform-actions">
                    <button class="one-click-btn-small" onclick="oneClickConnect('outlook')">
                        <span class="btn-text">ì›í´ë¦­</span>
                        <div class="btn-loader" style="display: none;">
                            <div class="loader-spinner"></div>
                        </div>
                    </button>
                </div>
            </div>

            <div class="platform-body">
                <p class="platform-description">Outlook ìº˜ë¦°ë”ì™€ ë©”ì¼ì„ ë™ê¸°í™”í•˜ì„¸ìš”</p>

                <div class="platform-features">
                    <div class="feature-item">
                        <span class="feature-icon">ğŸ“¨</span>
                        <span>ë©”ì¼ ì—°ë™</span>
                    </div>
                    <div class="feature-item">
                        <span class="feature-icon">ğŸ—“ï¸</span>
                        <span>ì¼ì • ê´€ë¦¬</span>
                    </div>
                </div>

                <div class="platform-buttons">
                    <button class="platform-connect-btn" onclick="connectPlatform('outlook')">
                        <span class="connect-text">ì—°ê²°í•˜ê¸°</span>
                        <div class="connect-loader" style="display: none;">
                            <div class="loader-spinner"></div>
                        </div>
                    </button>
                    <button class="platform-sync-btn" style="display: none;">
                        <span class="sync-text">ìº˜ë¦°ë” ì—°ë™</span>
                        <span class="sync-status"></span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Slack ì¹´ë“œ -->
        <div class="platform-card" data-platform="slack">
            <div class="platform-header">
                <div class="platform-icon">
                    <div class="platform-icon-fallback">
                        <span class="icon-text">ğŸ’¬</span>
                    </div>
                </div>
                <div class="platform-info">
                    <h3 class="platform-name">Slack</h3>
                    <div class="platform-status disconnected">
                        <span class="status-dot"></span>ì—°ê²°ë˜ì§€ ì•ŠìŒ
                    </div>
                </div>
                <div class="platform-actions">
                    <button class="one-click-btn-small" onclick="oneClickConnect('slack')">
                        <span class="btn-text">ì›í´ë¦­</span>
                        <div class="btn-loader" style="display: none;">
                            <div class="loader-spinner"></div>
                        </div>
                    </button>
                </div>
            </div>

            <div class="platform-body">
                <p class="platform-description">Slackê³¼ ì—…ë¬´ ìŠ¤ì¼€ì¤„ì„ ë™ê¸°í™”í•˜ì„¸ìš”</p>

                <div class="platform-features">
                    <div class="feature-item">
                        <span class="feature-icon">ğŸ’¬</span>
                        <span>ë©”ì‹œì§€ ì—°ë™</span>
                    </div>
                    <div class="feature-item">
                        <span class="feature-icon">ğŸ“‹</span>
                        <span>ì‘ì—… ê´€ë¦¬</span>
                    </div>
                </div>

                <div class="platform-buttons">
                    <button class="platform-connect-btn" onclick="connectPlatform('slack')">
                        <span class="connect-text">ì—°ê²°í•˜ê¸°</span>
                        <div class="connect-loader" style="display: none;">
                            <div class="loader-spinner"></div>
                        </div>
                    </button>
                    <button class="platform-sync-btn" style="display: none;">
                        <span class="sync-text">ìº˜ë¦°ë” ì—°ë™</span>
                        <span class="sync-status"></span>
                    </button>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- ìº˜ë¦°ë” ì„ íƒ ëª¨ë‹¬ -->
<div id="calendar-selection-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2>ìº˜ë¦°ë” ì„ íƒ</h2>
            <button class="modal-close" onclick="closeCalendarSelectionModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <p>ë™ê¸°í™”í•  ìº˜ë¦°ë”ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”:</p>
            <div id="calendar-list-container" class="calendar-list">
                <!-- Dynamic calendar list will be loaded here -->
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="closeCalendarSelectionModal()">ì·¨ì†Œ</button>
            <button class="btn-primary" id="confirm-calendar-selection" onclick="confirmCalendarSelection()" disabled>
                ì„ íƒí•œ ìº˜ë¦°ë”ë¡œ ì—°ê²°
            </button>
        </div>
    </div>
</div>

<script>
    // Global variables
    let selectedCalendarId = null;
    let currentConnectingPlatform = null;

    // Utility functions that are still needed
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.textContent = message;
        
        // Add to page
        document.body.appendChild(notification);
        
        // Auto remove after 3 seconds
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 3000);
    }

    function getKoreanPlatformName(platform) {
        const names = {
            'notion': 'Notion',
            'google': 'Google Calendar',
            'apple': 'Apple Calendar',
            'outlook': 'Microsoft Outlook',
            'slack': 'Slack'
        };
        return names[platform] || platform;
    }

    // Calendar selection modal functions
    function showCalendarSelectionModal(platform) {
        currentConnectingPlatform = platform;
        const modal = document.getElementById('calendar-selection-modal');
        const calendarListContainer = document.getElementById('calendar-list-container');
        
        modal.style.display = 'flex';
        calendarListContainer.innerHTML = '<div class="loading">ìº˜ë¦°ë” ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
        
        // Load calendar list
        loadUserCalendars(calendarListContainer);
    }

    function closeCalendarSelectionModal() {
        const modal = document.getElementById('calendar-selection-modal');
        modal.style.display = 'none';
        selectedCalendarId = null;
        currentConnectingPlatform = null;
        
        // Reset confirm button
        document.getElementById('confirm-calendar-selection').disabled = true;
    }

    async function loadUserCalendars(calendarListContainer) {
        try {
            // Load Google calendars
            const googleResponse = await fetch('/api/google-calendars');
            if (!googleResponse.ok) {
                throw new Error('Google Calendar ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
            }
            
            const googleData = await googleResponse.json();
            if (googleData.success && googleData.calendars && googleData.calendars.length > 0) {
                calendarListContainer.innerHTML = '';
                
                googleData.calendars.forEach(calendar => {
                    calendar.source = 'google';
                    const calendarItem = createCalendarItem(calendar);
                    calendarListContainer.appendChild(calendarItem);
                });
            } else {
                displayNoCalendarsMessage(calendarListContainer);
            }
            
        } catch (error) {
            console.error('ìº˜ë¦°ë” ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
            calendarListContainer.innerHTML = `<div class="error">ìº˜ë¦°ë” ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}</div>`;
        }
    }

    function displayNoCalendarsMessage(container) {
        container.innerHTML = 
            '<div class="no-calendars-message">' +
                '<div class="no-calendars-icon">' +
                    '<svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">' +
                        '<path d="M8 2v4M16 2v4M3 10h18M5 4h14a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2z"/>' +
                    '</svg>' +
                '</div>' +
                '<h4>ìº˜ë¦°ë”ê°€ ì—†ìŠµë‹ˆë‹¤</h4>' +
                '<p>ë¨¼ì € ìº˜ë¦°ë”ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.</p>' +
            '</div>';
    }

    function createCalendarItem(calendar) {
        const item = document.createElement('div');
        item.className = 'calendar-item';
        item.setAttribute('data-calendar-id', calendar.id);
        item.onclick = () => selectCalendar(calendar.id);
        
        const sourceIcon = calendar.source === 'google' ? 'ğŸ“…' : 'ğŸ“';
        const sourceText = calendar.source === 'google' ? 'Google' : 'Notion';
        
        item.innerHTML = 
            '<div class="calendar-radio"></div>' +
            '<div class="calendar-info">' +
                '<div class="calendar-name">' + sourceIcon + ' ' + (calendar.name || '') + '</div>' +
                '<div class="calendar-description">' + (calendar.description || '') + '</div>' +
                '<div class="calendar-source">' + sourceText + '</div>' +
            '</div>' +
            '<div class="calendar-type ' + (calendar.type || 'personal') + '">' + getCalendarTypeText(calendar.type, calendar.source) + '</div>';
        
        return item;
    }

    function getCalendarTypeText(type, source) {
        if (source === 'google') {
            switch (type) {
                case 'primary': return 'ê¸°ë³¸';
                case 'google': return 'êµ¬ê¸€';
                default: return 'êµ¬ê¸€';
            }
        } else {
            switch (type) {
                case 'primary': return 'ê¸°ë³¸';
                case 'shared': return 'ê³µìœ ';
                case 'personal': return 'ê°œì¸';
                case 'notion': return 'Notion';
                default: return 'ê°œì¸';
            }
        }
    }

    function selectCalendar(calendarId) {
        // Remove previous selection
        document.querySelectorAll('.calendar-item').forEach(item => {
            item.classList.remove('selected');
        });
        
        // Add new selection
        const selectedItem = document.querySelector('[data-calendar-id="' + calendarId + '"]');
        if (selectedItem) {
            selectedItem.classList.add('selected');
            selectedCalendarId = calendarId;
            
            // Enable confirm button
            document.getElementById('confirm-calendar-selection').disabled = false;
        }
    }

    async function confirmCalendarSelection() {
        if (!selectedCalendarId || !currentConnectingPlatform) {
            showNotification('ìº˜ë¦°ë”ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
            return;
        }

        // Close modal
        closeCalendarSelectionModal();

        // Connect selected calendar with platform
        try {
            // Use platform manager to handle connection
            const manager = PlatformManagerFactory.get(currentConnectingPlatform);
            if (manager && manager.connectCalendar) {
                await manager.connectCalendar(selectedCalendarId);
            } else {
                // Fallback to direct API call
                await fetch(`/api/platform/${currentConnectingPlatform}/connect`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ calendar_id: selectedCalendarId })
                });
                
                showNotification(`${getKoreanPlatformName(currentConnectingPlatform)} ì—°ê²° ì™„ë£Œ!`, 'success');
            }
            
        } catch (error) {
            console.error('ìº˜ë¦°ë” ì—°ê²° ì¤‘ ì˜¤ë¥˜:', error);
            showNotification('ìº˜ë¦°ë” ì—°ê²° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    function hideCalendarGuide() {
        const guide = document.getElementById('calendar-setup-guide');
        if (guide) {
            guide.style.display = 'none';
            localStorage.setItem('calendar_guide_hidden', 'true');
        }
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Clean API Keys page loaded');
        
        // Hide guide if already hidden
        const guide = document.getElementById('calendar-setup-guide');
        if (guide && localStorage.getItem('calendar_guide_hidden') === 'true') {
            guide.style.display = 'none';
        }
    });
</script>

<!-- New Platform Managers -->
<script src="{{ url_for('static', filename='js/platform-managers.js') }}?v={{ range(100000, 999999) | random }}"></script>

{% endblock %}